<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hdc.rjxy.mapper.TeamRankingMapper">

    <select id="listRanking" resultType="hdc.rjxy.pojo.vo.TeamRankingVO">
        SELECT
        u.id AS userId,
        u.nickname,
        u.student_no AS studentNo,
        pa.identifier_value AS handle,
        COALESCE(rs.rating, 0) AS rating,
        rs.snapshot_time AS snapshotTime
        FROM user u
        LEFT JOIN user_platform_account pa ON u.id = pa.user_id
        AND pa.platform_id = #{platformId}

        LEFT JOIN rating_snapshot rs ON u.id = rs.user_id
        AND rs.platform_id = #{platformId}
        AND rs.snapshot_time = (
        SELECT MAX(snapshot_time)
        FROM rating_snapshot
        WHERE user_id = u.id AND platform_id = #{platformId}
        )
        WHERE u.status = 1
        AND pa.identifier_value IS NOT NULL
        ORDER BY rating DESC, snapshotTime DESC
    </select>

</mapper>