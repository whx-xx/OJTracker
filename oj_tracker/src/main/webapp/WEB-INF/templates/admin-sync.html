<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: common-head('同步任务管理 - OJ Tracker')}"></head>
<body style="background: #f0f2f5; display: block; height: auto;">

<div th:replace="~{fragments/navbar :: common-nav}"></div>

<div class="container main-container">
    <div class="row mb-4" id="syncOverview">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3 text-center">
                <div class="text-muted small">最近积分同步 (Rating)</div>
                <div class="h5 fw-bold mt-2" id="latestRatingTime">从未执行</div>
                <span id="latestRatingStatus" class="badge rounded-pill mx-auto mt-1">N/A</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3 text-center">
                <div class="text-muted small">最近解题同步 (Daily)</div>
                <div class="h5 fw-bold mt-2" id="latestDailyTime">从未执行</div>
                <span id="latestDailyStatus" class="badge rounded-pill mx-auto mt-1">N/A</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3 d-flex flex-column justify-content-center align-items-center">
                <div class="form-check form-switch scale-150">
                    <input class="form-check-input" type="checkbox" id="scheduleSwitch" onchange="toggleSchedule(this.checked)">
                    <label class="form-check-label small text-muted ms-2" for="scheduleSwitch">自动调度开关</label>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3 align-items-center">
        <div class="col">
            <h5 class="fw-bold mb-0">同步作业流水</h5>
        </div>
        <div class="col-auto">
            <div class="btn-group shadow-sm">
                <button class="btn btn-primary" onclick="triggerSync('RATING_SYNC')">立即同步rating</button>
                <button class="btn btn-outline-primary" onclick="triggerSync('DAILY_SYNC')">同步每日解题</button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light text-muted small">
                    <tr>
                        <th class="ps-4 py-3">ID</th>
                        <th>作业类型</th>
                        <th>状态</th>
                        <th>开始时间</th>
                        <th>成功/总数</th>
                        <th>耗时(ms)</th>
                        <th class="text-end pe-4">操作</th>
                    </tr>
                    </thead>
                    <tbody id="jobTableBody">
                    <tr><td colspan="7" class="text-center py-5 text-muted">正在检索作业记录...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div class="text-muted small">共 <span id="totalJobs">0</span> 条作业记录</div>
            <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h6 class="modal-title fw-bold">作业失败清单 <span id="currentJobId" class="text-muted small ms-2"></span></h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light extra-small">
                    <tr>
                        <th class="ps-3">用户信息</th>
                        <th>平台</th>
                        <th>错误代码</th>
                        <th>详细描述</th>
                        <th class="text-end pe-3">建议</th>
                    </tr>
                    </thead>
                    <tbody id="failListBody"></tbody>
                </table>
            </div>
            <div class="modal-footer bg-light py-2">
                <button class="btn btn-sm btn-warning" id="rerunBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i>重跑本任务失败项
                </button>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/static/js/admin-sync.js}"></script>
</body>
</html>