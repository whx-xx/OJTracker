<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作日志</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        dark: '#34495e',
                        bg: '#f1f5f9',
                    }
                }
            }
        }
    </script>

    <style>
        /* 隐藏默认滚动条但保留滚动功能 (可选，为了美观) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 自定义滚动条样式 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<!-- 布局核心：h-screen flex flex-col overflow-hidden 确保整页不滚动，只让内部滚动 -->
<body class="bg-bg text-slate-700 h-screen w-screen p-4 md:p-6 flex flex-col overflow-hidden font-poppins">

<!-- 顶部工具栏 (flex-shrink-0 防止被压缩) -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 shrink-0">
    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto flex-1">

        <!-- 操作类型筛选 -->
        <div class="relative w-full sm:w-64">
            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                <i class="fas fa-chevron-down text-xs"></i>
            </div>
            <select id="typeSelect" onchange="handleSearch()"
                    class="w-full appearance-none bg-white border border-slate-200 text-slate-700 py-2.5 pl-4 pr-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm text-sm cursor-pointer hover:border-slate-300">
                <option value="">全部操作类型</option>
                <option value="强制修改昵称">强制修改昵称</option>
                <option value="切换定时任务状态">切换定时任务状态</option>
                <option value="手动触发同步任务">手动触发同步任务</option>
                <option value="更新用户状态">更新用户状态</option>
                <option value="重置用户密码">重置用户密码</option>
            </select>
        </div>

        <!-- 目标对象搜索 -->
        <div class="relative w-full sm:w-80">
            <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none text-slate-400">
                <i class="fas fa-search"></i>
            </div>
            <input type="text" id="searchInput" onkeyup="handleSearchDebounced()"
                   placeholder="搜索目标对象..."
                   class="w-full bg-white border border-slate-200 text-slate-700 py-2.5 pl-10 pr-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm text-sm placeholder-slate-400">
        </div>
    </div>

    <!-- 右侧刷新按钮 (可选) -->
    <button onclick="loadLogs(1)" class="p-2.5 bg-white border border-slate-200 text-slate-500 rounded-xl hover:text-primary hover:border-primary transition-colors shadow-sm active:scale-95" title="刷新列表">
        <i class="fas fa-redo-alt"></i>
    </button>
</div>

<!-- 卡片容器 -->
<!-- 核心修改：flex-1 min-h-0 允许容器占据剩余空间并可收缩，防止溢出屏幕 -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col flex-1 min-h-0 overflow-hidden">

    <!-- 表格滚动区域：flex-1 overflow-auto relative 确保只有表格区域滚动 -->
    <div class="flex-1 overflow-auto relative w-full">
        <table class="w-full text-left border-collapse">
            <!-- 粘性表头：sticky top-0 -->
            <thead class="bg-slate-50/95 border-b border-slate-200 sticky top-0 z-10 backdrop-blur-sm">
            <tr>
                <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap w-40">操作人</th>
                <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap w-48">动作类型</th>
                <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap w-48">目标对象</th>
                <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap min-w-[200px]">详细备注</th>
                <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap w-48 text-right">时间</th>
            </tr>
            </thead>
            <tbody id="logTableBody" class="divide-y divide-slate-100 bg-white">
            <!-- 加载状态 -->
            <tr>
                <td colspan="5" class="px-6 py-20 text-center text-slate-400">
                    <div class="flex flex-col items-center gap-2 animate-pulse">
                        <i class="fas fa-circle-notch fa-spin text-xl text-primary/40"></i>
                        <span class="text-xs">加载数据中...</span>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 分页组件：shrink-0 确保始终固定在底部，不被挤压 -->
    <div id="paginationContainer" class="hidden flex-col sm:flex-row justify-between items-center px-6 py-3 bg-white border-t border-slate-100 gap-4 shrink-0 z-20">
        <div class="text-xs text-slate-400 font-medium" id="pageInfo"></div>
        <div id="pagination" class="flex items-center gap-1.5"></div>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 8; // 稍微增加每页显示数量，因为现在是全屏滚动
    let searchTimeout;

    // 初始化加载
    document.addEventListener('DOMContentLoaded', () => loadLogs(1));

    // 加载数据
    function loadLogs(page) {
        currentPage = page;
        const tbody = document.getElementById('logTableBody');

        const opType = document.getElementById('typeSelect').value;
        const target = document.getElementById('searchInput').value.trim();

        axios.get('/api/admin/logs', {
            params: {
                page: page,
                size: pageSize,
                opType: opType,
                keyword: target
            }
        }).then(res => {
            if(res.data.code === 200) {
                const data = res.data.data;
                renderTable(data.records);
                renderPagination(data.total, data.pages, data.current);
                document.getElementById('paginationContainer').classList.remove('hidden');
                document.getElementById('paginationContainer').classList.add('flex');
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">加载失败: ${res.data.msg}</td></tr>`;
            }
        }).catch(err => {
            // Mock Data for UI Testing (Remove in production)
            console.warn("API Failed, using Mock Data");
            const mockData = generateMockData(page, pageSize);
            renderTable(mockData);
            renderPagination(128, 7, page); // Mock total 128
            document.getElementById('paginationContainer').classList.remove('hidden');
            document.getElementById('paginationContainer').classList.add('flex');
        });
    }

    // 渲染表格
    function renderTable(list) {
        const tbody = document.getElementById('logTableBody');
        tbody.innerHTML = '';

        if(!list || list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-20 text-center text-slate-400 flex flex-col items-center gap-2"><i class="fas fa-inbox text-2xl opacity-30"></i><span>未找到相关日志</span></td></tr>`;
            return;
        }

        list.forEach(log => {
            // 目标对象样式
            const targetHtml = log.targetUserName
                ? `<span class="font-mono text-xs text-orange-600 bg-orange-50 px-2 py-0.5 rounded border border-orange-100 flex items-center gap-1 w-fit"><i class="fas fa-user text-[10px] opacity-50"></i> ${log.targetUserName}</span>`
                : `<span class="font-mono text-xs text-sky-600 bg-sky-50 px-2 py-0.5 rounded border border-sky-100 flex items-center gap-1 w-fit"><i class="fas fa-globe text-[10px] opacity-50"></i> 全局 (Global)</span>`;

            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors group";
            tr.innerHTML = `
                    <td class="px-6 py-3.5 whitespace-nowrap">
                        <div class="flex items-center text-sm font-medium text-slate-700">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center mr-3 text-primary text-xs border border-slate-200">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            ${log.adminName}
                        </div>
                    </td>
                    <td class="px-6 py-3.5 whitespace-nowrap">
                        <span class="px-2.5 py-1 text-xs font-semibold rounded bg-slate-100 text-slate-600 inline-block border border-slate-200">
                            ${log.opType}
                        </span>
                    </td>
                    <td class="px-6 py-3.5 whitespace-nowrap">
                        ${targetHtml}
                    </td>
                    <td class="px-6 py-3.5 text-sm text-slate-600 max-w-xs truncate" title="${log.remark || ''}">
                        ${log.remark || '-'}
                    </td>
                    <td class="px-6 py-3.5 whitespace-nowrap text-right">
                        <span class="font-mono text-xs text-slate-400">${formatTime(log.opTime)}</span>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    // 渲染分页
    function renderPagination(total, totalPages, current) {
        const info = document.getElementById('pageInfo');
        const container = document.getElementById('pagination');

        const startRecord = (current - 1) * pageSize + 1;
        const endRecord = Math.min(current * pageSize, total);

        info.textContent = `显示 ${startRecord}-${endRecord} / 共 ${total}`;

        let html = '';
        // 按钮基础样式
        const btnBase = "w-8 h-8 flex items-center justify-center rounded-lg transition-all duration-200 text-xs font-medium border ml-1";
        const activeClass = "bg-primary text-white border-primary shadow-sm shadow-indigo-100";
        const normalClass = "bg-white text-slate-500 border-slate-200 hover:border-primary hover:text-primary hover:bg-primary/5";
        const disabledClass = "bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed";

        // 上一页
        html += `<button class="${btnBase} ${current === 1 ? disabledClass : normalClass}" ${current === 1 ? 'disabled' : ''} onclick="loadLogs(${current - 1})">
                        <i class="fas fa-chevron-left text-[10px]"></i>
                     </button>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) html += pageBtn(i, current, btnBase, activeClass, normalClass);
        } else {
            html += pageBtn(1, current, btnBase, activeClass, normalClass);
            if (current > 3) html += `<span class="w-8 h-8 flex items-center justify-center text-slate-300 text-[10px]">...</span>`;

            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) html += pageBtn(i, current, btnBase, activeClass, normalClass);

            if (current < totalPages - 2) html += `<span class="w-8 h-8 flex items-center justify-center text-slate-300 text-[10px]">...</span>`;
            html += pageBtn(totalPages, current, btnBase, activeClass, normalClass);
        }

        // 下一页
        html += `<button class="${btnBase} ${current === totalPages ? disabledClass : normalClass}" ${current === totalPages ? 'disabled' : ''} onclick="loadLogs(${current + 1})">
                        <i class="fas fa-chevron-right text-[10px]"></i>
                     </button>`;

        container.innerHTML = html;
    }

    function pageBtn(i, current, base, active, normal) {
        return `<button class="${base} ${i === current ? active : normal}" onclick="loadLogs(${i})">${i}</button>`;
    }

    function handleSearch() { loadLogs(1); }

    function handleSearchDebounced() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { loadLogs(1); }, 500);
    }

    function formatTime(iso) {
        if(!iso) return '-';
        const d = new Date(iso);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function generateMockData(page, size) {
        const actions = ["强制修改昵称", "切换定时任务状态", "手动触发同步任务", "更新用户状态", "重置用户密码"];
        const data = [];
        for(let i=0; i<size; i++) {
            const isGlobal = Math.random() > 0.7;
            data.push({
                adminName: `Admin_${Math.floor(Math.random()*100)}`,
                opType: actions[Math.floor(Math.random() * actions.length)],
                targetUserName: isGlobal ? null : `User_${Math.floor(Math.random()*1000)}`,
                remark: isGlobal ? "System wide configuration change" : "Requested by user via support ticket",
                opTime: new Date().toISOString()
            });
        }
        return data;
    }
</script>
</body>
</html>