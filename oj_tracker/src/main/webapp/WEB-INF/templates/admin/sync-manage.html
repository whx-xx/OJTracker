<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Schedule</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script th:src="@{/static/js/jquery.min.js}"></script>

    <style>
        /* 保持原有样式 */
        :root { --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #0f172a; --text-light: #64748b; --primary: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --border: #e2e8f0; --radius: 12px; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: transparent; color: var(--text-main); margin: 0; padding: 20px 40px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .icon-blue { background: #eff6ff; color: var(--primary); }
        .icon-purple { background: #f3e8ff; color: #9333ea; }
        .icon-orange { background: #fff7ed; color: var(--warning); }
        .switch-container { display: flex; align-items: center; gap: 12px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
        .status-text { font-size: 14px; font-weight: 600; color: var(--text-light); }
        .status-text.active { color: var(--success); }
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: var(--text-light); }
        .stat-val { font-weight: 600; color: var(--text-main); }
        .progress-bg { height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; display: flex; margin-top: 12px; }
        .progress-bar { height: 100%; }
        .bg-success { background: var(--success); }
        .bg-danger { background: var(--danger); }
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; justify-content: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: #cbd5e1; background: #f8fafc; }
        .btn-rerun { background: #fee2e2; color: #b91c1c; border-color: #fecaca; padding: 4px 10px; font-size: 12px; }
        .btn-rerun:hover { background: #fecaca; }
        .table-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .toolbar { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px 24px; background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 14px 24px; color: #334155; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        .status-pill { padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .st-success { background: #dcfce7; color: #166534; }
        .st-fail { background: #fee2e2; color: #991b1b; }
        .st-running { background: #dbeafe; color: #1e40af; }
        .pagination-footer { display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; border-top: 1px solid var(--border); background: #fcfcfd; }
        .page-desc { font-size: 13px; color: #64748b; }
        .pg-container { display: flex; gap: 4px; background: #fff; padding: 2px; border-radius: 6px; border: 1px solid var(--border); }
        .pg-btn { min-width: 28px; height: 28px; padding: 0 8px; border-radius: 4px; border: none; background: transparent; color: #475569; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; }
        .pg-btn:hover:not(:disabled) { background: #f1f5f9; color: #0f172a; }
        .pg-btn.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .pg-btn:disabled { color: #cbd5e1; cursor: default; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(2px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-container { background: white; width: 600px; max-width: 90%; border-radius: var(--radius); box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s ease; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-overlay.show .modal-container { transform: scale(1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--text-main); }
        .modal-close { background: none; border: none; font-size: 20px; color: #94a3b8; cursor: pointer; }
        .modal-close:hover { color: var(--text-main); }
        .modal-body { padding: 24px; overflow-y: auto; }
        .alert-box { background: #fff7ed; border: 1px solid #fed7aa; color: #c2410c; padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); background: #f8fafc; border-radius: 0 0 var(--radius) var(--radius); display: flex; justify-content: flex-end; gap: 12px; }
        .fail-table { width: 100%; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .fail-table th { background: #f1f5f9; padding: 10px 16px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .fail-table td { padding: 10px 16px; font-size: 13px; border-bottom: 1px solid #f1f5f9; }
        .code-badge { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #475569; font-size: 12px; }
        #toast { position: fixed; top: 20px; right: 20px; z-index: 2000; padding: 10px 20px; border-radius: 8px; color: #fff; font-weight: 500; display: none; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="dashboard-grid">
    <div class="card" style="justify-content: space-between;">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon icon-orange"><i class="fas fa-clock"></i></div>
                自动调度服务
            </div>
        </div>
        <div style="flex:1; display:flex; align-items:center;">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="scheduleToggle" onchange="toggleSchedule()">
                    <span class="slider"></span>
                </label>
                <span class="status-text" id="scheduleText">已停止</span>
            </div>
        </div>
        <div style="font-size:12px; color:#94a3b8; margin-top:12px; line-height: 1.6; border-top: 1px solid #f1f5f9; padding-top: 10px;">
            <div style="margin-bottom:4px; font-weight:500; color:#64748b;">定时策略 (Shanghai):</div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-angle-right" style="font-size:10px;"></i>
                <span><b>Rating Sync</b>: 每日 02:00, 14:00</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-angle-right" style="font-size:10px;"></i>
                <span><b>Daily Sync</b>: 每 2 小时执行一次</span>
            </div>
        </div>
    </div>

    <div class="card" id="cardRating">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon icon-purple"><i class="fas fa-star"></i></div>
                Rating Sync
            </div>
            <button class="btn btn-primary" onclick="runSync('RATING_SYNC', this)" style="padding:6px 12px;">
                <i class="fas fa-play"></i> 立即运行
            </button>
        </div>
        <div class="content-placeholder" style="text-align:center;color:#ccc;padding:20px;">加载中...</div>
        <div class="stats-content" style="display:none;">
            <div class="stat-row"><span>状态</span> <span class="stat-val st-pill">--</span></div>
            <div class="stat-row"><span>最近执行</span> <span class="stat-val time">--</span></div>
            <div class="stat-row"><span>耗时</span> <span class="stat-val duration">--</span></div>
            <div class="progress-bg">
                <div class="progress-bar bg-success" style="width:0%"></div>
                <div class="progress-bar bg-danger" style="width:0%"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; color:#64748b;">
                <span class="success-count">0 成功</span>
                <span class="fail-count">0 失败</span>
            </div>
        </div>
    </div>

    <div class="card" id="cardDaily">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon icon-blue"><i class="fas fa-calendar-day"></i></div>
                Daily Sync
            </div>
            <button class="btn btn-primary" onclick="runSync('DAILY_SYNC', this)" style="padding:6px 12px;">
                <i class="fas fa-play"></i> 立即运行
            </button>
        </div>
        <div class="content-placeholder" style="text-align:center;color:#ccc;padding:20px;">加载中...</div>
        <div class="stats-content" style="display:none;">
            <div class="stat-row"><span>状态</span> <span class="stat-val st-pill">--</span></div>
            <div class="stat-row"><span>最近执行</span> <span class="stat-val time">--</span></div>
            <div class="stat-row"><span>耗时</span> <span class="stat-val duration">--</span></div>
            <div class="progress-bg">
                <div class="progress-bar bg-success" style="width:0%"></div>
                <div class="progress-bar bg-danger" style="width:0%"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; color:#64748b;">
                <span class="success-count">0 成功</span>
                <span class="fail-count">0 失败</span>
            </div>
        </div>
    </div>
</div>

<div class="table-card">
    <div class="toolbar">
        <div style="font-weight:600;font-size:15px;">任务执行记录</div>
        <button class="btn btn-outline" onclick="loadJobs(1)">
            <i class="fas fa-sync-alt" id="refreshIcon"></i> 刷新
        </button>
    </div>
    <table>
        <thead>
        <tr>
            <th style="width:60px">ID</th>
            <th>任务类型</th>
            <th>触发方式</th>
            <th>状态</th>
            <th>开始时间 / 耗时</th>
            <th>执行结果 (总/成/败/跳)</th>
            <th style="text-align:right">操作</th>
        </tr>
        </thead>
        <tbody id="jobTableBody">
        <tr><td colspan="7" style="text-align:center;padding:30px;color:#94a3b8;">加载中...</td></tr>
        </tbody>
    </table>

    <div class="pagination-footer">
        <div class="page-desc">
            第 <span id="currPage" style="font-weight:600;color:#0f172a">1</span> 页 / 共 <span id="totalPage">1</span> 页，总计 <span id="totalCount">0</span> 条
        </div>
        <div class="pg-container" id="pagination"></div>
    </div>
</div>

<div id="rerunModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <div class="modal-title">重跑失败任务</div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert-box">
                <i class="fas fa-exclamation-triangle"></i>
                <span>检测到以下用户在上次同步中失败，请确认是否针对这些用户重新执行同步？</span>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="fail-table">
                    <thead>
                    <tr>
                        <th style="width: 80px;">User ID</th>
                        <th>错误代码</th>
                        <th>错误描述 / 建议</th>
                    </tr>
                    </thead>
                    <tbody id="failListBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">取消</button>
            <button class="btn btn-danger" id="confirmRerunBtn">
                <span id="rerunBtnText"><i class="fas fa-redo"></i> 确认重跑</span>
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const API_BASE = /*[[@{/api/admin}]]*/ '/api/admin';
    const PAGE_SIZE = 6;
    let currentPage = 1;

    $(document).ready(function() {
        initSchedulerStatus();
        loadOverview();
        loadJobs(1);
    });

    // 1. 调度器状态
    function initSchedulerStatus() {
        $.get(`${API_BASE}/schedule/status`, function(res) {
            if(res.code === 200) {
                const enabled = res.data;
                $('#scheduleToggle').prop('checked', enabled);
                updateScheduleText(enabled);
            }
        });
    }
    function toggleSchedule() {
        const enabled = $('#scheduleToggle').prop('checked');
        updateScheduleText(enabled);
        $.post(`${API_BASE}/schedule/enable?enabled=${enabled}`, function(res) {
            if(res.code === 200) showToast('success', enabled ? '调度服务已开启' : '调度服务已停止');
            else showToast('error', res.msg);
        });
    }
    function updateScheduleText(enabled) {
        const txt = $('#scheduleText');
        if(enabled) txt.text('运行中').addClass('active');
        else txt.text('已停止').removeClass('active');
    }

    // 2. 概览卡片
    function loadOverview() {
        $.get(`${API_BASE}/sync/overview?limit=1`, function(res) {
            if(res.code === 200) {
                renderCard('#cardRating', res.data.latestRating);
                renderCard('#cardDaily', res.data.latestDaily);
            }
        });
    }
    function renderCard(selector, job) {
        const $card = $(selector);
        $card.find('.content-placeholder').hide();
        const $content = $card.find('.stats-content').fadeIn();

        if(!job) {
            $content.html('<div style="text-align:center;color:#94a3b8;padding:10px;">暂无记录</div>');
            return;
        }

        const successRate = job.totalCount > 0 ? (job.successCount / job.totalCount * 100) : 0;
        const failRate = job.totalCount > 0 ? (job.failCount / job.totalCount * 100) : 0;

        let statusHtml = '';
        if(job.status === 'SUCCESS') statusHtml = '<span class="status-pill st-success">成功</span>';
        else if(job.status === 'RUNNING') statusHtml = '<span class="status-pill st-running">运行中</span>';
        else statusHtml = '<span class="status-pill st-fail">失败</span>';

        $content.find('.st-pill').html(statusHtml);
        $content.find('.time').text(formatTime(job.startTime));
        $content.find('.duration').text((job.durationMs / 1000).toFixed(1) + 's');
        $content.find('.bg-success').css('width', successRate + '%');
        $content.find('.bg-danger').css('width', failRate + '%');
        $content.find('.success-count').text(`${job.successCount} 成功`);
        $content.find('.fail-count').text(`${job.failCount} 失败`);
    }

    // 3. 任务列表
    function loadJobs(page) {
        $('#refreshIcon').addClass('spin');
        $.get(`${API_BASE}/sync/jobs`, {page: page, pageSize: PAGE_SIZE}, function(res) {
            $('#refreshIcon').removeClass('spin');
            if(res.code === 200) {
                renderTable(res.data.list);
                renderPagination(res.data.total, page);
                currentPage = page;
                $('#totalCount').text(res.data.total);
                $('#currPage').text(page);
                $('#totalPage').text(Math.ceil(res.data.total/PAGE_SIZE)||1);
            }
        }).fail(() => $('#refreshIcon').removeClass('spin'));
    }

    function renderTable(list) {
        const tbody = $('#jobTableBody');
        tbody.empty();

        if(!list || list.length === 0) {
            tbody.html('<tr><td colspan="7" style="text-align:center;padding:20px;color:#94a3b8">暂无数据</td></tr>');
            return;
        }

        list.forEach(item => {
            const statusClass = item.status==='SUCCESS'?'st-success':(item.status==='RUNNING'?'st-running':'st-fail');
            const timeStr = item.startTime.replace('T', ' ').substring(0, 19);
            const duration = (item.durationMs / 1000).toFixed(1) + 's';

            // [修复] 计算 Skip 数量
            // total = success + fail + skip
            // 所以 skip = total - success - fail
            const skipCount = item.totalCount - item.successCount - item.failCount;

            // [修复] 显示包含 Skip 的详细统计
            const summary = `
                    <span style="font-weight:600">${item.totalCount}</span> /
                    <span style="color:#166534">${item.successCount}</span> /
                    <span style="color:#ef4444">${item.failCount}</span> /
                    <span style="color:#94a3b8">${skipCount}</span>
                `;

            let actionBtn = '';
            if(item.failCount > 0 && item.status !== 'RUNNING') {
                actionBtn = `<button class="btn btn-rerun" onclick="openRerunModal(${item.id})"><i class="fas fa-redo"></i> 重跑失败</button>`;
            }

            const tr = `
                    <tr>
                        <td style="color:#64748b;font-family:monospace;">${item.id}</td>
                        <td style="font-weight:600;">${item.jobType}</td>
                        <td>${item.triggerSource}</td>
                        <td><span class="status-pill ${statusClass}">${item.status}</span></td>
                        <td>
                            <div style="font-size:12px;">${timeStr}</div>
                            <div style="font-size:11px;color:#64748b;">耗时: ${duration}</div>
                        </td>
                        <td style="font-family:monospace; font-size:13px;">${summary}</td>
                        <td style="text-align:right;">${actionBtn}</td>
                    </tr>
                `;
            tbody.append(tr);
        });
    }

    function renderPagination(total, curr) {
        const totalPages = Math.ceil(total / PAGE_SIZE) || 1;
        const $pg = $('#pagination');
        $pg.empty();
        const btn = (p, icon, dis) => `<button class="pg-btn ${p===curr?'active':''}" onclick="loadJobs(${p})" ${dis?'disabled':''}>${icon}</button>`;
        $pg.append(btn(curr-1, '<i class="fas fa-chevron-left"></i>', curr<=1));

        if (totalPages <= 7) {
            for(let i=1; i<=totalPages; i++) $pg.append(btn(i, i, false));
        } else {
            if(curr <= 4) {
                for(let i=1; i<=5; i++) $pg.append(btn(i, i, false));
                $pg.append('<span style="padding:0 5px;color:#94a3b8;">...</span>');
                $pg.append(btn(totalPages, totalPages, false));
            } else if (curr >= totalPages - 3) {
                $pg.append(btn(1, 1, false));
                $pg.append('<span style="padding:0 5px;color:#94a3b8;">...</span>');
                for(let i=totalPages-4; i<=totalPages; i++) $pg.append(btn(i, i, false));
            } else {
                $pg.append(btn(1, 1, false));
                $pg.append('<span style="padding:0 5px;color:#94a3b8;">...</span>');
                for(let i=curr-1; i<=curr+1; i++) $pg.append(btn(i, i, false));
                $pg.append('<span style="padding:0 5px;color:#94a3b8;">...</span>');
                $pg.append(btn(totalPages, totalPages, false));
            }
        }
        $pg.append(btn(curr+1, '<i class="fas fa-chevron-right"></i>', curr>=totalPages));
    }

    // 4. 操作动作
    function runSync(type, btn) {
        if(!confirm('确定要手动触发该同步任务吗？这可能需要一些时间。')) return;
        const $btn = $(btn);
        const originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<i class="fas fa-spinner spin"></i> 请求中');

        $.post(`${API_BASE}/sync/run?jobType=${type}`, function(res) {
            setTimeout(() => $btn.prop('disabled', false).html(originalHtml), 2000);
            if(res.code === 200) {
                showToast('success', '任务已提交，ID: ' + res.data);
                loadOverview();
                setTimeout(() => loadJobs(1), 1000);
            } else {
                showToast('error', res.msg);
            }
        });
    }

    // 5. 模态框逻辑
    function openRerunModal(jobId) {
        const modal = $('#rerunModal');
        const tbody = $('#failListBody');

        tbody.html('<tr><td colspan="3" style="text-align:center;padding:20px;color:#94a3b8;"><i class="fas fa-spinner spin"></i> 加载失败详情...</td></tr>');
        modal.addClass('show');

        // [关键修改] 使用正确的接口路径：/api/admin/sync/jobs/{jobId}
        $.get(`${API_BASE}/sync/jobs/${jobId}`, function(res) {
            if(res.code === 200) {
                // 后端返回的是 SyncJobDetailVO，其中包含 failList
                const fails = res.data.failList || [];
                tbody.empty();

                if(fails.length === 0) {
                    tbody.html('<tr><td colspan="3" style="text-align:center;padding:20px;">无失败记录</td></tr>');
                    $('#confirmRerunBtn').prop('disabled', true);
                } else {
                    $('#confirmRerunBtn').prop('disabled', false);
                    fails.forEach(f => {
                        tbody.append(`
                               <tr>
                                   <td style="font-family:monospace;font-weight:600;">${f.userId}</td>
                                   <td><span class="code-badge">${f.errorCode || 'UNKNOWN'}</span></td>
                                   <td style="color:#ef4444;">${f.errorCodeDesc || f.errorMessage || '-'}</td>
                               </tr>
                           `);
                    });
                    $('#confirmRerunBtn').off('click').on('click', function() {
                        doRerun(jobId);
                    });
                }
            } else {
                tbody.html(`<tr><td colspan="3" style="color:red;text-align:center;">加载失败: ${res.msg}</td></tr>`);
            }
        });
    }

    function closeModal() {
        $('#rerunModal').removeClass('show');
    }

    function doRerun(jobId) {
        const btn = $('#confirmRerunBtn');
        const originalText = $('#rerunBtnText').html();

        btn.prop('disabled', true);
        $('#rerunBtnText').html('<i class="fas fa-spinner spin"></i> 提交中...');

        $.post(`${API_BASE}/sync/rerun?jobId=${jobId}`, function(res) {
            if(res.code === 200) {
                showToast('success', '重跑任务已启动');
                closeModal();
                loadJobs(1);
            } else {
                showToast('error', res.msg);
            }
        }).always(function() {
            btn.prop('disabled', false);
            $('#rerunBtnText').html(originalText);
        });
    }

    function formatTime(t) {
        if(!t) return '-';
        const date = new Date(t);
        const now = new Date();
        const diff = (now - date) / 1000;
        if(diff < 60) return '刚刚';
        if(diff < 3600) return Math.floor(diff/60) + '分钟前';
        return t.replace('T', ' ').substring(5, 16);
    }

    function showToast(type, msg) {
        const t = $('#toast');
        t.text(msg).css('background', type==='success'?'#10b981':'#ef4444').fadeIn().delay(3000).fadeOut();
    }
    /*]]>*/
</script>
</body>
</html>