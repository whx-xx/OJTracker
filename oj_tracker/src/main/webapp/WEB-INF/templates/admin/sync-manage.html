<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步管理</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --text-dark: #34495e;
            --text-gray: #7f8c8d;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Noto Sans SC', sans-serif; }
        body { background-color: var(--bg-color); padding: 20px; color: var(--text-dark); overflow-y: auto; }

        /* === 顶部概览 Grid === */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.05);
        }

        .status-info h3 {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .status-info .value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            font-family: 'Courier New', monospace;
        }

        .status-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .icon-purple { background: rgba(78, 84, 200, 0.1); color: var(--primary-color); }
        .icon-blue { background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .icon-orange { background: rgba(241, 196, 15, 0.1); color: var(--warning-color); }

        /* 开关 */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* === 手动控制栏 === */
        .control-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .control-label { font-weight: 600; font-size: 14px; margin-right: 5px; }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #3f2b96; transform: translateY(-2px); }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-dark); }
        .btn-outline:hover { border-color: var(--primary-color); color: var(--primary-color); }

        /* === 表格样式 === */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.03);
            padding: 25px;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-header h3 { font-size: 16px; font-weight: 600; color: var(--text-dark); margin: 0; }

        .table-responsive { overflow-x: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        thead { background-color: #f8fafc; border-bottom: 2px solid var(--border-color); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        th { font-weight: 600; color: var(--text-gray); font-size: 12px; text-transform: uppercase; }

        /* 状态Badge */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-success { background: rgba(46, 204, 113, 0.15); color: var(--success-color); }
        .badge-fail { background: rgba(231, 76, 60, 0.15); color: var(--danger-color); }
        .badge-running { background: rgba(52, 152, 219, 0.15); color: #3498db; }

        .type-tag {
            font-family: 'Noto Sans SC', sans-serif; /* 使用中文字体 */
            background: #f1f5f9;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            color: var(--primary-color);
            background: rgba(78, 84, 200, 0.1);
        }

        /* === 统一分页样式 === */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 0;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .pagination-info { font-size: 12px; color: var(--text-gray); }
        .page-btn {
            width: 28px; height: 28px;
            border: 1px solid var(--border-color);
            background: white; border-radius: 4px;
            cursor: pointer; color: var(--text-dark);
            font-size: 12px; margin-left: 4px;
        }
        .page-btn:hover:not(:disabled) { border-color: var(--primary-color); color: var(--primary-color); }
        .page-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .page-btn:disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; }

        /* === 详情模态框 === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .custom-modal {
            background: white; width: 650px; max-width: 95%;
            border-radius: 12px; padding: 25px;
            transform: translateY(20px); transition: transform 0.3s;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .modal-overlay.show .custom-modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { font-size: 18px; font-weight: 600; margin: 0; }
        .close-modal { background: none; border: none; font-size: 20px; cursor: pointer; color: #999; }

        /* 列表容器通用样式 */
        .list-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #fcfcfc;
            min-height: 100px; /* 给一个最小高度 */
            max-height: 250px; /* 限制每个列表的最大高度 */
            margin-bottom: 10px;
        }

        .list-item {
            padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .list-item:last-child { border-bottom: none; }

        .item-main { font-weight: 600; font-size: 13px; color: var(--text-dark); display: flex; align-items: center; gap: 8px;}
        .item-sub { font-size: 11px; color: var(--text-gray); margin-top: 2px; }
        .item-end { text-align: right; font-size: 12px; }

        /* 数据变化 Badge */
        .stat-badge {
            background: #eef2ff; color: #4e54c8;
            padding: 2px 6px; border-radius: 4px; font-size: 11px; font-family: monospace;
            margin-left: 5px;
        }

        @media (max-width: 800px) {
            .overview-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- 第一行：概览卡片 -->
<div class="overview-grid">
    <!-- 自动调度状态 -->
    <div class="status-card">
        <div class="status-info">
            <h3>自动调度器</h3>
            <div style="display:flex; align-items:center; gap:10px;">
                <label class="switch">
                    <input type="checkbox" id="schedulerToggle" onchange="toggleScheduler()">
                    <span class="slider"></span>
                </label>
                <span id="schedulerText" style="font-size:13px; color:var(--text-gray);">检查中...</span>
            </div>
        </div>
        <div class="status-icon icon-purple">
            <i class="fas fa-robot"></i>
        </div>
    </div>

    <!-- 上次 Rating 同步 -->
    <div class="status-card">
        <div class="status-info">
            <h3>上次 Rating 同步</h3>
            <div class="value" id="lastRatingTime">--</div>
        </div>
        <div class="status-icon icon-orange">
            <i class="fas fa-trophy"></i>
        </div>
    </div>

    <!-- 上次每日同步 -->
    <div class="status-card">
        <div class="status-info">
            <h3>上次 Daily 同步</h3>
            <div class="value" id="lastDailyTime">--</div>
        </div>
        <div class="status-icon icon-blue">
            <i class="fas fa-code"></i>
        </div>
    </div>
</div>

<!-- 第二行：手动控制栏 -->
<div class="control-bar">
    <span class="control-label">手动触发任务：</span>
    <button class="btn btn-primary" onclick="runSync('DAILY_SYNC')">
        <i class="fas fa-sync"></i> Daily Sync (做题记录)
    </button>
    <button class="btn btn-outline" onclick="runSync('RATING_SYNC')">
        <i class="fas fa-chart-line"></i> Rating Sync (积分)
    </button>

    <div style="margin-left: 10px; font-size:12px; color:var(--text-gray);">
        <div style="margin-bottom: 3px;">
            <i class="fas fa-clock" style="color:var(--primary-color); margin-right:4px;"></i>
            <strong>Daily:</strong> 每 2 小时 <span style="margin: 0 5px; color:#ddd;">|</span>
            <strong>Rating:</strong> 每天 02:00 / 14:00
        </div>
        <div style="opacity: 0.7; font-size: 11px;">
            <i class="fas fa-info-circle" style="margin-right:2px;"></i> 手动触发将在后台异步执行
        </div>
    </div>
</div>

<!-- 第三行：任务历史表格 -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-history"></i> 任务执行历史</h3>
        <button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;" onclick="loadJobs(1)">
            <i class="fas fa-redo"></i> 刷新
        </button>
    </div>
    <div class="table-responsive">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>类型</th>
                <th>状态</th>
                <th>耗时</th>
                <th>进度 (成功/失败)</th>
                <th>触发方式</th>
                <th>开始时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="jobTableBody">
            <tr><td colspan="8" style="text-align:center; padding:30px; color:#999;"><i class="fas fa-spinner fa-spin"></i> 加载中...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- 统一分页 -->
    <div class="pagination-container" id="paginationContainer" style="display:none;">
        <div class="pagination-info" id="pageInfo"></div>
        <div id="pagination" style="display:flex;"></div>
    </div>
</div>

<!-- === 详情模态框 === -->
<div class="modal-overlay" id="detailModal">
    <div class="custom-modal">
        <div class="modal-header">
            <h3>任务详情 #<span id="modalJobId"></span></h3>
            <button class="close-modal" onclick="closeModal('detailModal')">&times;</button>
        </div>

        <div style="margin-bottom: 15px; font-size: 13px; color: var(--text-gray); display:flex; gap: 15px; align-items:center;">
            <span id="modalJobType" class="type-tag"></span>
            <span id="modalJobStatusBadge"></span>
            <span><i class="far fa-clock"></i> <span id="modalJobTime"></span></span>
        </div>

        <!-- 失败列表 -->
        <div style="margin-bottom: 5px; font-weight: 600; font-size: 13px; display:flex; justify-content:space-between;">
            <span>失败列表 (<span id="failCount" style="color:var(--danger-color)">0</span>)</span>
        </div>
        <div class="list-container" id="failListContainer">
            <!-- JS 填充 -->
        </div>

        <!-- 变化列表 (新增) -->
        <div style="margin-top: 10px; margin-bottom: 5px; font-weight: 600; font-size: 13px;">
            更新列表 (成功且有数据变动: <span id="changeCount" style="color:var(--success-color)">0</span>)
        </div>
        <div class="list-container" id="changeListContainer">
            <!-- JS 填充 -->
        </div>

        <div class="modal-footer" style="margin-top: 15px; text-align: right;">
            <button class="btn btn-outline" style="display:inline-flex;" onclick="closeModal('detailModal')">关闭</button>
            <button id="btnRerun" class="btn btn-primary" style="display:none; margin-left: 10px;" onclick="doRerun()">
                <i class="fas fa-hammer"></i> 重试失败用户
            </button>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 10;
    let currentJobId = null;

    // 任务类型映射
    const JOB_TYPE_MAP = {
        'DAILY_SYNC': '每日同步 (题目)',
        'RATING_SYNC': 'Rating同步 (积分)',
        'MANUAL': '手动同步'
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadOverview();
        loadJobs(1);
        checkSchedulerStatus();
    });

    // 格式化类型显示
    function formatJobType(type) {
        return JOB_TYPE_MAP[type] || type;
    }

    // 1. 概览信息
    function loadOverview() {
        axios.get('/api/admin/sync/overview').then(res => {
            if(res.data.code === 200) {
                const data = res.data.data;
                document.getElementById('lastRatingTime').textContent = formatTime(data.latestRating?.endTime) || '无记录';
                document.getElementById('lastDailyTime').textContent = formatTime(data.latestDaily?.endTime) || '无记录';
            }
        });
    }

    function checkSchedulerStatus() {
        axios.get('/api/admin/sync/schedule/status').then(res => {
            if(res.data.code === 200) {
                const isActive = res.data.data;
                document.getElementById('schedulerToggle').checked = isActive;
                document.getElementById('schedulerText').textContent = isActive ? '运行中' : '已停止';
            }
        });
    }

    function toggleScheduler() {
        const toggle = document.getElementById('schedulerToggle');
        axios.post('/api/admin/sync/schedule/toggle').then(res => {
            if(res.data.code === 200) {
                const newState = res.data.data;
                toggle.checked = newState;
                document.getElementById('schedulerText').textContent = newState ? '运行中' : '已停止';
                Swal.fire({
                    icon: 'success',
                    title: newState ? '调度器已启动' : '调度器已暂停',
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                });
            } else {
                toggle.checked = !toggle.checked; // Revert
                Swal.fire('Error', res.data.msg, 'error');
            }
        });
    }

    // 2. 触发同步
    function runSync(type) {
        Swal.fire({
            title: '确认触发?',
            text: `即将启动 ${formatJobType(type)} 任务，这将在后台运行。`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4e54c8',
            confirmButtonText: '立即运行'
        }).then((result) => {
            if (result.isConfirmed) {
                axios.post(`/api/admin/sync/run?jobType=${type}`).then(res => {
                    if(res.data.code === 200) {
                        Swal.fire('已启动', '任务已加入后台队列', 'success');
                        setTimeout(() => loadJobs(1), 1000);
                    } else {
                        Swal.fire('失败', res.data.msg, 'error');
                    }
                });
            }
        });
    }

    // 3. 任务列表
    function loadJobs(page) {
        currentPage = page;
        axios.get('/api/admin/sync/jobs', { params: { page: page, pageSize: pageSize } }).then(res => {
            if(res.data.code === 200) {
                const data = res.data.data;
                renderTable(data.records);
                renderPagination(data.total, data.pages, data.current);
                document.getElementById('paginationContainer').style.display = 'flex';
            }
        });
    }

    function renderTable(list) {
        const tbody = document.getElementById('jobTableBody');
        tbody.innerHTML = '';

        if(!list || list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:#999;">暂无记录</td></tr>`;
            return;
        }

        list.forEach(job => {
            let statusBadge = job.status === 'SUCCESS' ? '<span class="badge badge-success">成功</span>' :
                job.status === 'FAILED' ? '<span class="badge badge-fail">失败</span>' :
                    '<span class="badge badge-running">进行中</span>';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td>#${job.id}</td>
                    <td><span class="type-tag">${formatJobType(job.jobType)}</span></td>
                    <td>${statusBadge}</td>
                    <td style="color:#7f8c8d; font-size:12px;">${formatDuration(job.durationMs)}</td>
                    <td>
                        <span style="color:var(--success-color); font-weight:500;">${job.successCount}</span> /
                        <span style="color:var(--danger-color); font-weight:500;">${job.failCount}</span>
                    </td>
                    <td>${formatTrigger(job.triggerSource)}</td>
                    <td>${formatTime(job.startTime)}</td>
                    <td>
                        <button class="btn btn-outline" style="padding:4px 10px; font-size:12px;" onclick="viewDetail(${job.id})">
                            详情
                        </button>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    // 4. 查看详情与重跑
    function viewDetail(jobId) {
        currentJobId = jobId;
        const modal = document.getElementById('detailModal');
        const failContainer = document.getElementById('failListContainer');
        const changeContainer = document.getElementById('changeListContainer');
        const btnRerun = document.getElementById('btnRerun');

        // Loading state
        failContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">加载中...</div>';
        changeContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">加载中...</div>';
        modal.classList.add('show');

        axios.get(`/api/admin/sync/jobs/${jobId}`).then(res => {
            if(res.data.code === 200) {
                const detail = res.data.data; // SyncJobDetailVO
                const job = detail.job;

                document.getElementById('modalJobId').textContent = job.id;
                document.getElementById('modalJobType').textContent = formatJobType(job.jobType);
                document.getElementById('modalJobStatusBadge').innerHTML = job.status === 'SUCCESS' ?
                    '<span class="badge badge-success">成功</span>' : '<span class="badge badge-fail">'+job.status+'</span>';
                document.getElementById('modalJobTime').textContent = formatTime(job.startTime);

                // 处理失败列表
                const fails = detail.failList || [];
                document.getElementById('failCount').textContent = fails.length;
                if (fails.length > 0) {
                    let html = '';
                    fails.forEach(f => {
                        html += `
                                <div class="list-item">
                                    <div>
                                        <div class="item-main">
                                            <i class="fas fa-user-times" style="color:var(--danger-color)"></i>
                                            ${f.handle}
                                        </div>
                                        <div class="item-sub">${f.suggestAction}</div>
                                    </div>
                                    <div class="item-end" style="color:var(--danger-color)">${f.errorMessage}</div>
                                </div>
                            `;
                    });
                    failContainer.innerHTML = html;
                    btnRerun.style.display = 'inline-flex';
                } else {
                    failContainer.innerHTML = '<div style="text-align:center; padding:15px; font-size:12px; color:#ccc;">无失败记录</div>';
                    btnRerun.style.display = 'none';
                }

                // 处理变更列表 (Success & Changed)
                const changes = detail.changeList || [];
                document.getElementById('changeCount').textContent = changes.length;
                if (changes.length > 0) {
                    let html = '';
                    changes.forEach(c => {
                        html += `
                                <div class="list-item">
                                    <div>
                                        <div class="item-main">
                                            <i class="fas fa-user-check" style="color:var(--success-color)"></i>
                                            ${c.handle}
                                        </div>
                                    </div>
                                    <div class="item-end">
                                        ${c.newSub > 0 ? `<span class="stat-badge">+${c.newSub} 提交</span>` : ''}
                                        ${c.newSolved > 0 ? `<span class="stat-badge" style="background:#e8f8f0; color:#2ecc71;">+${c.newSolved} AC</span>` : ''}
                                    </div>
                                </div>
                            `;
                    });
                    changeContainer.innerHTML = html;
                } else {
                    changeContainer.innerHTML = '<div style="text-align:center; padding:15px; font-size:12px; color:#ccc;">本次同步无数据变动</div>';
                }
            }
        });
    }

    function doRerun() {
        if (!currentJobId) return;
        Swal.fire({
            title: '确认重跑?',
            text: `将针对 #${currentJobId} 中的失败用户重新执行同步`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '确定重跑'
        }).then((result) => {
            if (result.isConfirmed) {
                axios.post(`/api/admin/sync/rerun?jobId=${currentJobId}`).then(res => {
                    if(res.data.code === 200) {
                        closeModal('detailModal');
                        Swal.fire('已触发', '重跑任务已启动，请稍后刷新列表查看新任务', 'success');
                        loadJobs(1);
                    } else {
                        Swal.fire('失败', res.data.msg, 'error');
                    }
                });
            }
        });
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    // 统一分页渲染
    function renderPagination(total, totalPages, current) {
        const info = document.getElementById('pageInfo');
        const container = document.getElementById('pagination');

        const startRecord = (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, total);

        info.textContent = `第 ${startRecord}-${endRecord} 条 / 共 ${total} 条`;

        let html = '';
        html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadJobs(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) html += pageBtn(i, current);
        } else {
            html += pageBtn(1, current);
            if (current > 3) html += `<span style="line-height:28px; padding:0 5px; color:#ccc;">...</span>`;
            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) html += pageBtn(i, current);
            if (current < totalPages - 2) html += `<span style="line-height:28px; padding:0 5px; color:#ccc;">...</span>`;
            html += pageBtn(totalPages, current);
        }
        html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadJobs(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;

        container.innerHTML = html;
    }

    function pageBtn(i, current) {
        return `<button class="page-btn ${i === current ? 'active' : ''}" onclick="loadJobs(${i})">${i}</button>`;
    }

    function formatTrigger(source) {
        if (!source) return '-';
        const s = source.toUpperCase();
        if (s.includes('MANUAL') || s.includes('API')) {
            return '<span style="color:#e67e22"><i class="fas fa-hand-pointer" style="margin-right:4px;"></i>手动触发</span>';
        }
        if (s.includes('SCHEDULE') || s.includes('AUTO') || s.includes('CRON')) {
            return '<span style="color:#27ae60"><i class="fas fa-clock" style="margin-right:4px;"></i>自动触发</span>';
        }
        return source;
    }

    function formatTime(iso) {
        if(!iso) return '--';
        const d = new Date(iso);
        return `${d.getMonth()+1}-${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function formatDuration(ms) {
        if(!ms) return '--';
        if(ms < 1000) return ms + 'ms';
        const s = Math.floor(ms / 1000);
        if(s < 60) return s + 's';
        const m = Math.floor(s / 60);
        return `${m}m ${s%60}s`;
    }
</script>
</body>
</html>