<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步管理</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        dark: '#0f172a', // 更深的黑色
                        graytext: '#64748b',
                        bg: '#f1f5f9', // 稍微深一点的背景，突出卡片
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-bg text-dark font-poppins min-h-screen p-4 md:p-6 overflow-y-auto">

<div class="max-w-7xl mx-auto space-y-6">

    <!-- 第一行：概览卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- 自动调度状态 -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200/60 flex items-center justify-between hover:shadow-md transition-all">
            <div>
                <!-- 添加 whitespace-nowrap 防止换行 -->
                <h3 class="text-xs font-bold text-graytext uppercase tracking-wider mb-2 whitespace-nowrap">自动调度器</h3>
                <div class="flex items-center gap-3">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="schedulerToggle" class="sr-only peer" onchange="toggleScheduler()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary transition-colors"></div>
                        <span class="ml-3 text-sm font-bold text-dark" id="schedulerText">检查中...</span>
                    </label>
                </div>
            </div>
            <div class="w-12 h-12 rounded-lg bg-indigo-50 text-primary flex items-center justify-center text-xl shadow-sm">
                <i class="fas fa-robot"></i>
            </div>
        </div>

        <!-- 上次分数同步 -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200/60 flex items-center justify-between hover:shadow-md transition-all">
            <div>
                <!-- 添加 whitespace-nowrap 防止换行 -->
                <h3 class="text-xs font-bold text-graytext uppercase tracking-wider mb-1 whitespace-nowrap">积分同步</h3>
                <div class="text-lg font-bold text-dark font-mono tracking-tight" id="lastRatingTime">--</div>
            </div>
            <div class="w-12 h-12 rounded-lg bg-amber-50 text-warning flex items-center justify-center text-xl shadow-sm">
                <i class="fas fa-trophy"></i>
            </div>
        </div>

        <!-- 上次每日同步 -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200/60 flex items-center justify-between hover:shadow-md transition-all">
            <div>
                <!-- 添加 whitespace-nowrap 防止换行 -->
                <h3 class="text-xs font-bold text-graytext uppercase tracking-wider mb-1 whitespace-nowrap">Daily 同步</h3>
                <div class="text-lg font-bold text-dark font-mono tracking-tight" id="lastDailyTime">--</div>
            </div>
            <div class="w-12 h-12 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center text-xl shadow-sm">
                <i class="fas fa-code"></i>
            </div>
        </div>
    </div>

    <!-- 第二行：手动控制栏 -->
    <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200/60 flex flex-col md:flex-row items-center gap-4 justify-between">
        <div class="flex items-center gap-4 w-full md:w-auto">
            <span class="text-sm font-bold text-dark flex items-center gap-2 whitespace-nowrap bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                <i class="fas fa-bolt text-warning"></i> 手动触发
            </span>
            <div class="flex gap-2">
                <button class="px-4 py-2 bg-primary hover:bg-primary/90 text-white text-sm font-medium rounded-lg shadow-sm shadow-indigo-200 transition-all active:scale-95 flex items-center gap-2" onclick="runSync('DAILY_SYNC')">
                    <i class="fas fa-sync text-xs"></i> Daily
                </button>
                <button class="px-4 py-2 bg-white border border-slate-200 text-slate-700 text-sm font-medium rounded-lg hover:border-primary hover:text-primary transition-all active:scale-95 flex items-center gap-2" onclick="runSync('RATING_SYNC')">
                    <i class="fas fa-chart-line text-xs"></i> Rating
                </button>
            </div>
        </div>

        <div class="text-xs text-graytext flex items-center gap-3 bg-slate-50 px-3 py-2 rounded-lg w-full md:w-auto justify-center md:justify-end">
            <span class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 rounded-full bg-primary"></div> Daily: 每2小时</span>
            <span class="text-slate-300">|</span>
            <span class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 rounded-full bg-warning"></div> 分数: 02:00 / 14:00</span>
        </div>
    </div>

    <!-- 第三行：任务历史表格 -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200/60 overflow-hidden flex flex-col min-h-[500px]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
            <!-- 添加 whitespace-nowrap -->
            <h3 class="font-bold text-dark flex items-center gap-2 whitespace-nowrap">
                <i class="fas fa-history text-primary/70"></i> 任务执行历史
            </h3>
            <button class="w-8 h-8 flex items-center justify-center bg-slate-50 hover:bg-slate-100 text-slate-500 rounded-full transition-colors active:scale-90" onclick="loadJobs(1)" title="刷新">
                <i class="fas fa-redo-alt"></i>
            </button>
        </div>

        <div class="overflow-x-auto w-full flex-1">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50/80 sticky top-0 z-10 backdrop-blur-sm">
                <tr class="text-xs font-semibold text-slate-400 uppercase tracking-wider border-b border-slate-200">
                    <!-- 给所有表头添加 whitespace-nowrap，确保不换行 -->
                    <th class="px-6 py-4 w-24 whitespace-nowrap">Task ID</th>
                    <!-- 修改：类型和状态列头居中 -->
                    <th class="px-6 py-4 w-40 whitespace-nowrap text-center">类型</th>
                    <th class="px-6 py-4 w-32 whitespace-nowrap text-center">状态</th>
                    <th class="px-6 py-4 w-64 whitespace-nowrap">处理进度 (Success / Total)</th>
                    <th class="px-6 py-4 w-32 whitespace-nowrap">触发源</th>
                    <th class="px-6 py-4 w-32 whitespace-nowrap">耗时</th>
                    <th class="px-6 py-4 w-40 whitespace-nowrap">开始时间</th>
                    <th class="px-6 py-4 w-20 text-right whitespace-nowrap">操作</th>
                </tr>
                </thead>
                <tbody id="jobTableBody" class="divide-y divide-slate-100">
                <tr>
                    <td colspan="8" class="px-6 py-20 text-center text-graytext">
                        <div class="flex flex-col items-center gap-3 animate-pulse">
                            <i class="fas fa-circle-notch fa-spin text-2xl text-primary/30"></i>
                            <span class="text-sm">加载数据中...</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="mt-auto border-t border-slate-100 px-6 py-4 bg-white flex flex-col sm:flex-row justify-between items-center gap-4" id="paginationContainer" style="display:none;">
            <div class="text-xs text-slate-400 font-medium" id="pageInfo"></div>
            <div class="flex items-center gap-1.5" id="pagination"></div>
        </div>
    </div>

</div>

<!-- === 详情模态框 === -->
<div id="detailModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-dark/40 backdrop-blur-sm transition-opacity opacity-0">
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-4 transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]">
        <!-- Header -->
        <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center shrink-0 bg-white rounded-t-2xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-dark">任务详情</h3>
                    <p class="text-xs text-slate-400 font-mono">ID: <span id="modalJobId">--</span></p>
                </div>
            </div>
            <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors" onclick="closeModal('detailModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Body -->
        <div class="p-6 overflow-y-auto space-y-6 bg-slate-50/50">
            <!-- 顶部数据 (Cards) -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-xs font-semibold text-slate-400 uppercase mb-1">任务类型</p>
                    <p class="text-sm font-bold text-slate-700" id="modalJobType">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-xs font-semibold text-slate-400 uppercase mb-1">执行状态</p>
                    <div id="modalJobStatusBadge">--</div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-xs font-semibold text-slate-400 uppercase mb-1">开始时间</p>
                    <p class="text-sm font-bold text-slate-700 font-mono" id="modalJobTime">--</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 失败列表 -->
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-dark flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-danger ring-2 ring-danger/20"></span>
                            失败记录 <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-200" id="failCountText">0</span>
                        </h4>
                    </div>
                    <div class="border border-slate-200 rounded-xl bg-white overflow-hidden flex-1 shadow-sm h-[300px]">
                        <div class="h-full overflow-y-auto divide-y divide-slate-50" id="failListContainer">
                            <!-- JS 填充 -->
                        </div>
                    </div>
                </div>

                <!-- 变化列表 -->
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-dark flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-success ring-2 ring-success/20"></span>
                            数据更新 <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-200" id="changeCountText">0</span>
                        </h4>
                    </div>
                    <div class="border border-slate-200 rounded-xl bg-white overflow-hidden flex-1 shadow-sm h-[300px]">
                        <div class="h-full overflow-y-auto divide-y divide-slate-50" id="changeListContainer">
                            <!-- JS 填充 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 border-t border-slate-100 bg-white flex justify-end gap-3 shrink-0 rounded-b-2xl">
            <button class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-xs font-semibold rounded-lg hover:bg-slate-50 hover:text-dark transition-all" onclick="closeModal('detailModal')">关闭</button>
            <button id="btnRerun" class="px-4 py-2 bg-danger hover:bg-red-600 text-white text-xs font-semibold rounded-lg shadow-sm shadow-red-200 transition-all hidden items-center gap-2 active:scale-95" onclick="doRerun()">
                <i class="fas fa-redo"></i> 重试失败任务
            </button>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 10;
    let currentJobId = null;

    const JOB_TYPE_MAP = {
        'DAILY_SYNC': { label: '做题同步', icon: 'fa-calendar-check', color: 'text-blue-600 bg-blue-50' },
        'RATING_SYNC': { label: '分数同步', icon: 'fa-trophy', color: 'text-amber-600 bg-amber-50' },
        'MANUAL': { label: '手动同步', icon: 'fa-hand-pointer', color: 'text-slate-600 bg-slate-50' }
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadOverview();
        loadJobs(1);
        checkSchedulerStatus();
    });

    function loadOverview() {
        axios.get('/api/admin/sync/overview').then(res => {
            if(res.data.code === 200) {
                const data = res.data.data;
                document.getElementById('lastRatingTime').textContent = formatTimeShort(data.latestRating?.endTime) || '--';
                document.getElementById('lastDailyTime').textContent = formatTimeShort(data.latestDaily?.endTime) || '--';
            }
        });
    }

    function checkSchedulerStatus() {
        axios.get('/api/admin/sync/schedule/status').then(res => {
            if(res.data.code === 200) {
                const isActive = res.data.data;
                document.getElementById('schedulerToggle').checked = isActive;
                document.getElementById('schedulerText').textContent = isActive ? '运行中' : '已停止';
                const textEl = document.getElementById('schedulerText');
                if(isActive) {
                    textEl.classList.remove('text-slate-400');
                    textEl.classList.add('text-success');
                } else {
                    textEl.classList.remove('text-success');
                    textEl.classList.add('text-slate-400');
                }
            }
        });
    }

    function toggleScheduler() {
        const toggle = document.getElementById('schedulerToggle');
        axios.post('/api/admin/sync/schedule/toggle').then(res => {
            if(res.data.code === 200) {
                const newState = res.data.data;
                toggle.checked = newState;
                const textEl = document.getElementById('schedulerText');
                textEl.textContent = newState ? '运行中' : '已停止';
                if(newState) {
                    textEl.classList.remove('text-slate-400');
                    textEl.classList.add('text-success');
                } else {
                    textEl.classList.remove('text-success');
                    textEl.classList.add('text-slate-400');
                }
                Swal.fire({
                    icon: 'success',
                    title: newState ? '调度器已启动' : '调度器已暂停',
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                });
            } else {
                toggle.checked = !toggle.checked;
                Swal.fire('Error', res.data.msg, 'error');
            }
        });
    }

    function runSync(type) {
        Swal.fire({
            title: '确认触发?',
            text: `即将启动 ${JOB_TYPE_MAP[type]?.label || type} 任务`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4e54c8',
            confirmButtonText: '立即运行',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                axios.post(`/api/admin/sync/run?jobType=${type}`).then(res => {
                    if(res.data.code === 200) {
                        Swal.fire({icon:'success', title:'已启动', text:'任务已加入后台队列', timer:1500, showConfirmButton:false});
                        setTimeout(() => loadJobs(1), 1000);
                    } else {
                        Swal.fire('失败', res.data.msg, 'error');
                    }
                });
            }
        });
    }

    function loadJobs(page) {
        currentPage = page;
        axios.get('/api/admin/sync/jobs', { params: { page: page, pageSize: pageSize } }).then(res => {
            if(res.data.code === 200) {
                const data = res.data.data;
                renderTable(data.records);
                renderPagination(data.total, data.pages, data.current);
                document.getElementById('paginationContainer').style.display = 'flex';
            }
        });
    }

    function renderTable(list) {
        const tbody = document.getElementById('jobTableBody');
        tbody.innerHTML = '';

        if(!list || list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-16 text-center text-slate-400 flex flex-col items-center gap-2"><i class="fas fa-inbox text-3xl opacity-50"></i><span>暂无记录</span></td></tr>`;
            return;
        }

        list.forEach(job => {
            let statusBadge = '';
            if (job.status === 'SUCCESS') {
                statusBadge = `<div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100/50">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> 成功
                               </div>`;
            } else if (job.status === 'FAILED') {
                statusBadge = `<div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-600 border border-red-100/50">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> 失败
                               </div>`;
            } else {
                statusBadge = `<div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-600 border border-blue-100/50">
                                <i class="fas fa-circle-notch fa-spin text-[10px]"></i> 进行中
                               </div>`;
            }

            const typeConfig = JOB_TYPE_MAP[job.jobType] || { label: job.jobType, icon: 'fa-cube', color: 'text-slate-600 bg-slate-50' };
            // 修改：typeHtml 添加 justify-center 使其居中，添加 shrink-0 给图标，添加 whitespace-nowrap 给文字防止换行
            const typeHtml = `<div class="flex items-center justify-center gap-2">
                                <div class="w-7 h-7 rounded-lg flex items-center justify-center text-xs ${typeConfig.color} shrink-0">
                                    <i class="fas ${typeConfig.icon}"></i>
                                </div>
                                <span class="text-xs font-medium text-slate-700 whitespace-nowrap">${typeConfig.label}</span>
                              </div>`;

            const total = (job.successCount || 0) + (job.failCount || 0);
            const successPercent = total === 0 ? 0 : Math.round((job.successCount / total) * 100);
            const displayPercent = total > 0 ? successPercent : (job.status === 'SUCCESS' ? 100 : 0);

            const progressHtml = `
                <div class="w-full max-w-[180px]">
                    <div class="flex justify-between items-center text-[10px] text-slate-500 mb-1">
                        <span class="font-medium text-emerald-600">${job.successCount} 成功</span>
                        <span class="${job.failCount > 0 ? 'text-red-500 font-bold' : 'text-slate-300'}">${job.failCount} 失败</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full ${job.failCount > 0 ? 'bg-amber-400' : 'bg-emerald-400'} rounded-full transition-all duration-500" style="width: ${displayPercent}%"></div>
                    </div>
                </div>
            `;

            const startTimeObj = new Date(job.startTime);
            const dateStr = `${startTimeObj.getFullYear()}-${String(startTimeObj.getMonth()+1).padStart(2,'0')}-${String(startTimeObj.getDate()).padStart(2,'0')}`;
            const timeStr = `${String(startTimeObj.getHours()).padStart(2,'0')}:${String(startTimeObj.getMinutes()).padStart(2,'0')}:${String(startTimeObj.getSeconds()).padStart(2,'0')}`;

            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors group border-b border-slate-50 last:border-none";
            tr.innerHTML = `
                    <td class="px-6 py-4">
                        <span class="text-xs text-slate-400 font-mono">#${job.id}</span>
                    </td>
                    <!-- 修改：添加 text-center 使内容居中 -->
                    <td class="px-6 py-4 text-center">
                        ${typeHtml}
                    </td>
                    <!-- 修改：添加 text-center 使内容居中 -->
                    <td class="px-6 py-4 text-center">${statusBadge}</td>
                    <td class="px-6 py-4">${progressHtml}</td>
                    <td class="px-6 py-4">
                        ${formatTriggerBadge(job.triggerSource)}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1.5 text-xs text-slate-600 font-mono">
                            <i class="far fa-clock text-slate-300"></i> ${formatDuration(job.durationMs)}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="text-xs font-semibold text-slate-700">${dateStr}</span>
                            <span class="text-[10px] text-slate-400 font-mono">${timeStr}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button class="w-8 h-8 inline-flex items-center justify-center rounded-lg border border-slate-200 text-slate-400 hover:text-primary hover:border-primary hover:bg-primary/5 transition-all shadow-sm active:scale-95 bg-white"
                            onclick="viewDetail(${job.id})" title="查看详情">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    function formatTriggerBadge(source) {
        if (!source) return '<span class="text-xs text-slate-300">-</span>';
        const s = source.toUpperCase();
        if (s.includes('MANUAL') || s.includes('API')) {
            return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium bg-slate-100 text-slate-500 border border-slate-200">
                        <i class="fas fa-user text-[9px]"></i> 手动
                    </span>`;
        }
        return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium bg-indigo-50 text-primary border border-indigo-100">
                    <i class="fas fa-robot text-[9px]"></i> 自动
                </span>`;
    }

    function viewDetail(jobId) {
        currentJobId = jobId;
        const modal = document.getElementById('detailModal');
        const modalContent = modal.querySelector('.relative');
        const failContainer = document.getElementById('failListContainer');
        const changeContainer = document.getElementById('changeListContainer');
        const btnRerun = document.getElementById('btnRerun');

        failContainer.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs flex flex-col items-center gap-2"><i class="fas fa-circle-notch fa-spin text-xl text-primary/50"></i><span>加载中...</span></div>';
        changeContainer.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs flex flex-col items-center gap-2"><i class="fas fa-circle-notch fa-spin text-xl text-primary/50"></i><span>加载中...</span></div>';

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);

        axios.get(`/api/admin/sync/jobs/${jobId}`).then(res => {
            if(res.data.code === 200) {
                const detail = res.data.data;
                const job = detail.job;

                document.getElementById('modalJobId').textContent = job.id;
                document.getElementById('modalJobType').textContent = JOB_TYPE_MAP[job.jobType]?.label || job.jobType;

                let statusHtml = '';
                if(job.status === 'SUCCESS') statusHtml = '<span class="text-emerald-600 font-bold text-xs flex items-center gap-1.5"><i class="fas fa-check-circle"></i> 成功</span>';
                else if(job.status === 'FAILED') statusHtml = '<span class="text-red-500 font-bold text-xs flex items-center gap-1.5"><i class="fas fa-times-circle"></i> 失败</span>';
                else statusHtml = '<span class="text-blue-500 font-bold text-xs flex items-center gap-1.5"><i class="fas fa-spinner fa-spin"></i> 进行中</span>';
                document.getElementById('modalJobStatusBadge').innerHTML = statusHtml;

                document.getElementById('modalJobTime').textContent = formatTimeShort(job.startTime);

                const fails = detail.failList || [];
                document.getElementById('failCountText').textContent = fails.length;
                if (fails.length > 0) {
                    let html = '';
                    fails.forEach(f => {
                        html += `
                                <div class="p-4 bg-white hover:bg-red-50/10 transition-colors group border-b border-slate-50 last:border-0">
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center shrink-0 mt-0.5 border border-red-100">
                                            <i class="fas fa-exclamation text-xs"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start">
                                                <div class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                                    ${f.handle}
                                                    <span class="text-[10px] px-1.5 py-0 bg-slate-100 text-slate-400 rounded">#${f.userId}</span>
                                                </div>
                                            </div>
                                            <div class="text-xs text-red-500 mt-1 font-mono break-all bg-red-50/50 p-1.5 rounded border border-red-50">
                                                ${f.errorMessage}
                                            </div>
                                            <div class="text-[10px] text-slate-400 mt-1 flex items-center gap-1">
                                                <i class="fas fa-wrench"></i> 建议: ${f.suggestAction || '检查网络或账号状态'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                    });
                    failContainer.innerHTML = html;
                    btnRerun.classList.remove('hidden');
                    btnRerun.classList.add('flex');
                } else {
                    failContainer.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center gap-2 text-slate-300">
                            <i class="fas fa-check-circle text-2xl opacity-20"></i>
                            <span class="text-[10px]">完美！无失败记录</span>
                        </div>`;
                    btnRerun.classList.add('hidden');
                    btnRerun.classList.remove('flex');
                }

                const changes = detail.changeList || [];
                document.getElementById('changeCountText').textContent = changes.length;
                if (changes.length > 0) {
                    let html = '';
                    changes.forEach(c => {
                        html += `
                                <div class="p-3 bg-white hover:bg-slate-50 transition-colors flex items-center justify-between border-b border-slate-50 last:border-0">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center shrink-0 border border-emerald-100">
                                            <i class="fas fa-user-check text-xs"></i>
                                        </div>
                                        <div class="text-sm font-bold text-slate-700">${c.handle}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        ${c.newSub > 0 ? `<span class="bg-indigo-50 text-primary text-[10px] font-bold px-2 py-1 rounded border border-indigo-100 flex items-center gap-1"><i class="fas fa-plus text-[8px]"></i> ${c.newSub} 提交</span>` : ''}
                                        ${c.newSolved > 0 ? `<span class="bg-emerald-50 text-emerald-600 text-[10px] font-bold px-2 py-1 rounded border border-emerald-100 flex items-center gap-1"><i class="fas fa-arrow-up text-[8px]"></i> ${c.newSolved} AC</span>` : ''}
                                    </div>
                                </div>
                            `;
                    });
                    changeContainer.innerHTML = html;
                } else {
                    changeContainer.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center gap-3 text-slate-300">
                            <i class="fas fa-equals text-4xl opacity-20"></i>
                            <span class="text-xs">数据无变化</span>
                        </div>`;
                }
            }
        });
    }

    function doRerun() {
        if (!currentJobId) return;
        Swal.fire({
            title: '确认重跑?',
            text: `将针对 #${currentJobId} 中的失败用户重新执行同步`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '确定重跑',
            confirmButtonColor: '#ef4444'
        }).then((result) => {
            if (result.isConfirmed) {
                axios.post(`/api/admin/sync/rerun?jobId=${currentJobId}`).then(res => {
                    if(res.data.code === 200) {
                        closeModal('detailModal');
                        Swal.fire({icon:'success', title:'已触发', text:'重跑任务已启动，请稍后刷新列表', timer:1500});
                        loadJobs(1);
                    } else {
                        Swal.fire('失败', res.data.msg, 'error');
                    }
                });
            }
        });
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        const modalContent = modal.querySelector('.relative');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 200);
    }

    function renderPagination(total, totalPages, current) {
        const info = document.getElementById('pageInfo');
        const container = document.getElementById('pagination');

        const startRecord = (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, total);

        info.textContent = `显示 ${startRecord} - ${endRecord} / 共 ${total}`;

        let html = '';
        const btnBase = "w-8 h-8 flex items-center justify-center rounded-lg text-xs font-semibold transition-all border";
        const activeClass = "bg-primary border-primary text-white shadow-sm shadow-indigo-200";
        const normalClass = "bg-white border-slate-200 text-slate-600 hover:text-primary hover:border-primary hover:bg-primary/5";
        const disabledClass = "bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed";

        html += `<button class="${btnBase} ${current === 1 ? disabledClass : normalClass} mr-1" ${current === 1 ? 'disabled' : ''} onclick="loadJobs(${current - 1})"><i class="fas fa-chevron-left"></i></button>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) html += pageBtn(i, current, activeClass, normalClass);
        } else {
            html += pageBtn(1, current, activeClass, normalClass);
            if (current > 3) html += `<span class="w-8 h-8 flex items-center justify-center text-slate-300 text-[10px]">...</span>`;
            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) html += pageBtn(i, current, activeClass, normalClass);
            if (current < totalPages - 2) html += `<span class="w-8 h-8 flex items-center justify-center text-slate-300 text-[10px]">...</span>`;
            html += pageBtn(totalPages, current, activeClass, normalClass);
        }
        html += `<button class="${btnBase} ${current === totalPages ? disabledClass : normalClass} ml-1" ${current === totalPages ? 'disabled' : ''} onclick="loadJobs(${current + 1})"><i class="fas fa-chevron-right"></i></button>`;

        container.innerHTML = html;
    }

    function pageBtn(i, current, activeClass, normalClass) {
        return `<button class="w-8 h-8 flex items-center justify-center rounded-lg text-xs font-semibold transition-all border ${i === current ? activeClass : normalClass}" onclick="loadJobs(${i})">${i}</button>`;
    }

    function formatTimeShort(iso) {
        if(!iso) return null;
        const d = new Date(iso);
        return `${d.getMonth()+1}-${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function formatDuration(ms) {
        if(!ms) return '-';
        if(ms < 1000) return ms + 'ms';
        const s = (ms / 1000).toFixed(1);
        if(s < 60) return s + 's';
        const m = Math.floor(s / 60);
        const remS = Math.floor(s % 60);
        return `${m}m ${remS}s`;
    }
</script>
</body>
</html>