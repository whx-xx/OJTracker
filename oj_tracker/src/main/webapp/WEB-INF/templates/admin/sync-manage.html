<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Schedule</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script th:src="@{/static/js/jquery.min.js}"></script>

    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-light: #64748b;
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            margin: 0; padding: 20px 40px;
        }

        /* --- Grid Layout for Top Section --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .icon-blue { background: #eff6ff; color: var(--primary); }
        .icon-purple { background: #f3e8ff; color: #9333ea; }
        .icon-orange { background: #fff7ed; color: var(--warning); }

        /* Switch Toggle */
        .switch-container { display: flex; align-items: center; gap: 12px; }
        .switch {
            position: relative; display: inline-block; width: 44px; height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
        .status-text { font-size: 14px; font-weight: 600; color: var(--text-light); }
        .status-text.active { color: var(--success); }

        /* Stats Rows */
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: var(--text-light); }
        .stat-val { font-weight: 600; color: var(--text-main); }
        .progress-bg { height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; display: flex; margin-top: 12px; }
        .progress-bar { height: 100%; }
        .bg-success { background: var(--success); }
        .bg-danger { background: var(--danger); }

        /* Buttons */
        .btn {
            padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
            border: 1px solid transparent; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: #cbd5e1; background: #f8fafc; }
        .btn-rerun { background: #fee2e2; color: #b91c1c; border-color: #fecaca; padding: 4px 10px; font-size: 12px; }
        .btn-rerun:hover { background: #fecaca; }

        /* Table Area */
        .table-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .toolbar { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px 24px; background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 14px 24px; color: #334155; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }

        .status-pill { padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .st-success { background: #dcfce7; color: #166534; }
        .st-fail { background: #fee2e2; color: #991b1b; }
        .st-running { background: #dbeafe; color: #1e40af; }

        /* --- Pagination (Modern) --- */
        .pagination-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 24px; border-top: 1px solid var(--border);
            background: #fcfcfd;
        }
        .page-desc { font-size: 13px; color: #64748b; }
        .pg-container { display: flex; gap: 4px; background: #fff; padding: 2px; border-radius: 6px; border: 1px solid var(--border); }

        .pg-btn {
            min-width: 28px; height: 28px; padding: 0 8px; border-radius: 4px;
            border: none; background: transparent;
            color: #475569; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.15s;
            display: flex; align-items: center; justify-content: center;
        }
        .pg-btn:hover:not(:disabled) { background: #f1f5f9; color: #0f172a; }
        .pg-btn.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .pg-btn:disabled { color: #cbd5e1; cursor: default; }

        /* Toast */
        #toast { position: fixed; top: 20px; right: 20px; z-index: 2000; padding: 10px 20px; border-radius: 8px; color: #fff; font-weight: 500; display: none; }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast"></div>

<!-- 顶部状态面板 -->
<div class="dashboard-grid">
    <!-- 调度开关 -->
    <div class="card" style="justify-content: space-between;">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon icon-orange"><i class="fas fa-clock"></i></div>
                自动调度服务
            </div>
        </div>
        <div style="flex:1; display:flex; align-items:center;">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="scheduleToggle" onchange="toggleSchedule()">
                    <span class="slider"></span>
                </label>
                <span class="status-text" id="scheduleText">已停止</span>
            </div>
        </div>
        <!-- 详细的调度时间 -->
        <div style="font-size:12px; color:#94a3b8; margin-top:12px; line-height: 1.6; border-top: 1px solid #f1f5f9; padding-top: 10px;">
            <div style="margin-bottom:4px; font-weight:500; color:#64748b;">定时策略 (Shanghai):</div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-angle-right" style="font-size:10px;"></i>
                <span><b>Rating Sync</b>: 每日 02:00, 14:00</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-angle-right" style="font-size:10px;"></i>
                <span><b>Daily Sync</b>: 每 2 小时执行一次</span>
            </div>
        </div>
    </div>

    <!-- Rating Sync 概览 -->
    <div class="card" id="cardRating">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon icon-purple"><i class="fas fa-star"></i></div>
                Rating Sync
            </div>
            <button class="btn btn-primary" onclick="runSync('RATING_SYNC', this)" style="padding:6px 12px;">
                <i class="fas fa-play"></i> 立即运行
            </button>
        </div>
        <div class="content-placeholder" style="text-align:center;color:#ccc;padding:20px;">加载中...</div>
        <!-- 动态内容容器 -->
        <div class="stats-content" style="display:none;">
            <div class="stat-row"><span>状态</span> <span class="stat-val st-pill">--</span></div>
            <div class="stat-row"><span>最近执行</span> <span class="stat-val time">--</span></div>
            <div class="stat-row"><span>耗时</span> <span class="stat-val duration">--</span></div>
            <div class="progress-bg">
                <div class="progress-bar bg-success" style="width:0%"></div>
                <div class="progress-bar bg-danger" style="width:0%"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; color:#64748b;">
                <span class="success-count">0 成功</span>
                <span class="fail-count">0 失败</span>
            </div>
        </div>
    </div>

    <!-- Daily Sync 概览 -->
    <div class="card" id="cardDaily">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon icon-blue"><i class="fas fa-calendar-day"></i></div>
                Daily Sync
            </div>
            <button class="btn btn-primary" onclick="runSync('DAILY_SYNC', this)" style="padding:6px 12px;">
                <i class="fas fa-play"></i> 立即运行
            </button>
        </div>
        <div class="content-placeholder" style="text-align:center;color:#ccc;padding:20px;">加载中...</div>
        <div class="stats-content" style="display:none;">
            <div class="stat-row"><span>状态</span> <span class="stat-val st-pill">--</span></div>
            <div class="stat-row"><span>最近执行</span> <span class="stat-val time">--</span></div>
            <div class="stat-row"><span>耗时</span> <span class="stat-val duration">--</span></div>
            <div class="progress-bg">
                <div class="progress-bar bg-success" style="width:0%"></div>
                <div class="progress-bar bg-danger" style="width:0%"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; color:#64748b;">
                <span class="success-count">0 成功</span>
                <span class="fail-count">0 失败</span>
            </div>
        </div>
    </div>
</div>

<!-- 任务历史表格 -->
<div class="table-card">
    <div class="toolbar">
        <div style="font-weight:600;font-size:15px;">任务执行记录</div>
        <button class="btn btn-outline" onclick="loadJobs(1)">
            <i class="fas fa-sync-alt" id="refreshIcon"></i> 刷新
        </button>
    </div>
    <table>
        <thead>
        <tr>
            <th style="width:60px">ID</th>
            <th>任务类型</th>
            <th>触发方式</th>
            <th>状态</th>
            <th>开始时间 / 耗时</th>
            <th>执行结果 (总/成/败)</th>
            <th style="text-align:right">操作</th>
        </tr>
        </thead>
        <tbody id="jobTableBody">
        <tr><td colspan="7" style="text-align:center;padding:30px;color:#94a3b8;">加载中...</td></tr>
        </tbody>
    </table>

    <!-- 分页 -->
    <div class="pagination-footer">
        <div class="page-desc">
            第 <span id="currPage" style="font-weight:600;color:#0f172a">1</span> 页 / 共 <span id="totalPage">1</span> 页，总计 <span id="totalCount">0</span> 条
        </div>
        <div class="pg-container" id="pagination">
            <!-- JS Rendered -->
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
        const API_BASE = /*[[@{/api/admin}]]*/ '/api/admin';
        const PAGE_SIZE = 6;
        let currentPage = 1;

        $(document).ready(function() {
            initSchedulerStatus();
            loadOverview();
            loadJobs(1);
        });

        // --- 1. 调度器状态 ---
        function initSchedulerStatus() {
            $.get(`${API_BASE}/schedule/status`, function(res) {
                if(res.code === 200) {
                    const enabled = res.data; // true/false
                    $('#scheduleToggle').prop('checked', enabled);
                    updateScheduleText(enabled);
                }
            });
        }

        function toggleSchedule() {
            const enabled = $('#scheduleToggle').prop('checked');
            updateScheduleText(enabled);
            $.post(`${API_BASE}/schedule/enable?enabled=${enabled}`, function(res) {
                if(res.code === 200) showToast('success', enabled ? '调度服务已开启' : '调度服务已停止');
                else showToast('error', res.msg);
            });
        }

        function updateScheduleText(enabled) {
            const txt = $('#scheduleText');
            if(enabled) txt.text('运行中').addClass('active');
            else txt.text('已停止').removeClass('active');
        }

        // --- 2. 概览卡片 ---
        function loadOverview() {
            $.get(`${API_BASE}/sync/overview?limit=1`, function(res) {
                if(res.code === 200) {
                    renderCard('#cardRating', res.data.latestRating);
                    renderCard('#cardDaily', res.data.latestDaily);
                }
            });
        }

        function renderCard(selector, job) {
            const $card = $(selector);
            $card.find('.content-placeholder').hide();
            const $content = $card.find('.stats-content').fadeIn();

            if(!job) {
                $content.html('<div style="text-align:center;color:#94a3b8;padding:10px;">暂无记录</div>');
                return;
            }

            const successRate = job.totalCount > 0 ? (job.successCount / job.totalCount * 100) : 0;
            const failRate = job.totalCount > 0 ? (job.failCount / job.totalCount * 100) : 0;

            // 状态徽标
            let statusHtml = '';
            if(job.status === 'SUCCESS') statusHtml = '<span class="status-pill st-success">成功</span>';
            else if(job.status === 'RUNNING') statusHtml = '<span class="status-pill st-running">运行中</span>';
            else statusHtml = '<span class="status-pill st-fail">失败</span>';

            $content.find('.st-pill').html(statusHtml);
            $content.find('.time').text(formatTime(job.startTime));
            $content.find('.duration').text((job.durationMs / 1000).toFixed(1) + 's');
            $content.find('.bg-success').css('width', successRate + '%');
            $content.find('.bg-danger').css('width', failRate + '%');
            $content.find('.success-count').text(`${job.successCount} 成功`);
            $content.find('.fail-count').text(`${job.failCount} 失败`);
        }

        // --- 3. 任务列表 ---
        function loadJobs(page) {
            $('#refreshIcon').addClass('spin');
            $.get(`${API_BASE}/sync/jobs`, {page: page, pageSize: PAGE_SIZE}, function(res) {
                $('#refreshIcon').removeClass('spin');
                if(res.code === 200) {
                    renderTable(res.data.list);
                    renderPagination(res.data.total, page);
                    currentPage = page;
                    $('#totalCount').text(res.data.total);
                    $('#currPage').text(page);
                    $('#totalPage').text(Math.ceil(res.data.total/PAGE_SIZE)||1);
                }
            }).fail(() => $('#refreshIcon').removeClass('spin'));
        }

        function renderTable(list) {
            const tbody = $('#jobTableBody');
            tbody.empty();

            if(!list || list.length === 0) {
                tbody.html('<tr><td colspan="7" style="text-align:center;padding:20px;color:#94a3b8">暂无数据</td></tr>');
                return;
            }

            list.forEach(item => {
                const statusClass = item.status==='SUCCESS'?'st-success':(item.status==='RUNNING'?'st-running':'st-fail');
                const timeStr = item.startTime.replace('T', ' ').substring(0, 19);
                const duration = (item.durationMs / 1000).toFixed(1) + 's';

                // 结果详情
                const summary = `${item.totalCount} / <span style="color:#166534">${item.successCount}</span> / <span style="color:#991b1b">${item.failCount}</span>`;

                let actionBtn = '';
                if(item.failCount > 0 && item.status !== 'RUNNING') {
                    actionBtn = `<button class="btn btn-rerun" onclick="rerunFailures(${item.id})"><i class="fas fa-redo"></i> 重跑失败</button>`;
                }

                const tr = `
                    <tr>
                        <td style="color:#64748b;font-family:monospace;">${item.id}</td>
                        <td style="font-weight:600;">${item.jobType}</td>
                        <td>${item.triggerSource}</td>
                        <td><span class="status-pill ${statusClass}">${item.status}</span></td>
                        <td>
                            <div style="font-size:12px;">${timeStr}</div>
                            <div style="font-size:11px;color:#64748b;">耗时: ${duration}</div>
                        </td>
                        <td style="font-family:monospace; font-size:13px;">${summary}</td>
                        <td style="text-align:right;">${actionBtn}</td>
                    </tr>
                `;
                tbody.append(tr);
            });
        }

        function renderPagination(total, curr) {
            const totalPages = Math.ceil(total / PAGE_SIZE) || 1;
            const $pg = $('#pagination');
            $pg.empty();

            const btn = (p, icon, dis) => `<button class="pg-btn ${p===curr?'active':''}" onclick="loadJobs(${p})" ${dis?'disabled':''}>${icon}</button>`;

            $pg.append(btn(curr-1, '<i class="fas fa-chevron-left"></i>', curr<=1));

            if (totalPages <= 7) {
                for(let i=1; i<=totalPages; i++) $pg.append(btn(i, i, false));
            } else {
                if(curr <= 4) {
                    for(let i=1; i<=5; i++) $pg.append(btn(i, i, false));
                    $pg.append('<span style="padding:0 5px;color:#94a3b8;display:flex;align-items:center;">...</span>');
                    $pg.append(btn(totalPages, totalPages, false));
                } else if (curr >= totalPages - 3) {
                    $pg.append(btn(1, 1, false));
                    $pg.append('<span style="padding:0 5px;color:#94a3b8;display:flex;align-items:center;">...</span>');
                    for(let i=totalPages-4; i<=totalPages; i++) $pg.append(btn(i, i, false));
                } else {
                    $pg.append(btn(1, 1, false));
                    $pg.append('<span style="padding:0 5px;color:#94a3b8;display:flex;align-items:center;">...</span>');
                    for(let i=curr-1; i<=curr+1; i++) $pg.append(btn(i, i, false));
                    $pg.append('<span style="padding:0 5px;color:#94a3b8;display:flex;align-items:center;">...</span>');
                    $pg.append(btn(totalPages, totalPages, false));
                }
            }

            $pg.append(btn(curr+1, '<i class="fas fa-chevron-right"></i>', curr>=totalPages));
        }

        // --- 4. 操作动作 ---
        function runSync(type, btn) {
            if(!confirm('确定要手动触发该同步任务吗？这可能需要一些时间。')) return;

            const $btn = $(btn);
            const originalHtml = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner spin"></i> 请求中');

            $.post(`${API_BASE}/sync/run?jobType=${type}`, function(res) {
                setTimeout(() => $btn.prop('disabled', false).html(originalHtml), 2000);
                if(res.code === 200) {
                    showToast('success', '任务已提交，ID: ' + res.data);
                    loadOverview(); // 刷新卡片
                    setTimeout(() => loadJobs(1), 1000); // 稍后刷新列表
                } else {
                    showToast('error', res.msg);
                }
            });
        }

        function rerunFailures(jobId) {
            if(!confirm(`确定要重跑任务 #${jobId} 中的失败用户吗？`)) return;
            $.post(`${API_BASE}/sync/rerun?jobId=${jobId}`, function(res) {
                if(res.code === 200) {
                    showToast('success', '重跑任务已启动');
                    loadJobs(1);
                } else {
                    showToast('error', res.msg);
                }
            });
        }

        function formatTime(t) {
            if(!t) return '-';
            const date = new Date(t);
            const now = new Date();
            const diff = (now - date) / 1000;

            if(diff < 60) return '刚刚';
            if(diff < 3600) return Math.floor(diff/60) + '分钟前';
            return t.replace('T', ' ').substring(5, 16);
        }

        function showToast(type, msg) {
            const t = $('#toast');
            t.text(msg).css('background', type==='success'?'#10b981':'#ef4444').fadeIn().delay(3000).fadeOut();
        }
    /*]]>*/
</script>
</body>
</html>