<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        success: '#10b981', // Emerald-500
                        danger: '#ef4444', // Red-500
                        warning: '#f59e0b', // Amber-500
                        info: '#3b82f6', // Blue-500
                        dark: '#0f172a', // Slate-900
                        graytext: '#64748b', // Slate-500
                        bg: '#f1f5f9', // Slate-100
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-bg text-dark font-poppins min-h-screen p-4 md:p-6 overflow-y-auto">

<div class="max-w-7xl mx-auto space-y-6">

    <!-- 顶部工具栏 -->
    <div class="bg-white rounded-xl shadow-soft border border-slate-200 p-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <!-- 左侧：标题与统计 -->
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                <i class="fas fa-users"></i>
            </div>
            <div>
                <!-- 已移除重复的标题 -->
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                    <span class="text-sm font-medium text-slate-600" id="totalCountBadge">加载中...</span>
                </div>
            </div>
        </div>

        <!-- 右侧：筛选与搜索 -->
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <!-- 状态筛选 -->
            <div class="relative min-w-[140px]">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                    <i class="fas fa-filter text-xs"></i>
                </div>
                <select id="statusSelect" onchange="handleSearch()" class="appearance-none bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary block w-full pl-9 pr-8 py-2.5 outline-none cursor-pointer hover:bg-white transition-all shadow-sm">
                    <option value="">所有状态</option>
                    <option value="1">正常</option>
                    <option value="0">封禁</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                    <i class="fas fa-chevron-down text-[10px]"></i>
                </div>
            </div>

            <!-- 搜索框 -->
            <div class="relative w-full sm:w-64 group">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400 group-focus-within:text-primary transition-colors">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" id="searchInput"
                       class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm text-dark placeholder-slate-400 focus:outline-none focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all shadow-sm"
                       placeholder="搜索学号或昵称..."
                       onkeyup="handleSearchDebounced()">
            </div>
        </div>
    </div>

    <!-- 表格区域 -->
    <div class="bg-white rounded-xl shadow-soft border border-slate-200 overflow-hidden flex flex-col min-h-[500px]">
        <div class="overflow-x-auto w-full flex-1">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50/80 sticky top-0 z-10 backdrop-blur-sm">
                <tr class="text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                    <th class="px-6 py-4 w-20">ID</th>
                    <th class="px-6 py-4 min-w-[240px]">用户信息 (User Info)</th>
                    <th class="px-6 py-4 w-32">角色</th>
                    <th class="px-6 py-4 w-32">状态</th>
                    <th class="px-6 py-4 w-40">注册时间</th>
                    <th class="px-6 py-4 text-center w-48">操作</th>
                </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-100 bg-white">
                <tr>
                    <td colspan="6" class="px-6 py-20 text-center text-graytext">
                        <div class="flex flex-col items-center gap-3 animate-pulse">
                            <i class="fas fa-circle-notch fa-spin text-2xl text-primary/30"></i>
                            <span class="text-sm">数据加载中...</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页组件 -->
        <div class="mt-auto border-t border-slate-100 px-6 py-4 bg-white flex flex-col sm:flex-row justify-between items-center gap-4" id="paginationContainer" style="display:none;">
            <div class="text-xs text-slate-400 font-medium" id="pageInfo"></div>
            <div class="flex items-center gap-1.5" id="pagination"></div>
        </div>
    </div>

</div>

<!-- === 编辑弹窗 === -->
<div id="editModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- 背景遮罩 -->
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop" onclick="closeModal('editModal')"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-md scale-95 opacity-0" id="modalPanel">

                <!-- Header -->
                <div class="bg-white px-6 py-5 border-b border-slate-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                            <i class="fas fa-user-edit text-xs"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">编辑用户</h3>
                    </div>
                    <button type="button" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full w-8 h-8 flex items-center justify-center transition-all" onclick="closeModal('editModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="px-6 py-6 bg-slate-50/50">
                    <form id="editForm" class="space-y-5">
                        <input type="hidden" id="editUserId">

                        <!-- 学号 (Read-only) -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">学号 / Student No.</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                                    <i class="fas fa-id-card"></i>
                                </div>
                                <input type="text" id="editStudentNo" disabled
                                       class="w-full pl-10 pr-3 py-2.5 bg-slate-100 border border-slate-200 rounded-lg text-sm text-slate-500 cursor-not-allowed font-mono shadow-sm">
                            </div>
                        </div>

                        <!-- 昵称 -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">昵称 / Nickname</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400 group-focus-within:text-primary transition-colors">
                                    <i class="fas fa-user-tag"></i>
                                </div>
                                <input type="text" id="editNickname" placeholder="请输入新昵称"
                                       class="w-full pl-10 pr-3 py-2.5 bg-white border border-slate-200 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all shadow-sm">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer -->
                <div class="bg-white px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100">
                    <button type="button" onclick="submitEdit()" class="inline-flex justify-center rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-white shadow-sm shadow-indigo-200 hover:bg-primary/90 transition-all active:scale-95">保存修改</button>
                    <button type="button" onclick="closeModal('editModal')" class="inline-flex justify-center rounded-lg bg-white border border-slate-200 px-5 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === 全局变量 ===
    let currentPage = 1;
    const pageSize = 10;
    let searchTimeout;

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers(1);
    });

    // 1. 加载用户列表
    function loadUsers(page) {
        currentPage = page;
        const tbody = document.getElementById('tableBody');
        const badge = document.getElementById('totalCountBadge');

        // 获取查询参数
        const status = document.getElementById('statusSelect').value;
        const keyword = document.getElementById('searchInput').value.trim();

        axios.get('/api/admin/users', {
            params: {
                page: page,
                size: pageSize,
                keyword: keyword,
                status: status
            }
        })
            .then(res => {
                if(res.data.code === 200) {
                    const data = res.data.data;
                    renderTable(data.records);
                    renderPagination(data.total, data.pages, data.current);

                    // 更新总数 Badge
                    if(badge) badge.textContent = `共 ${data.total} 人`;

                    document.getElementById('paginationContainer').style.display = 'flex';
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-danger">加载失败: ${res.data.msg}</td></tr>`;
                    badge.textContent = '数据加载失败';
                }
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 flex flex-col items-center gap-2"><i class="fas fa-exclamation-triangle"></i><span>网络错误，请稍后重试</span></td></tr>`;
            });
    }

    // 2. 渲染表格
    function renderTable(users) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if(!users || users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-20 text-center">
                        <div class="flex flex-col items-center gap-3 text-slate-400">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-search text-2xl opacity-40"></i>
                            </div>
                            <span class="text-sm font-medium">未找到匹配的用户</span>
                            <span class="text-xs text-slate-300">尝试更换搜索关键词</span>
                        </div>
                    </td>
                </tr>`;
            return;
        }

        users.forEach(user => {
            const avatarUrl = `https://ui-avatars.com/api/?name=${user.username}&background=random&color=fff&size=64`;
            const isBanned = user.status === 0;

            const statusBadge = isBanned
                ? `<div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-600 border border-red-100">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-20"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                    </span>
                    已封禁
                   </div>`
                : `<div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> 正常
                   </div>`;

            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-none group";

            tr.innerHTML = `
                    <td class="px-6 py-4">
                        <span class="text-xs text-slate-400 font-mono">#${user.id}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-4">
                            <div class="relative shrink-0">
                                <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover border border-slate-100 shadow-sm bg-white" alt="av">
                                ${isBanned ? '<div class="absolute -bottom-1 -right-1 bg-red-500 border-2 border-white w-4 h-4 rounded-full flex items-center justify-center"><i class="fas fa-ban text-[8px] text-white"></i></div>' : ''}
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-sm font-bold text-slate-700 truncate group-hover:text-primary transition-colors">${user.nickname || user.username}</span>
                                <span class="text-xs text-slate-400 font-mono truncate bg-slate-100 px-1.5 py-0.5 rounded w-fit mt-0.5">${user.studentNo}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1.5 px-2 py-1 bg-slate-100 text-slate-600 text-xs font-medium rounded border border-slate-200">
                            <i class="fas fa-user-tag text-[10px] text-slate-400"></i> ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-slate-600 font-mono">${formatDate(user.createdAt)}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-center gap-2">
                            <button class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 bg-white border border-slate-200 hover:border-primary hover:bg-primary/5 hover:text-primary transition-all shadow-sm"
                                    title="编辑信息" onclick="openEditModal(${user.id}, '${user.studentNo}', '${user.nickname || ''}')">
                                <i class="fas fa-pen text-xs"></i>
                            </button>

                            <button class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 bg-white border border-slate-200 hover:border-warning hover:bg-warning/5 hover:text-warning transition-all shadow-sm"
                                    title="重置密码" onclick="resetPassword(${user.id}, '${user.username}')">
                                <i class="fas fa-key text-xs"></i>
                            </button>

                            ${isBanned
                ? `<button class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 bg-white border border-slate-200 hover:border-success hover:bg-success/5 hover:text-success transition-all shadow-sm" title="解封" onclick="toggleStatus(${user.id}, 1)"><i class="fas fa-unlock text-xs"></i></button>`
                : `<button class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 bg-white border border-slate-200 hover:border-danger hover:bg-danger/5 hover:text-danger transition-all shadow-sm" title="封禁" onclick="toggleStatus(${user.id}, 0)"><i class="fas fa-ban text-xs"></i></button>`
            }
                        </div>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    // 3. 渲染分页 (样式统一)
    function renderPagination(total, totalPages, current) {
        const info = document.getElementById('pageInfo');
        const container = document.getElementById('pagination');

        const startRecord = (current - 1) * pageSize + 1;
        const endRecord = Math.min(current * pageSize, total);

        info.textContent = `显示 ${startRecord} - ${endRecord} / 共 ${total}`;

        let html = '';
        const btnBase = "w-8 h-8 flex items-center justify-center rounded-lg text-xs font-semibold transition-all border ml-1";
        const activeClass = "bg-primary border-primary text-white shadow-sm shadow-indigo-200";
        const normalClass = "bg-white border-slate-200 text-slate-600 hover:text-primary hover:border-primary hover:bg-primary/5";
        const disabledClass = "bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed";

        html += `<button class="${btnBase} ${current === 1 ? disabledClass : normalClass}" ${current === 1 ? 'disabled' : ''} onclick="loadUsers(${current - 1})"><i class="fas fa-chevron-left"></i></button>`;

        const renderPageBtn = (i) => `<button class="${btnBase} ${i === current ? activeClass : normalClass}" onclick="loadUsers(${i})">${i}</button>`;
        const dots = `<span class="w-8 h-8 flex items-center justify-center text-slate-300 text-[10px]">...</span>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) html += renderPageBtn(i);
        } else {
            html += renderPageBtn(1);
            if (current > 3) html += dots;
            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) html += renderPageBtn(i);
            if (current < totalPages - 2) html += dots;
            html += renderPageBtn(totalPages);
        }

        html += `<button class="${btnBase} ${current === totalPages ? disabledClass : normalClass}" ${current === totalPages ? 'disabled' : ''} onclick="loadUsers(${current + 1})"><i class="fas fa-chevron-right"></i></button>`;

        container.innerHTML = html;
    }

    // 4. 搜索处理
    function handleSearch() {
        loadUsers(1);
    }

    function handleSearchDebounced() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadUsers(1);
        }, 500);
    }

    // === 业务操作与模态框 ===

    function openEditModal(id, studentNo, nickname) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editStudentNo').value = studentNo;
        document.getElementById('editNickname').value = nickname;

        const modal = document.getElementById('editModal');
        const backdrop = document.getElementById('modalBackdrop');
        const panel = document.getElementById('modalPanel');

        modal.classList.remove('hidden');
        // 动画
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        const backdrop = document.getElementById('modalBackdrop');
        const panel = document.getElementById('modalPanel');

        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function submitEdit() {
        const id = document.getElementById('editUserId').value;
        const nickname = document.getElementById('editNickname').value;

        if(!nickname) {
            Swal.fire({
                title: '提示',
                text: '昵称不能为空',
                icon: 'warning',
                confirmButtonColor: '#4e54c8',
                confirmButtonText: '知道了'
            });
            return;
        }

        axios.put(`/api/admin/users/${id}/nickname`, { nickname: nickname })
            .then(res => {
                if(res.data.code === 200) {
                    closeModal('editModal');
                    Swal.fire({
                        icon: 'success', title: '修改成功', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
                    });
                    loadUsers(currentPage);
                } else {
                    Swal.fire('失败', res.data.msg, 'error');
                }
            });
    }

    function toggleStatus(id, newStatus) {
        const actionText = newStatus === 1 ? '解封' : '封禁';
        const confirmColor = newStatus === 1 ? '#10b981' : '#ef4444';
        const iconHtml = newStatus === 1 ? '<i class="fas fa-unlock text-4xl text-emerald-500 mb-2"></i>' : '<i class="fas fa-ban text-4xl text-red-500 mb-2"></i>';

        Swal.fire({
            html: `
                <div class="flex flex-col items-center">
                    ${iconHtml}
                    <h3 class="text-lg font-bold text-slate-700">确定要${actionText}该用户吗？</h3>
                    <p class="text-sm text-slate-500 mt-1">此操作将立即生效。</p>
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: confirmColor,
            cancelButtonColor: '#94a3b8',
            confirmButtonText: `确认${actionText}`,
            cancelButtonText: '取消',
            customClass: {
                popup: 'rounded-2xl',
                confirmButton: 'rounded-lg px-6',
                cancelButton: 'rounded-lg px-6'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                axios.put(`/api/admin/users/${id}/status`, { status: newStatus })
                    .then(res => {
                        if(res.data.code === 200) {
                            Swal.fire({ icon: 'success', title: `用户已${actionText}`, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                            loadUsers(currentPage);
                        } else {
                            Swal.fire('失败', res.data.msg, 'error');
                        }
                    });
            }
        });
    }

    function resetPassword(id, username) {
        Swal.fire({
            html: `
                <div class="flex flex-col items-center">
                    <i class="fas fa-key text-4xl text-amber-400 mb-2"></i>
                    <h3 class="text-lg font-bold text-slate-700">重置密码</h3>
                    <p class="text-sm text-slate-500 mt-1">用户 [${username}] 的密码将重置为默认值。</p>
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: '确认重置',
            cancelButtonText: '取消',
            customClass: {
                popup: 'rounded-2xl',
                confirmButton: 'rounded-lg px-6',
                cancelButton: 'rounded-lg px-6'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                axios.put(`/api/admin/users/${id}/reset-password`)
                    .then(res => {
                        if(res.data.code === 200) {
                            Swal.fire({ icon: 'success', title: '密码已重置', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                        } else {
                            Swal.fire('失败', res.data.msg, 'error');
                        }
                    });
            }
        });
    }

    function formatDate(isoStr) {
        if(!isoStr) return '-';
        const d = new Date(isoStr);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

</script>
</body>
</html>