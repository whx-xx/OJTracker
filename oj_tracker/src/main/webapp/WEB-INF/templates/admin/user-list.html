<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --text-dark: #34495e;
            --text-light: #7f8c8d;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            padding: 20px;
            color: var(--text-dark);
            overflow-y: auto;
        }

        /* === 顶部工具栏 (筛选+搜索) === */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        /* 下拉框样式 */
        .form-select {
            padding: 10px 35px 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            color: var(--text-dark);
            background-color: white;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            appearance: none; /* 移除默认箭头 */
            cursor: pointer;
            min-width: 140px;
            transition: all 0.3s;
        }

        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.1);
        }

        /* 搜索框样式 */
        .search-wrapper {
            position: relative;
            width: 100%;
            max-width: 300px;
        }

        .search-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            background: white;
            transition: all 0.3s;
            font-size: 14px;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.1);
        }

        /* === 卡片与表格 === */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .table-responsive {
            overflow-x: auto;
            width: 100%;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #f8fafc;
            border-bottom: 2px solid var(--border-color);
        }

        th {
            text-align: left;
            padding: 15px 20px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: middle;
            color: var(--text-dark);
        }

        tbody tr:hover {
            background-color: #fcfcfc;
        }

        /* 用户信息列 */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #eee;
        }

        .user-details div {
            line-height: 1.2;
        }

        .user-nick {
            font-weight: 500;
            color: var(--text-dark);
        }

        .user-no {
            font-size: 12px;
            color: var(--text-light);
        }

        /* 状态标签 */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-active { background: rgba(46, 204, 113, 0.15); color: var(--success-color); }
        .status-banned { background: rgba(231, 76, 60, 0.15); color: var(--danger-color); }

        /* 操作按钮组 */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .btn-edit { background-color: var(--secondary-color); }
        .btn-edit:hover { background-color: var(--primary-color); }

        .btn-key { background-color: var(--warning-color); }
        .btn-key:hover { background-color: #d35400; }

        .btn-ban { background-color: var(--danger-color); }
        .btn-ban:hover { background-color: #c0392b; }

        .btn-unban { background-color: var(--success-color); }
        .btn-unban:hover { background-color: #27ae60; }

        /* === 分页组件 (与 Rankings 一致) === */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #fff;
            border-top: 1px solid #f0f0f0;
        }

        .pagination-info {
            font-size: 13px;
            color: var(--text-light);
        }

        .page-btn {
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-dark);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            background-color: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        /* === 模态框样式 === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .custom-modal {
            background: white;
            width: 400px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            padding: 25px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .custom-modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 { font-size: 18px; font-weight: 600; margin: 0; }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-dark); }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            outline: none;
        }
        .form-group input:focus { border-color: var(--primary-color); }

        .modal-footer {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #666;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-confirm {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- 顶部筛选工具栏 -->
<div class="toolbar">
    <div class="filter-group">
        <!-- 状态筛选 -->
        <select id="statusSelect" class="form-select" onchange="handleSearch()">
            <option value="">所有状态</option>
            <option value="1">正常</option>
            <option value="0">封禁</option>
        </select>

        <!-- 模糊搜索 -->
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="搜索学号或昵称..." onkeyup="handleSearchDebounced()">
        </div>
    </div>
</div>

<!-- 表格卡片 -->
<div class="card">
    <div class="table-responsive">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>用户信息</th>
                <th>角色</th>
                <th>状态</th>
                <th>注册时间</th>
                <th style="text-align: right;">操作</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr><td colspan="6" style="text-align:center;padding:40px;color:#999;"><i class="fas fa-spinner fa-spin"></i> 加载中...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- 分页组件 -->
    <div class="pagination-container" id="paginationContainer" style="display:none;">
        <div class="pagination-info" id="pageInfo"></div>
        <div id="pagination" style="display:flex;"></div>
    </div>
</div>

<!-- === 编辑弹窗 === -->
<div class="modal-overlay" id="editModal">
    <div class="custom-modal">
        <div class="modal-header">
            <h3 id="modalTitle">编辑用户</h3>
            <button class="close-modal" onclick="closeModal('editModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>学号</label>
                    <input type="text" id="editStudentNo" disabled style="background:#f5f5f5; cursor:not-allowed;">
                </div>
                <div class="form-group">
                    <label>昵称</label>
                    <input type="text" id="editNickname" placeholder="请输入新昵称">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('editModal')">取消</button>
            <button class="btn-confirm" onclick="submitEdit()">保存修改</button>
        </div>
    </div>
</div>

<script>
    // === 全局变量 ===
    let currentPage = 1;
    const pageSize = 15;
    let searchTimeout;

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers(1);
    });

    // 1. 加载用户列表
    function loadUsers(page) {
        currentPage = page;
        const tbody = document.getElementById('tableBody');

        // 获取查询参数
        const status = document.getElementById('statusSelect').value;
        const keyword = document.getElementById('searchInput').value.trim();

        axios.get('/api/admin/users', {
            params: {
                page: page,
                size: pageSize,
                keyword: keyword,
                status: status // 传递状态参数
            }
        })
            .then(res => {
                if(res.data.code === 200) {
                    const data = res.data.data;
                    renderTable(data.records);
                    renderPagination(data.total, data.pages, data.current);

                    document.getElementById('paginationContainer').style.display = 'flex';
                } else {
                    Swal.fire('错误', res.data.msg, 'error');
                }
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;padding:30px;">加载失败</td></tr>`;
            });
    }

    // 2. 渲染表格
    function renderTable(users) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if(!users || users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">未找到匹配的用户</td></tr>`;
            return;
        }

        users.forEach(user => {
            const avatarUrl = `https://ui-avatars.com/api/?name=${user.username}&background=random&color=fff&size=64`;
            const isBanned = user.status === 0;

            const statusBadge = isBanned
                ? `<span class="status-badge status-banned"><i class="fas fa-ban"></i> 已封禁</span>`
                : `<span class="status-badge status-active">正常</span>`;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td>#${user.id}</td>
                    <td>
                        <div class="user-cell">
                            <img src="${avatarUrl}" class="user-avatar" alt="av">
                            <div class="user-details">
                                <div class="user-nick">${user.nickname || user.username}</div>
                                <div class="user-no">${user.studentNo}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.role}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-edit" title="编辑信息" onclick="openEditModal(${user.id}, '${user.studentNo}', '${user.nickname || ''}')">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="btn-icon btn-key" title="重置密码" onclick="resetPassword(${user.id}, '${user.username}')">
                                <i class="fas fa-key"></i>
                            </button>
                            ${isBanned
                ? `<button class="btn-icon btn-unban" title="解封" onclick="toggleStatus(${user.id}, 1)"><i class="fas fa-check"></i></button>`
                : `<button class="btn-icon btn-ban" title="封禁" onclick="toggleStatus(${user.id}, 0)"><i class="fas fa-ban"></i></button>`
            }
                        </div>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    // 3. 渲染分页 (样式与 Rankings 一致)
    function renderPagination(total, totalPages, current) {
        const info = document.getElementById('pageInfo');
        const container = document.getElementById('pagination');

        const startRecord = (current - 1) * pageSize + 1;
        const endRecord = Math.min(current * pageSize, total);

        info.textContent = `第 ${startRecord}-${endRecord} 条 / 共 ${total} 条`;

        let html = '';
        html += `<button class="page-btn" ${current === 1 ? 'disabled' : ''} onclick="loadUsers(${current - 1})"><i class="fas fa-chevron-left"></i></button>`;

        // 简单逻辑：首页...当前页...尾页
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) html += pageBtn(i, current);
        } else {
            html += pageBtn(1, current);
            if (current > 3) html += `<span style="line-height:28px; padding:0 5px; color:#ccc;">...</span>`;

            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) html += pageBtn(i, current);

            if (current < totalPages - 2) html += `<span style="line-height:28px; padding:0 5px; color:#ccc;">...</span>`;
            html += pageBtn(totalPages, current);
        }

        html += `<button class="page-btn" ${current === totalPages ? 'disabled' : ''} onclick="loadUsers(${current + 1})"><i class="fas fa-chevron-right"></i></button>`;

        container.innerHTML = html;
    }

    function pageBtn(i, current) {
        return `<button class="page-btn ${i === current ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
    }

    // 4. 搜索处理 (立即搜索 + 防抖)
    function handleSearch() {
        loadUsers(1);
    }

    function handleSearchDebounced() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadUsers(1);
        }, 500);
    }

    // === 业务操作 ===

    function openEditModal(id, studentNo, nickname) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editStudentNo').value = studentNo;
        document.getElementById('editNickname').value = nickname;
        document.getElementById('editModal').classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    function submitEdit() {
        const id = document.getElementById('editUserId').value;
        const nickname = document.getElementById('editNickname').value;

        if(!nickname) {
            Swal.fire('提示', '昵称不能为空', 'warning');
            return;
        }

        axios.put(`/api/admin/users/${id}/nickname`, { nickname: nickname })
            .then(res => {
                if(res.data.code === 200) {
                    closeModal('editModal');
                    Swal.fire({
                        icon: 'success', title: '修改成功', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
                    });
                    loadUsers(currentPage);
                } else {
                    Swal.fire('失败', res.data.msg, 'error');
                }
            });
    }

    function toggleStatus(id, newStatus) {
        const actionText = newStatus === 1 ? '解封' : '封禁';
        const color = newStatus === 1 ? '#2ecc71' : '#e74c3c';

        Swal.fire({
            title: `确定要${actionText}该用户吗？`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: color,
            cancelButtonColor: '#95a5a6',
            confirmButtonText: `是的，${actionText}`,
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                axios.put(`/api/admin/users/${id}/status`, { status: newStatus })
                    .then(res => {
                        if(res.data.code === 200) {
                            Swal.fire('已完成', `用户已${actionText}`, 'success');
                            loadUsers(currentPage);
                        } else {
                            Swal.fire('失败', res.data.msg, 'error');
                        }
                    });
            }
        });
    }

    function resetPassword(id, username) {
        Swal.fire({
            title: '重置密码',
            text: `用户 [${username}] 的密码将重置为默认值。`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f1c40f',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: '确认重置'
        }).then((result) => {
            if (result.isConfirmed) {
                axios.put(`/api/admin/users/${id}/reset-password`)
                    .then(res => {
                        if(res.data.code === 200) {
                            Swal.fire('成功', '密码已重置', 'success');
                        } else {
                            Swal.fire('失败', res.data.msg, 'error');
                        }
                    });
            }
        });
    }

    function formatDate(isoStr) {
        if(!isoStr) return '-';
        const d = new Date(isoStr);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

</script>
</body>
</html>