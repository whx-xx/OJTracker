<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        success: '#2ecc71',
                        warning: '#f1c40f',
                        error: '#e74c3c', // 对应原 danger-color
                        dark: '#34495e',
                        graytext: '#7f8c8d',
                        bg: '#f1f5f9',
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    keyframes: {
                        spin: {
                            'to': { transform: 'rotate(360deg)' }
                        }
                    },
                    animation: {
                        spin: 'spin 1s linear infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg p-5 text-dark overflow-y-auto font-poppins">

<!-- 全局 Tooltip -->
<div id="global-tooltip" class="fixed bg-gray-900/95 text-white py-2 px-3 rounded-md text-xs pointer-events-none z-[9999] opacity-0 transition-opacity duration-150 shadow-lg font-medium border border-white/10 whitespace-nowrap top-0 left-0"></div>

<!-- 欢迎 Banner -->
<div class="bg-gradient-to-br from-[#667eea] to-[#764ba2] rounded-xl p-8 text-white shadow-lg mb-6 flex justify-between items-center relative overflow-hidden">
    <!-- 装饰背景 -->
    <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/3 pointer-events-none"></div>

    <div class="welcome-text relative z-10">
        <h1 id="welcomeUser" class="text-2xl font-semibold mb-2">欢迎回来!</h1>
        <p class="text-white/90 text-sm">Roots change, but the tree stands strong — so should your logic.</p>
    </div>

    <button class="relative z-10 bg-white/20 border border-white/40 text-white py-2 px-5 rounded-full cursor-pointer transition-all duration-300 hover:bg-white/30 hover:-translate-y-0.5 flex items-center gap-2 text-sm group" onclick="triggerSync()">
        <i class="fas fa-sync-alt transition-transform" id="syncIcon"></i>
        <span id="syncText">同步数据</span>
    </button>
</div>

<!-- 统计卡片网格 -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
    <!-- 卡片 1 -->
    <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-50 flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl mr-4 shrink-0 bg-primary/10 text-primary">
            <i class="fas fa-check-double"></i>
        </div>
        <div class="stat-info">
            <h3 id="valSolved" class="text-2xl font-semibold text-dark mb-0.5">--</h3>
            <p class="text-graytext text-xs font-medium">总解题数</p>
        </div>
    </div>

    <!-- 卡片 2 -->
    <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-50 flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl mr-4 shrink-0 bg-success/10 text-success">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
            <h3 id="valRating" class="text-2xl font-semibold text-dark mb-0.5">--</h3>
            <p class="text-graytext text-xs font-medium">当前 Rating</p>
        </div>
    </div>

    <!-- 卡片 3 -->
    <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-50 flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl mr-4 shrink-0 bg-warning/10 text-warning">
            <i class="fas fa-calendar-week"></i>
        </div>
        <div class="stat-info">
            <h3 id="valWeeklySolved" class="text-2xl font-semibold text-dark mb-0.5">--</h3>
            <p class="text-graytext text-xs font-medium">本周解题</p>
        </div>
    </div>

    <!-- 卡片 4 -->
    <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-50 flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl mr-4 shrink-0 bg-error/10 text-error">
            <i class="fas fa-fire"></i>
        </div>
        <div class="stat-info">
            <h3 id="valActiveDays" class="text-2xl font-semibold text-dark mb-0.5">--</h3>
            <p class="text-graytext text-xs font-medium">活跃天数</p>
        </div>
    </div>
</div>

<!-- 热力图卡片 -->
<div class="bg-white rounded-xl p-6 shadow-sm mb-6 border border-gray-50 flex flex-col overflow-x-auto scrollbar-thin scrollbar-thumb-gray-200 scrollbar-track-transparent">
    <div class="flex justify-between items-center mb-4 min-w-[700px]">
        <h2 class="text-base font-semibold text-dark">活跃度 (近一年)</h2>
        <div class="text-[11px] flex items-center gap-1 text-gray-400">
            <span>少</span>
            <div class="w-3 h-3 rounded-[2px] bg-gray-200"></div>
            <div class="w-3 h-3 rounded-[2px] bg-green-400"></div>
            <div class="w-3 h-3 rounded-[2px] bg-green-800"></div>
            <span>多</span>
        </div>
    </div>

    <!-- 热力图容器 -->
    <!-- 使用 grid-flow-col 和 grid-rows-7 来实现周视图 -->
    <div class="grid grid-flow-col grid-rows-7 gap-[3px] pb-1 w-max min-w-full" id="heatmapContainer">
        <div class="col-span-10 text-gray-400 text-xs">正在加载热力图...</div>
    </div>
</div>

<!-- 图表分栏 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
    <!-- 左侧：Rating 趋势 -->
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-50 h-full flex flex-col">
        <div class="flex justify-between items-center mb-5">
            <h2 class="text-base font-semibold text-dark">Rating 积分趋势</h2>
            <!-- 时间切换 Tab -->
            <div class="flex bg-slate-100 p-1 rounded-lg">
                <button class="chart-tab border-none bg-transparent px-3 py-1 text-xs text-gray-500 cursor-pointer rounded-md transition-all font-medium hover:text-dark [&.active]:bg-white [&.active]:text-primary [&.active]:shadow-sm active"
                        onclick="switchRatingTab(5000, this)">全部</button>
                <button class="chart-tab border-none bg-transparent px-3 py-1 text-xs text-gray-500 cursor-pointer rounded-md transition-all font-medium hover:text-dark [&.active]:bg-white [&.active]:text-primary [&.active]:shadow-sm"
                        onclick="switchRatingTab(365, this)">近一年</button>
                <button class="chart-tab border-none bg-transparent px-3 py-1 text-xs text-gray-500 cursor-pointer rounded-md transition-all font-medium hover:text-dark [&.active]:bg-white [&.active]:text-primary [&.active]:shadow-sm"
                        onclick="switchRatingTab(30, this)">近一月</button>
            </div>
        </div>
        <div class="relative w-full h-[350px]">
            <div id="ratingChart" class="w-full h-full"></div>
        </div>
    </div>

    <!-- 右侧：Rating 分布 -->
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-50 h-full flex flex-col">
        <div class="flex justify-between items-center mb-5">
            <h2 class="text-base font-semibold text-dark">已解决题目难度分布</h2>
        </div>
        <div class="relative w-full h-[350px]">
            <div id="ratingDistChart" class="w-full h-full"></div>
        </div>
    </div>
</div>

<script>
    // 定义 Codeforces 风格的 Rating 颜色区间
    const CF_BANDS = [
        { min: 0, max: 1199, color: '#f2f2f2', name: 'Newbie' },
        { min: 1200, max: 1399, color: '#e6ffe6', name: 'Pupil' },
        { min: 1400, max: 1599, color: '#e6ffff', name: 'Specialist' },
        { min: 1600, max: 1899, color: '#e6e6ff', name: 'Expert' },
        { min: 1900, max: 2099, color: '#ffe6ff', name: 'Candidate Master' },
        { min: 2100, max: 2399, color: '#fff0e6', name: 'Master' },
        { min: 2400, max: 2999, color: '#ffe6e6', name: 'Grandmaster' },
        { min: 3000, max: 5000, color: '#ffe6e6', name: 'Legendary Grandmaster' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        loadSummary();
        loadUserProfile();
        loadHeatmap();
        loadRatingHistory(5000); // 默认加载全部
        loadRatingDistribution();
        initGlobalTooltip();
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            // 热力图使用 grid 布局，不需要重绘逻辑，只需重置 CSS 变量计算
            // loadHeatmap(); // 重新加载可能太重，这里只调整图表即可
            if (window.myRatingChart) window.myRatingChart.resize();
            if (window.myDistChart) window.myDistChart.resize();
        }, 300);
    });

    // Tooltip 逻辑保持不变，只需适配类名选择器
    function initGlobalTooltip() {
        const tooltip = document.getElementById('global-tooltip');
        let isHovering = false;

        document.addEventListener('mouseover', (e) => {
            // 使用 contains 检查 Tailwind 类或 data 属性
            if (e.target.hasAttribute('data-tooltip-content')) {
                const text = e.target.getAttribute('data-tooltip-content');
                if (text) {
                    tooltip.textContent = text;
                    tooltip.style.opacity = '1';
                    isHovering = true;
                }
            }
        });

        document.addEventListener('mouseout', (e) => {
            if (e.target.hasAttribute('data-tooltip-content')) {
                tooltip.style.opacity = '0';
                isHovering = false;
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isHovering) return;
            let x = e.clientX + 12;
            let y = e.clientY + 12;

            // 简单的边界检查
            if (x + tooltip.offsetWidth > window.innerWidth) x = e.clientX - tooltip.offsetWidth - 12;
            if (y + tooltip.offsetHeight > window.innerHeight) y = e.clientY - tooltip.offsetHeight - 12;

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        });
    }

    function loadUserProfile() {
        axios.get('/api/me/platforms')
            .then(res => {
                if (res.data.code === 200 && Array.isArray(res.data.data)) {
                    const cfBinding = res.data.data.find(p => p.platformCode === 'CF');
                    if (cfBinding && cfBinding.identifierValue) {
                        document.getElementById('welcomeUser').textContent = `你好, ${cfBinding.identifierValue}!`;
                    } else {
                        document.getElementById('welcomeUser').textContent = `你好, CF Coder!`;
                    }
                } else {
                    document.getElementById('welcomeUser').textContent = `你好, CF Coder!`;
                }
            })
            .catch(() => {
                document.getElementById('welcomeUser').textContent = `你好, CF Coder!`;
            });
    }

    function loadSummary() {
        axios.get('/api/users/summary', { params: { platformCode: 'CF' } })
            .then(res => {
                if (res.data.code === 200 && res.data.data) {
                    const data = res.data.data;
                    animateValue("valSolved", 0, data.solvedTotal || 0, 800);
                    animateValue("valRating", 0, data.ratingEnd || 0, 800);
                    animateValue("valWeeklySolved", 0, data.weeklySolved || 0, 800);
                    animateValue("valActiveDays", 0, data.activeDays || 0, 800);
                }
            }).catch(console.error);
    }

    // 热力图重构：使用 Tailwind 类名
    function loadHeatmap() {
        const container = document.getElementById('heatmapContainer');
        const daysToFetch = 365;

        axios.get('/api/user/activity/heatmap', { params: { platformCode: 'CF', days: daysToFetch } })
            .then(res => {
                if (res.data.code === 200) {
                    const dataList = res.data.data || [];
                    renderHeatmap(container, dataList, daysToFetch);
                }
            });
    }

    function renderHeatmap(container, dataList, totalDays) {
        container.innerHTML = '';
        const activityMap = new Map();
        dataList.forEach(item => {
            activityMap.set(item.day, { solved: item.solvedCnt || 0, submit: item.submitCnt || 0 });
        });

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - (totalDays - 1));
        // 0(Sun) - 6(Sat)
        // 补充前面的空白格 (对齐星期)
        // grid-rows-7 意味着按列填充：Sun, Mon, Tue...
        // 所以我们只需要补齐 offset 即可
        const offset = startDate.getDay();

        for (let i = 0; i < offset; i++) {
            const empty = document.createElement('div');
            // Tailwind: w-3 h-3
            empty.className = 'w-3 h-3';
            container.appendChild(empty);
        }

        const loopDate = new Date(startDate);
        for (let i = 0; i < totalDays; i++) {
            const dateStr = loopDate.toISOString().split('T')[0];
            const data = activityMap.get(dateStr) || { solved: 0, submit: 0 };
            const count = data.solved;

            const cell = document.createElement('div');
            // 基础样式 + 动态颜色
            cell.className = `w-3 h-3 rounded-[2px] cursor-pointer transition-transform duration-200 hover:scale-125 hover:z-10 hover:border hover:border-black/30 ${getColorClass(count)}`;
            // 使用新属性适配 Tooltip
            cell.setAttribute('data-tooltip-content', `${dateStr} | AC: ${count} | 提交: ${data.submit}`);

            container.appendChild(cell);
            loopDate.setDate(loopDate.getDate() + 1);
        }
    }

    // 返回 Tailwind 背景色类名
    function getColorClass(count) {
        if (count === 0) return 'bg-gray-200'; // 对应原 #ebedf0
        if (count <= 1) return 'bg-green-300'; // 原 #9be9a8
        if (count <= 3) return 'bg-green-400'; // 原 #40c463
        if (count <= 6) return 'bg-green-600'; // 原 #30a14e
        return 'bg-green-800';                 // 原 #216e39
    }

    // 切换 Tab 逻辑
    function switchRatingTab(days, btn) {
        const tabs = document.querySelectorAll('.chart-tab');
        tabs.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        loadRatingHistory(days);
    }

    function loadRatingHistory(days) {
        const chartDom = document.getElementById('ratingChart');
        if (!chartDom) return;
        if (!days) days = 5000;

        axios.get('/api/user/rating/history', { params: { platformCode: 'CF', days: days } })
            .then(res => {
                if (res.data.code === 200) {
                    const history = res.data.data || [];
                    const dates = history.map(item => formatDate(item.time));
                    const ratings = history.map(item => item.rating);
                    const metaData = history;

                    const minRating = ratings.length ? Math.min(...ratings) : 1000;
                    const maxRating = ratings.length ? Math.max(...ratings) : 1500;
                    const yMin = Math.floor(Math.min(minRating, 1100) / 100) * 100;
                    const yMax = Math.ceil(Math.max(maxRating, 1600) / 100) * 100 + 100;

                    const markAreaData = [];
                    CF_BANDS.forEach(band => {
                        markAreaData.push([{ yAxis: band.min, itemStyle: { color: band.color } }, { yAxis: band.max }]);
                    });

                    let myChart = echarts.getInstanceByDom(chartDom);
                    if (myChart) myChart.dispose();
                    myChart = echarts.init(chartDom);
                    window.myRatingChart = myChart;

                    const option = {
                        grid: { top: 20, bottom: 20, left: 40, right: 30, containLabel: false },
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#e5e7eb',
                            textStyle: { color: '#333', fontSize: 12 },
                            formatter: function (params) {
                                if (!params || params.length === 0) return '';
                                const dataIndex = params[0].dataIndex;
                                const item = metaData[dataIndex];
                                const deltaSign = item.delta >= 0 ? '+' : '';
                                return `
                                    <div class="font-bold text-xs mb-1">${item.contestName}</div>
                                    <div class="text-gray-500">Rating: <span class="font-bold text-gray-800">${item.rating}</span></div>
                                    <div class="text-gray-500">排名: ${item.rank}</div>
                                    <div class="text-gray-500">变动: ${deltaSign}${item.delta}</div>
                                    <div class="text-gray-400 text-[10px] mt-1">${formatDate(item.time)}</div>
                                `;
                            }
                        },
                        xAxis: { type: 'category', boundaryGap: false, data: dates, show: false },
                        yAxis: {
                            type: 'value', min: yMin, max: yMax,
                            splitLine: { lineStyle: { type: 'dashed', color: 'rgba(0,0,0,0.05)' } },
                            axisLabel: { color: '#9ca3af', fontSize: 10 }
                        },
                        series: [{
                            name: 'Rating', type: 'line', data: ratings, smooth: false, symbol: 'circle', symbolSize: 6,
                            itemStyle: { color: '#FFFFFF', borderColor: '#F59E0B', borderWidth: 2 },
                            lineStyle: { color: '#F59E0B', width: 2 },
                            markArea: { silent: true, data: markAreaData }
                        }]
                    };
                    myChart.setOption(option);
                }
            });
    }

    function loadRatingDistribution() {
        const chartDom = document.getElementById('ratingDistChart');
        if (!chartDom) return;

        let myChart = echarts.getInstanceByDom(chartDom);
        if (myChart) myChart.dispose();
        myChart = echarts.init(chartDom);
        window.myDistChart = myChart;
        myChart.showLoading({ color: '#4e54c8' });

        axios.get('/api/users/rating-distribution', { params: { platformCode: 'CF' } })
            .then(res => {
                myChart.hideLoading();
                if (res.data.code === 200) {
                    const dataMap = res.data.data || {};
                    const ratings = Object.keys(dataMap).map(Number).sort((a,b) => a - b);
                    const counts = ratings.map(r => dataMap[r]);

                    const option = {
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: '{b}: {c} 题' },
                        grid: { left: '3%', right: '4%', bottom: '3%', top: '10%', containLabel: true },
                        xAxis: { type: 'category', data: ratings, axisTick: { alignWithLabel: true }, axisLabel: { interval: 'auto', color: '#6b7280' } },
                        yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#f3f4f6' } } },
                        series: [{
                            name: 'solved', type: 'bar', barWidth: '60%',
                            data: counts.map((val, idx) => ({
                                value: val,
                                itemStyle: { color: getBarColor(ratings[idx]) }
                            }))
                        }]
                    };
                    myChart.setOption(option);
                }
            });
    }

    function getBarColor(rating) {
        if (rating >= 3000) return '#aa0100';
        if (rating >= 2600) return '#ff3333';
        if (rating >= 2400) return '#ff7777';
        if (rating >= 2300) return '#ffbb55';
        if (rating >= 2100) return '#ffcc87';
        if (rating >= 1900) return '#ff88ff';
        if (rating >= 1600) return '#aaaaff';
        if (rating >= 1400) return '#76ddbb';
        if (rating >= 1200) return '#76ff77';
        return '#d1d5db';
    }

    window.triggerSync = function() {
        const icon = document.getElementById('syncIcon');
        const text = document.getElementById('syncText');
        if(icon.classList.contains('animate-spin')) return;

        icon.classList.add('animate-spin');
        text.textContent = '同步中...';

        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timerProgressBar: true,
            didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
        });

        axios.post('/api/user/submissions/refresh?platformCode=CF')
            .then(res => {
                if (res.data.code === 200) {
                    const result = res.data.data;
                    Toast.fire({ icon: 'success', title: '同步完成', text: `抓取 ${result.fetched} 条，新增 ${result.inserted} 条记录` });
                    loadSummary(); loadHeatmap(); loadRatingHistory(); loadRatingDistribution();
                } else {
                    Toast.fire({ icon: 'error', title: '同步失败', text: res.data.msg });
                }
            })
            .catch(err => { Toast.fire({ icon: 'error', title: '请求错误', text: '无法连接到服务器' }); })
            .finally(() => {
                icon.classList.remove('animate-spin');
                text.textContent = '同步数据';
            });
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const obj = document.getElementById(id);
        if (!obj) return;
        if (end > 100000) { obj.textContent = end; return; }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    function formatDate(isoString) {
        if(!isoString) return '';
        const date = new Date(isoString);
        return `${date.getMonth()+1}/${date.getDate()}`;
    }
</script>
</body>
</html>