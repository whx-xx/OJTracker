<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --text-dark: #34495e;
            --text-gray: #7f8c8d;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --heat-l0: #ebedf0;
            --heat-l1: #9be9a8;
            --heat-l2: #40c463;
            --heat-l3: #30a14e;
            --heat-l4: #216e39;
            --cell-size: 13px;
            --cell-gap: 3px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            padding: 20px;
            color: var(--text-dark);
            overflow-y: auto;
        }

        /* === 欢迎 Banner === */
        .welcome-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 30px;
            color: white;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-text h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .welcome-text p {
            opacity: 0.9;
            font-size: 14px;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .refresh-btn i.rotating {
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* === 统计卡片网格 === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.02);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .icon-blue { background: rgba(78, 84, 200, 0.1); color: var(--primary-color); }
        .icon-green { background: rgba(46, 204, 113, 0.1); color: var(--success-color); }
        .icon-orange { background: rgba(241, 196, 15, 0.1); color: var(--warning-color); }
        .icon-red { background: rgba(231, 76, 60, 0.1); color: var(--danger-color); }

        .stat-info h3 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-dark);
        }

        .stat-info p {
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }

        /* === 热力图样式 === */
        .heatmap-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 25px;
            overflow-x: auto;
            border: 1px solid rgba(0,0,0,0.02);
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        .heatmap-card::-webkit-scrollbar { height: 6px; }
        .heatmap-card::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

        .heatmap-container {
            display: grid;
            grid-template-rows: repeat(7, var(--cell-size));
            grid-auto-flow: column;
            gap: var(--cell-gap);
            padding-bottom: 5px;
            width: max-content;
            min-width: 100%;
        }

        .heatmap-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-radius: 2px;
            background-color: var(--heat-l0);
            position: relative;
            cursor: pointer;
        }

        .heatmap-cell:hover {
            border: 1px solid rgba(0,0,0,0.4);
            transform: scale(1.15);
            z-index: 5;
        }

        .color-l0 { background-color: var(--heat-l0); }
        .color-l1 { background-color: var(--heat-l1); }
        .color-l2 { background-color: var(--heat-l2); }
        .color-l3 { background-color: var(--heat-l3); }
        .color-l4 { background-color: var(--heat-l4); }

        /* 全局 Tooltip */
        #global-tooltip {
            position: fixed;
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.15s ease, transform 0.1s ease;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* === 图表 Tab 样式 (新增) === */
        .chart-tabs {
            display: flex;
            background: #f1f5f9;
            padding: 3px;
            border-radius: 8px;
        }

        .chart-tab {
            border: none;
            background: transparent;
            padding: 5px 12px;
            font-size: 12px;
            color: var(--text-gray);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .chart-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chart-tab:hover:not(.active) {
            color: var(--text-dark);
        }

        /* === 内容分栏 === */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 改为 1:1，更适合两个图表并排 */
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.02);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        @media (max-width: 1000px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div id="global-tooltip"></div>

<div class="welcome-banner">
    <div class="welcome-text">
        <h1 id="welcomeUser">欢迎回来!</h1>
        <p>每一行代码，都是通往梦想的脚印。</p>
    </div>
    <button class="refresh-btn" onclick="triggerSync()">
        <i class="fas fa-sync-alt" id="syncIcon"></i>
        <span id="syncText">同步数据</span>
    </button>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon icon-blue">
            <i class="fas fa-check-double"></i>
        </div>
        <div class="stat-info">
            <h3 id="valSolved">--</h3>
            <p>总解题数</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon icon-green">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
            <h3 id="valRating">--</h3>
            <p>当前 Rating</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon icon-orange">
            <i class="fas fa-calendar-week"></i>
        </div>
        <div class="stat-info">
            <h3 id="valWeeklySolved">--</h3>
            <p>本周解题</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon icon-red">
            <i class="fas fa-fire"></i>
        </div>
        <div class="stat-info">
            <h3 id="valActiveDays">--</h3>
            <p>活跃天数</p>
        </div>
    </div>
</div>

<div class="heatmap-card">
    <div class="card-header" style="margin-bottom: 15px;">
        <h2>活跃度 (近一年)</h2>
        <div style="font-size: 11px; display: flex; align-items: center; gap: 4px; color: #888;">
            <span>少</span>
            <div class="heatmap-cell color-l0" style="width:12px;height:12px;cursor:default;"></div>
            <div class="heatmap-cell color-l2" style="width:12px;height:12px;cursor:default;"></div>
            <div class="heatmap-cell color-l4" style="width:12px;height:12px;cursor:default;"></div>
            <span>多</span>
        </div>
    </div>
    <div class="heatmap-container" id="heatmapContainer">
        <div style="grid-column: span 10; color: #999; font-size: 12px;">正在加载热力图...</div>
    </div>
</div>

<div class="content-grid">
    <!-- 左侧：Codeforces 风格 Rating 曲线图 -->
    <div class="card">
        <div class="card-header">
            <h2>Rating 积分趋势</h2>
            <!-- 新增：时间切换 Tab -->
            <div class="chart-tabs">
                <button class="chart-tab active" onclick="switchRatingTab(5000, this)">全部</button>
                <button class="chart-tab" onclick="switchRatingTab(365, this)">近一年</button>
                <button class="chart-tab" onclick="switchRatingTab(30, this)">近一月</button>
            </div>
        </div>
        <div style="position: relative; height: 350px; width: 100%;">
            <!-- ECharts Container: Replaces Canvas -->
            <div id="ratingChart" style="width: 100%; height: 100%;"></div>
        </div>
    </div>

    <!-- 右侧：Rating 分布柱状图 (ECharts) [修改：移除了原本的表格，替换为柱状图] -->
    <div class="card">
        <div class="card-header">
            <h2>已解决题目难度分布</h2>
        </div>
        <div style="position: relative; height: 350px; width: 100%;">
            <div id="ratingDistChart" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
</div>

<script>
    // 定义 Codeforces 风格的 Rating 颜色区间 (背景色带)
    const CF_BANDS = [
        { min: 0, max: 1199, color: '#f2f2f2', name: 'Newbie' },    // Newbie (Gray)
        { min: 1200, max: 1399, color: '#e6ffe6', name: 'Pupil' }, // Pupil (Green)
        { min: 1400, max: 1599, color: '#e6ffff', name: 'Specialist' }, // Specialist (Cyan)
        { min: 1600, max: 1899, color: '#e6e6ff', name: 'Expert' }, // Expert (Blue)
        { min: 1900, max: 2099, color: '#ffe6ff', name: 'Candidate Master' }, // CM (Violet)
        { min: 2100, max: 2399, color: '#fff0e6', name: 'Master' }, // Master (Orange)
        { min: 2400, max: 2999, color: '#ffe6e6', name: 'Grandmaster' }, // GM (Red)
        { min: 3000, max: 5000, color: '#ffe6e6', name: 'Legendary Grandmaster' }  // LGM (Red)
    ];

    document.addEventListener('DOMContentLoaded', () => {
        loadSummary();
        loadUserProfile();
        loadHeatmap();
        loadRatingHistory(5000); // 默认加载全部
        loadRatingDistribution(); // [新增] 加载难度分布图
        initGlobalTooltip();
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            loadHeatmap();
            // Resize ECharts
            if (window.myRatingChart) {
                window.myRatingChart.resize();
            }
            if (window.myDistChart) {
                window.myDistChart.resize();
            }
        }, 300);
    });

    function initGlobalTooltip() {
        const tooltip = document.getElementById('global-tooltip');
        let isHovering = false;

        document.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('heatmap-cell')) {
                const text = e.target.getAttribute('data-tooltip');
                if (text) {
                    tooltip.textContent = text;
                    tooltip.style.opacity = '1';
                    isHovering = true;
                }
            }
        });

        document.addEventListener('mouseout', (e) => {
            if (e.target.classList.contains('heatmap-cell')) {
                tooltip.style.opacity = '0';
                isHovering = false;
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isHovering) return;
            let x = e.clientX + 12;
            let y = e.clientY + 12;
            const tooltipWidth = tooltip.offsetWidth;
            const windowWidth = window.innerWidth;
            if (x + tooltipWidth > windowWidth - 10) x = e.clientX - tooltipWidth - 12;
            const tooltipHeight = tooltip.offsetHeight;
            const windowHeight = window.innerHeight;
            if (y + tooltipHeight > windowHeight - 10) y = e.clientY - tooltipHeight - 12;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        });
    }

    function loadUserProfile() {
        axios.get('/api/me/platforms')
            .then(res => {
                if (res.data.code === 200 && Array.isArray(res.data.data)) {
                    const cfBinding = res.data.data.find(p => p.platformCode === 'CF');
                    if (cfBinding && cfBinding.identifierValue) {
                        document.getElementById('welcomeUser').textContent = `你好, ${cfBinding.identifierValue}!`;
                    } else {
                        document.getElementById('welcomeUser').textContent = `你好, CF Coder!`;
                    }
                } else {
                    document.getElementById('welcomeUser').textContent = `你好, CF Coder!`;
                }
            })
            .catch(() => {
                document.getElementById('welcomeUser').textContent = `你好, CF Coder!`;
            });
    }

    function loadSummary() {
        axios.get('/api/users/summary', { params: { platformCode: 'CF' } })
            .then(res => {
                if (res.data.code === 200 && res.data.data) {
                    const data = res.data.data;
                    animateValue("valSolved", 0, data.solvedTotal || 0, 800);
                    animateValue("valRating", 0, data.ratingEnd || 0, 800);
                    animateValue("valWeeklySolved", 0, data.weeklySolved || 0, 800);
                    animateValue("valActiveDays", 0, data.activeDays || 0, 800);
                }
            }).catch(console.error);
    }

    function loadHeatmap() {
        const container = document.getElementById('heatmapContainer');
        const card = document.querySelector('.heatmap-card');
        const daysToFetch = 365;
        const gap = 3;
        const numCols = 53;
        const availableWidth = card.clientWidth - 50;
        let cellSize = Math.floor((availableWidth - (numCols - 1) * gap) / numCols);
        if (cellSize < 10) cellSize = 10;
        if (cellSize > 40) cellSize = 40;

        document.documentElement.style.setProperty('--cell-size', cellSize + 'px');
        document.documentElement.style.setProperty('--cell-gap', gap + 'px');

        axios.get('/api/user/activity/heatmap', { params: { platformCode: 'CF', days: daysToFetch } })
            .then(res => {
                if (res.data.code === 200) {
                    const dataList = res.data.data || [];
                    renderHeatmap(container, dataList, daysToFetch);
                    setTimeout(() => { if (card) { card.scrollLeft = card.scrollWidth; } }, 50);
                }
            });
    }

    function renderHeatmap(container, dataList, totalDays) {
        container.innerHTML = '';
        const activityMap = new Map();
        dataList.forEach(item => {
            activityMap.set(item.day, { solved: item.solvedCnt || 0, submit: item.submitCnt || 0 });
        });

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - (totalDays - 1));
        const startDay = startDate.getDay();
        const offset = startDay;

        for (let i = 0; i < offset; i++) {
            const empty = document.createElement('div');
            empty.className = 'heatmap-cell';
            empty.style.backgroundColor = 'transparent';
            container.appendChild(empty);
        }

        const loopDate = new Date(startDate);
        for (let i = 0; i < totalDays; i++) {
            const dateStr = loopDate.toISOString().split('T')[0];
            const data = activityMap.get(dateStr) || { solved: 0, submit: 0 };
            const count = data.solved;
            const cell = document.createElement('div');
            cell.className = `heatmap-cell ${getColorClass(count)}`;
            cell.setAttribute('data-tooltip', `${dateStr} | AC: ${count} | 提交: ${data.submit}`);
            container.appendChild(cell);
            loopDate.setDate(loopDate.getDate() + 1);
        }
    }

    function getColorClass(count) {
        if (count === 0) return 'color-l0';
        if (count <= 1) return 'color-l1';
        if (count <= 3) return 'color-l2';
        if (count <= 6) return 'color-l3';
        return 'color-l4';
    }

    // 切换 Tab 逻辑
    function switchRatingTab(days, btn) {
        // 更新按钮样式
        const tabs = document.querySelectorAll('.chart-tab');
        tabs.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        // 重新加载图表
        loadRatingHistory(days);
    }

    // 加载 Rating 历史图表 (ECharts 版本)
    function loadRatingHistory(days) {
        const chartDom = document.getElementById('ratingChart');
        if (!chartDom) return;

        // 如果没有传 days，默认加载全部
        if (!days) days = 5000;

        axios.get('/api/user/rating/history', { params: { platformCode: 'CF', days: days } })
            .then(res => {
                if (res.data.code === 200) {
                    const history = res.data.data || [];
                    const dates = history.map(item => formatDate(item.time));
                    const ratings = history.map(item => item.rating);
                    const metaData = history;

                    // 计算 Y 轴范围
                    const minRating = ratings.length ? Math.min(...ratings) : 1000;
                    const maxRating = ratings.length ? Math.max(...ratings) : 1500;
                    const yMin = Math.floor(Math.min(minRating, 1100) / 100) * 100;
                    const yMax = Math.ceil(Math.max(maxRating, 1600) / 100) * 100 + 100;

                    // 准备 markArea 数据
                    const markAreaData = [];
                    CF_BANDS.forEach(band => {
                        // 只添加在显示范围内的区域，或者简单添加所有区域
                        markAreaData.push([
                            {
                                yAxis: band.min,
                                itemStyle: {
                                    color: band.color,
                                    opacity: 1 // ECharts中可以通过 opacity 控制透明度，这里直接用配置好的颜色
                                }
                            },
                            {
                                yAxis: band.max
                            }
                        ]);
                    });

                    // 初始化或获取 ECharts 实例
                    let myChart = echarts.getInstanceByDom(chartDom);
                    if (myChart) {
                        myChart.dispose(); // 销毁旧实例以防万一
                    }
                    myChart = echarts.init(chartDom);
                    window.myRatingChart = myChart; // 存到全局以便 resize

                    const option = {
                        grid: {
                            top: 20,
                            bottom: 30,
                            left: 50,
                            right: 30,
                            containLabel: false
                        },
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#ddd',
                            textStyle: {
                                color: '#333',
                                fontSize: 12
                            },
                            formatter: function (params) {
                                // params[0] 是系列数据
                                if (!params || params.length === 0) return '';
                                const dataIndex = params[0].dataIndex;
                                const item = metaData[dataIndex];
                                const deltaSign = item.delta >= 0 ? '+' : '';

                                return `
                                    <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${item.contestName}</div>
                                    <div style="color: #666;">Rating: <span style="font-weight: 600; color: #333;">${item.rating}</span></div>
                                    <div style="color: #666;">排名: ${item.rank}</div>
                                    <div style="color: #666;">变动: ${deltaSign}${item.delta}</div>
                                    <div style="color: #999; font-size: 11px; margin-top: 4px;">${formatDate(item.time)}</div>
                                `;
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: dates,
                            axisLine: { show: false },
                            axisTick: { show: false },
                            axisLabel: {
                                show: false // 如果你想隐藏X轴标签，或者设为 true 显示
                            }
                        },
                        yAxis: {
                            type: 'value',
                            min: yMin,
                            max: yMax,
                            splitLine: {
                                lineStyle: {
                                    type: 'dashed',
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            axisLabel: {
                                color: '#999',
                                fontSize: 11
                            }
                        },
                        series: [
                            {
                                name: 'Rating',
                                type: 'line',
                                data: ratings,
                                smooth: false,
                                symbol: 'circle',
                                symbolSize: 6,
                                itemStyle: {
                                    color: '#FFFFFF', // 点的内部颜色
                                    borderColor: '#FFC107', // 点的边框颜色
                                    borderWidth: 2
                                },
                                lineStyle: {
                                    color: '#FFC107',
                                    width: 2
                                },
                                markArea: {
                                    silent: true, // 鼠标悬停不触发效果
                                    data: markAreaData
                                }
                            }
                        ]
                    };

                    myChart.setOption(option);
                }
            });
    }

    // === [新增] ECharts 加载难度分布图 ===
    function loadRatingDistribution() {
        const chartDom = document.getElementById('ratingDistChart');
        if (!chartDom) return;

        let myChart = echarts.getInstanceByDom(chartDom);
        if (myChart) myChart.dispose();
        myChart = echarts.init(chartDom);
        window.myDistChart = myChart;
        myChart.showLoading({ color: '#4e54c8' });

        axios.get('/api/users/rating-distribution', { params: { platformCode: 'CF' } })
            .then(res => {
                myChart.hideLoading();
                if (res.data.code === 200) {
                    const dataMap = res.data.data || {};
                    // 将 map 转为数组并排序
                    const ratings = Object.keys(dataMap).map(Number).sort((a,b) => a - b);
                    const counts = ratings.map(r => dataMap[r]);

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: '{b}: {c} 题'
                        },
                        grid: {
                            left: '3%', right: '4%', bottom: '3%', top: '10%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: ratings,
                            axisTick: { alignWithLabel: true },
                            axisLabel: {
                                interval: 'auto',
                                color: '#666'
                            }
                        },
                        yAxis: {
                            type: 'value',
                            splitLine: {
                                lineStyle: { type: 'dashed', color: '#eee' }
                            }
                        },
                        series: [{
                            name: 'solved',
                            type: 'bar',
                            barWidth: '60%',
                            data: counts.map((val, idx) => ({
                                value: val,
                                itemStyle: {
                                    color: getBarColor(ratings[idx]) // 使用自定义颜色函数
                                }
                            }))
                        }]
                    };
                    myChart.setOption(option);
                }
            });
    }

    // [新增] 柱状图颜色逻辑 (参考 GreasyFork 脚本)
    function getBarColor(rating) {
        if (rating >= 3000) return '#aa0100'; // LGM (Dark Red)
        if (rating >= 2600) return '#ff3333'; // IGM (Red)
        if (rating >= 2400) return '#ff7777'; // GM (Light Red)
        if (rating >= 2300) return '#ffbb55'; // IM (Orange)
        if (rating >= 2100) return '#ffcc87'; // Master (Light Orange)
        if (rating >= 1900) return '#ff88ff'; // CM (Violet)
        if (rating >= 1600) return '#aaaaff'; // Expert (Blue)
        if (rating >= 1400) return '#76ddbb'; // Specialist (Cyan)
        if (rating >= 1200) return '#76ff77'; // Pupil (Green)
        return '#cccccc'; // Newbie (Gray)
    }

    window.triggerSync = function() {
        const icon = document.getElementById('syncIcon');
        const text = document.getElementById('syncText');
        if(icon.classList.contains('rotating')) return;
        icon.classList.add('rotating'); text.textContent = '同步中...';
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timerProgressBar: true,
            didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
        });

        axios.post('/api/user/submissions/refresh?platformCode=CF')
            .then(res => {
                if (res.data.code === 200) {
                    const result = res.data.data;
                    Toast.fire({ icon: 'success', title: '同步完成', text: `抓取 ${result.fetched} 条，新增 ${result.inserted} 条记录` });
                    loadSummary(); loadHeatmap(); loadRatingHistory(); loadRatingDistribution();
                } else {
                    Toast.fire({ icon: 'error', title: '同步失败', text: res.data.msg });
                }
            })
            .catch(err => { Toast.fire({ icon: 'error', title: '请求错误', text: '无法连接到服务器' }); })
            .finally(() => { icon.classList.remove('rotating'); text.textContent = '同步数据'; });
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const obj = document.getElementById(id);
        if (!obj) return;
        if (end > 100000) { obj.textContent = end; return; }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    function formatDate(isoString) {
        if(!isoString) return '';
        const date = new Date(isoString);
        return `${date.getMonth()+1}/${date.getDate()}`;
    }
</script>
</body>
</html>