<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJ Tracker - 首页</title>
    <!-- 引入 FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入 SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        bg: '#f1f5f9',
                        dark: '#333',
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        sidebar: '4px 0 10px rgba(0,0,0,0.1)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.2s ease-out forwards',
                    }
                }
            }
        }
    </script>
</head>
<!--
    Body 添加 'group' 类，用于控制子元素对 .collapsed 状态的响应
    添加 'group-[.collapsed]' 逻辑：当JS给body添加collapsed类时，侧边栏宽度变窄
-->
<body class="bg-bg flex h-screen overflow-hidden font-poppins group">

<!-- 侧边栏 -->
<!--
    宽度逻辑：
    1. w-[70px]: 默认（移动端）宽度为70px
    2. md:w-[240px]: PC端默认宽度240px
    3. group-[.collapsed]:md:w-[70px]: 当body有collapsed类时，PC端宽度变回70px
-->
<nav class="w-[70px] md:w-[240px] group-[.collapsed]:md:w-[70px]
            bg-gradient-to-b from-primary to-[#3f2b96] text-white flex flex-col
            transition-[width] duration-300 shadow-sidebar z-50 whitespace-nowrap shrink-0">

    <!-- Brand -->
    <div class="h-[70px] flex items-center justify-center text-xl font-semibold tracking-wide border-b border-white/10 overflow-hidden shrink-0">
        <!-- 图标：在移动端或折叠时取消右边距 -->
        <i class="fas fa-code-branch text-2xl min-w-[30px] text-center mr-0 md:mr-2 md:group-[.collapsed]:mr-0 transition-all duration-300"></i>
        <!-- 文字：移动端隐藏，折叠时隐藏 -->
        <span class="hidden md:block group-[.collapsed]:hidden animate-fade-in-up">OJ Tracker</span>
    </div>

    <!-- Menu -->
    <div class="flex-1 pt-5 overflow-y-auto overflow-x-hidden scrollbar-none">
        <ul id="menuList">
            <li>
                <!--
                    菜单链接样式：
                    [&.active] 语法用于匹配 JS 添加的 .active 类
                -->
                <a href="/dashboard" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                          text-white/80 text-sm transition-all border-l-4 border-transparent
                                          hover:bg-white/10 hover:text-white hover:border-white
                                          [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                          justify-center md:justify-start"
                   data-title="仪表盘">
                    <i class="fas fa-chart-line w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                    <span class="hidden md:block group-[.collapsed]:hidden">仪表盘</span>
                </a>
            </li>
            <li>
                <a href="/views/submissions" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                                  text-white/80 text-sm transition-all border-l-4 border-transparent
                                                  hover:bg-white/10 hover:text-white hover:border-white
                                                  [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                                  justify-center md:justify-start"
                   data-title="解题详情">
                    <i class="fas fa-file-code w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                    <span class="hidden md:block group-[.collapsed]:hidden">解题详情</span>
                </a>
            </li>

            <li>
                <a href="/views/profile" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                              text-white/80 text-sm transition-all border-l-4 border-transparent
                                              hover:bg-white/10 hover:text-white hover:border-white
                                              [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                              justify-center md:justify-start"
                   data-title="个人中心">
                    <i class="fas fa-user-circle w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                    <span class="hidden md:block group-[.collapsed]:hidden">个人中心</span>
                </a>
            </li>

            <li>
                <a href="/views/rankings" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                               text-white/80 text-sm transition-all border-l-4 border-transparent
                                               hover:bg-white/10 hover:text-white hover:border-white
                                               [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                               justify-center md:justify-start"
                   data-title="排行榜">
                    <i class="fas fa-trophy w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                    <span class="hidden md:block group-[.collapsed]:hidden">团队榜单</span>
                </a>
            </li>

            <div id="adminSection" style="display: none;">
                <!-- 分割标题：折叠时隐藏 -->
                <div class="px-5 pt-4 pb-1 text-[11px] uppercase text-white/40 font-semibold whitespace-nowrap overflow-hidden transition-all hidden md:block group-[.collapsed]:hidden">后台管理</div>

                <li>
                    <!-- 关键修改：路径改为 /admin/views/users -->
                    <a href="/admin/views/users" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                                text-white/80 text-sm transition-all border-l-4 border-transparent
                                                hover:bg-white/10 hover:text-white hover:border-white
                                                [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                                justify-center md:justify-start"
                       data-title="用户管理">
                        <i class="fas fa-users-cog w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                        <span class="hidden md:block group-[.collapsed]:hidden">用户管理</span>
                    </a>
                </li>
                <li>
                    <!-- 关键修改：路径改为 /admin/views/sync -->
                    <a href="/admin/views/sync" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                               text-white/80 text-sm transition-all border-l-4 border-transparent
                                               hover:bg-white/10 hover:text-white hover:border-white
                                               [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                               justify-center md:justify-start"
                       data-title="同步管理">
                        <i class="fas fa-sync-alt w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                        <span class="hidden md:block group-[.collapsed]:hidden">同步任务</span>
                    </a>
                </li>
                <li>
                    <!-- 关键修改：路径改为 /admin/views/logs -->
                    <a href="/admin/views/logs" class="menu-link flex items-center py-4 px-0 md:px-5 group-[.collapsed]:justify-center group-[.collapsed]:px-0 md:group-[.collapsed]:px-0
                                               text-white/80 text-sm transition-all border-l-4 border-transparent
                                               hover:bg-white/10 hover:text-white hover:border-white
                                               [&.active]:bg-white/10 [&.active]:text-white [&.active]:border-white
                                               justify-center md:justify-start"
                       data-title="操作日志">
                        <i class="fas fa-history w-8 text-xl text-center mr-0 md:mr-2 md:text-lg md:group-[.collapsed]:mr-0 md:group-[.collapsed]:text-xl transition-all"></i>
                        <span class="hidden md:block group-[.collapsed]:hidden">操作日志</span>
                    </a>
                </li>
            </div>
        </ul>
    </div>
</nav>

<!-- 主内容区 -->
<!-- Flex-1 自动占据剩余空间 -->
<div class="flex-1 flex flex-col min-w-0 transition-all duration-300">
    <!-- 顶部 Header -->
    <header class="h-[70px] bg-white flex justify-between items-center px-4 md:px-8 shadow-sm z-40 shrink-0">
        <div class="flex items-center gap-5">
            <!-- 侧边栏缩放开关：移动端隐藏 -->
            <div class="hidden md:flex cursor-pointer text-xl w-10 h-10 items-center justify-center rounded-full hover:bg-bg hover:text-primary transition-colors" id="sidebarToggle" title="切换侧边栏">
                <i class="fas fa-outdent"></i>
            </div>
            <div class="header-title">
                <h2 id="pageTitle" class="text-lg md:text-xl text-dark font-medium m-0">仪表盘</h2>
            </div>
        </div>

        <!-- 用户区域 -->
        <div class="relative flex items-center gap-3 cursor-pointer p-1.5 rounded-[30px] hover:bg-bg transition-colors select-none [&.active]:bg-bg group/user" id="userDropdownTrigger">
            <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-secondary">
            <div class="hidden md:block text-right">
                <h4 id="userNickname" class="text-sm text-dark leading-tight">加载中...</h4>
                <small id="userRole" class="block text-xs text-gray-400">Student</small>
            </div>
            <i class="fas fa-chevron-down text-gray-400 text-xs ml-1 transition-transform duration-200 group-[.active]/user:rotate-180 hidden md:block"></i>

            <!-- 下拉菜单 -->
            <!-- 使用 [&.show]:flex 来响应 JS 的 classList.toggle('show') -->
            <div class="absolute top-[calc(100%+5px)] right-0 bg-white w-full min-w-[140px] rounded-lg shadow-xl hidden flex-col overflow-hidden animate-fade-in-up border border-gray-100 z-50 [&.show]:flex" id="userDropdown">
                <a href="/views/profile" class="menu-link flex items-center py-3 px-5 text-dark text-sm hover:bg-gray-50 hover:text-primary transition-colors" data-title="个人中心">
                    <i class="fas fa-user mr-3 text-primary w-4 text-center"></i> 个人资料
                </a>
                <a href="#" class="flex items-center py-3 px-5 text-dark text-sm hover:bg-gray-50 hover:text-primary transition-colors" id="btnLogout">
                    <i class="fas fa-sign-out-alt mr-3 text-primary w-4 text-center"></i> 退出登录
                </a>
            </div>
        </div>
    </header>

    <!-- 内容区域 iframe -->
    <div class="flex-1 overflow-hidden bg-bg relative">
        <iframe id="contentFrame" src="/dashboard" title="Content" class="w-full h-full border-none block"></iframe>
    </div>
</div>

<script>
    const contentFrame = document.getElementById('contentFrame');
    const pageTitle = document.getElementById('pageTitle');
    const menuLinks = document.querySelectorAll('.menu-link');
    const userDropdownTrigger = document.getElementById('userDropdownTrigger');
    const userDropdown = document.getElementById('userDropdown');
    const sidebarToggle = document.getElementById('sidebarToggle');

    document.addEventListener('DOMContentLoaded', () => {
        fetchCurrentUser();
        setupMenuNavigation();
        setupDropdown();
        setupLogout();
        setupSidebarToggle();
    });

    // 1. 获取当前用户信息与强制修改密码检测
    function fetchCurrentUser() {
        axios.get('/api/auth/current')
            .then(response => {
                const res = response.data;
                if (res.code === 200 && res.data) {
                    const user = res.data;

                    // === 强制修改密码逻辑 ===
                    if (user.mustChangePassword === 1) {
                        handleMustChangePassword(user);
                    } else {
                        setupNormalUser(user);
                    }
                } else {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error("Auth check failed", error);
                window.location.href = '/login';
            });
    }

    // 渲染正常用户
    function setupNormalUser(user) {
        document.getElementById('userNickname').textContent = user.nickname || user.username;
        document.getElementById('userRole').textContent = user.role || '用户';

        if (user.avatar) {
            document.getElementById('userAvatar').src = user.avatar;
        } else {
            document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${user.username}&background=8f94fb&color=fff`;
        }

        if (user.role === 'ADMIN' || user.role === 'ROOT') {
            document.getElementById('adminSection').style.display = 'block';
        }
    }

    // 处理强制修改密码状态
    function handleMustChangePassword(user) {
        setupNormalUser(user); // 仍需渲染头部，让用户知道已登录

        // 1. 强制 Iframe 跳转到个人中心
        const profilePath = '/views/profile';
        contentFrame.src = profilePath;
        pageTitle.textContent = '个人中心';

        // 2. 锁定侧边栏链接
        const allLinks = document.querySelectorAll('.menu-link'); // 修正选择器
        allLinks.forEach(link => {
            const href = link.getAttribute('href');

            // 如果是个人中心，视觉上激活，但逻辑上也无需额外点击
            if (href === profilePath) {
                link.classList.add('active');
                link.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                // 其他链接变灰且禁用
                link.classList.remove('active');
                // 使用 Tailwind 类名处理禁用状态
                link.classList.add('opacity-50', 'cursor-not-allowed');
                // 覆盖点击事件
                link.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // 提示
                    Swal.fire({
                        icon: 'warning',
                        title: '限制访问',
                        text: '为了您的账户安全，请先在个人中心修改初始密码！',
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                };
            }
        });

        // 3. 弹出不可关闭的警告框
        Swal.fire({
            title: '安全提示',
            text: '系统检测到您正在使用初始密码。为了保障安全，请立即修改密码。',
            icon: 'warning',
            allowOutsideClick: false, // 禁止点击背景关闭
            allowEscapeKey: false,    // 禁止ESC关闭
            confirmButtonText: '去修改密码',
            confirmButtonColor: '#4e54c8',
            heightAuto: false // 防止布局塌缩
        });
    }

    // 2. 侧边栏缩放逻辑
    function setupSidebarToggle() {
        sidebarToggle.addEventListener('click', () => {
            // 这里切换 body 的 class，Tailwind 的 group-[.collapsed] 会自动响应
            document.body.classList.toggle('collapsed');

            const icon = sidebarToggle.querySelector('i');
            if (document.body.classList.contains('collapsed')) {
                icon.classList.remove('fa-outdent');
                icon.classList.add('fa-indent');
            } else {
                icon.classList.remove('fa-indent');
                icon.classList.add('fa-outdent');
            }
        });
    }

    // 3. 菜单导航逻辑
    function setupMenuNavigation() {
        menuLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') return;
                // 检查是否禁用 (Tailwind class check)
                if (this.classList.contains('cursor-not-allowed')) return;

                e.preventDefault();

                menuLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                const targetUrl = this.getAttribute('href');
                // 确保折叠后展开菜单也能高亮
                document.querySelectorAll(`.menu-link[href="${targetUrl}"]`).forEach(l => l.classList.add('active'));

                contentFrame.src = targetUrl;
                const title = this.getAttribute('data-title');
                if (title) pageTitle.textContent = title;

                userDropdown.classList.remove('show');
                userDropdownTrigger.classList.remove('active');
            });
        });
    }

    // 4. 下拉菜单交互
    function setupDropdown() {
        userDropdownTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('show');
            userDropdownTrigger.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            userDropdown.classList.remove('show');
            userDropdownTrigger.classList.remove('active');
        });
    }

    // 5. 退出登录
    function setupLogout() {
        document.getElementById('btnLogout').addEventListener('click', (e) => {
            e.preventDefault();

            Swal.fire({
                title: '确定要退出吗？',
                text: "您将返回登录页面",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4e54c8',
                cancelButtonColor: '#d33',
                confirmButtonText: '退出登录',
                cancelButtonText: '取消',
                heightAuto: false
            }).then((result) => {
                if (result.isConfirmed) {
                    axios.post('/api/auth/logout')
                        .then(() => {
                            window.location.href = '/login';
                        })
                        .catch(err => {
                            window.location.href = '/login';
                        });
                }
            });
        });
    }
</script>
</body>
</html>