<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJ Tracker - 首页</title>
    <!-- 引入 FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入 SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            /* 1. 调整默认侧边栏宽度，稍微变窄一点 */
            --sidebar-width: 240px;
            --sidebar-collapsed-width: 70px;
            --header-height: 70px;
            --bg-color: #f1f5f9;
            --text-color: #333;
            --text-muted: #888;
            --white: #ffffff;
            --hover-bg: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            text-decoration: none;
            list-style: none;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* === 侧边栏样式 === */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #4e54c8 0%, #3f2b96 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease; /* 添加平滑过渡 */
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
            white-space: nowrap; /* 防止折叠时文字换行 */
        }

        .sidebar-brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px; /* 字体稍微调小 */
            font-weight: 600;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .sidebar-brand i {
            margin-right: 10px;
            font-size: 24px;
            min-width: 30px; /* 固定宽度，防止折叠时抖动 */
            text-align: center;
        }

        .sidebar-menu {
            flex: 1;
            padding-top: 20px;
            overflow-y: auto;
            overflow-x: hidden; /* 隐藏横向滚动条 */
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            overflow: hidden;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--hover-bg);
            color: var(--white);
            border-left-color: var(--white);
        }

        .sidebar-menu a i {
            width: 30px;
            font-size: 18px;
            text-align: center;
            margin-right: 10px;
            transition: margin 0.3s;
        }

        .menu-label {
            padding: 15px 20px 5px;
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.4);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            transition: all 0.3s;
        }

        /* === 折叠状态样式 (Collapsed) === */
        body.collapsed .sidebar {
            width: var(--sidebar-collapsed-width);
        }

        body.collapsed .main-content {
            width: calc(100% - var(--sidebar-collapsed-width));
        }

        body.collapsed .sidebar-brand span,
        body.collapsed .sidebar-menu a span {
            display: none; /* 隐藏文字 */
        }

        body.collapsed .menu-label {
            opacity: 0; /* 隐藏标签标题 */
            height: 0;
            padding: 0;
        }

        body.collapsed .sidebar-menu a {
            justify-content: center; /* 图标居中 */
            padding: 15px 0;
        }

        body.collapsed .sidebar-menu a i {
            margin-right: 0; /* 移除图标右边距 */
            font-size: 20px;
        }

        body.collapsed .sidebar-brand {
            justify-content: center;
        }

        body.collapsed .sidebar-brand i {
            margin-right: 0;
        }

        /* === 主内容区域 === */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: calc(100% - var(--sidebar-width));
            transition: width 0.3s ease; /* 内容区宽度跟随过渡 */
        }

        /* === 顶部导航栏 === */
        header {
            height: var(--header-height);
            background-color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 90;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* 2. 缩放按钮样式 */
        .toggle-btn {
            cursor: pointer;
            font-size: 20px;
            color: var(--text-dark);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .toggle-btn:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .header-title h2 {
            font-size: 20px;
            color: var(--text-color);
            font-weight: 500;
            margin: 0;
        }

        /* 用户区域 */
        .user-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 30px;
            transition: background-color 0.2s;
        }

        .user-wrapper:hover {
            background-color: #f1f5f9;
        }

        .user-wrapper img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--secondary-color);
        }

        .user-info {
            text-align: right;
        }

        .user-info h4 {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 0;
            line-height: 1.2;
        }

        .user-info small {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
        }

        .dropdown-indicator {
            color: var(--text-muted);
            font-size: 12px;
            margin-left: 5px;
            transition: transform 0.2s;
        }

        .user-wrapper.active .dropdown-indicator {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: var(--white);
            width: 100%;
            min-width: 140px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
            border: 1px solid #f0f0f0;
        }

        .dropdown-menu.show {
            display: flex;
        }

        .dropdown-item {
            padding: 12px 20px;
            color: var(--text-color);
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .dropdown-item i {
            margin-right: 12px;
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .iframe-container {
            flex: 1;
            padding: 0;
            overflow: hidden;
            background-color: #f1f5f9;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar-brand span, .sidebar-menu a span, .menu-label, .user-info, .dropdown-indicator { display: none; }
            .main-content { width: calc(100% - 70px); }
            .sidebar-menu a { padding: 15px; justify-content: center; }
            .sidebar-menu a i { margin: 0; font-size: 24px; }
            .sidebar-brand { justify-content: center; }
            .sidebar-brand i { margin: 0; }
            .toggle-btn { display: none; } /* 移动端隐藏切换按钮，默认已经是小侧边栏 */
        }
    </style>
</head>
<body>

<!-- 侧边栏 -->
<nav class="sidebar">
    <div class="sidebar-brand">
        <i class="fas fa-code-branch"></i>
        <span>OJ Tracker</span>
    </div>

    <div class="sidebar-menu">
        <ul id="menuList">
            <li>
                <a href="/dashboard" class="menu-link active" data-title="仪表盘">
                    <i class="fas fa-chart-line"></i>
                    <span>仪表盘</span>
                </a>
            </li>
            <li>
                <a href="/views/profile" class="menu-link" data-title="个人中心">
                    <i class="fas fa-user-circle"></i>
                    <span>个人中心</span>
                </a>
            </li>
            <li>
                <a href="/views/rankings" class="menu-link" data-title="排行榜">
                    <i class="fas fa-trophy"></i>
                    <span>团队榜单</span>
                </a>
            </li>

            <div id="adminSection" style="display: none;">
                <div class="menu-label">后台管理</div>
                <li>
                    <a href="/views/users" class="menu-link" data-title="用户管理">
                        <i class="fas fa-users-cog"></i>
                        <span>用户管理</span>
                    </a>
                </li>
                <li>
                    <a href="/views/sync" class="menu-link" data-title="同步管理">
                        <i class="fas fa-sync-alt"></i>
                        <span>同步任务</span>
                    </a>
                </li>
                <li>
                    <a href="/views/logs" class="menu-link" data-title="操作日志">
                        <i class="fas fa-history"></i>
                        <span>操作日志</span>
                    </a>
                </li>
            </div>
        </ul>
    </div>
</nav>

<!-- 主内容区 -->
<div class="main-content">
    <!-- 顶部 Header -->
    <header>
        <div class="header-left">
            <!-- 侧边栏缩放开关 -->
            <div class="toggle-btn" id="sidebarToggle" title="切换侧边栏">
                <i class="fas fa-outdent"></i>
            </div>
            <div class="header-title">
                <h2 id="pageTitle">仪表盘</h2>
            </div>
        </div>

        <!-- 用户区域 -->
        <div class="user-wrapper" id="userDropdownTrigger">
            <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" alt="Avatar">
            <div class="user-info">
                <h4 id="userNickname">加载中...</h4>
                <small id="userRole">Student</small>
            </div>
            <i class="fas fa-chevron-down dropdown-indicator"></i>

            <div class="dropdown-menu" id="userDropdown">
                <a href="/views/profile" class="dropdown-item menu-link" data-title="个人中心">
                    <i class="fas fa-user"></i> 个人资料
                </a>
                <a href="#" class="dropdown-item" id="btnLogout">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </a>
            </div>
        </div>
    </header>

    <!-- 内容区域 iframe -->
    <div class="iframe-container">
        <iframe id="contentFrame" src="/dashboard" title="Content"></iframe>
    </div>
</div>

<script>
    const contentFrame = document.getElementById('contentFrame');
    const pageTitle = document.getElementById('pageTitle');
    const menuLinks = document.querySelectorAll('.menu-link');
    const userDropdownTrigger = document.getElementById('userDropdownTrigger');
    const userDropdown = document.getElementById('userDropdown');
    const sidebarToggle = document.getElementById('sidebarToggle');

    document.addEventListener('DOMContentLoaded', () => {
        fetchCurrentUser();
        setupMenuNavigation();
        setupDropdown();
        setupLogout();
        setupSidebarToggle();
    });

    // 缩放逻辑
    function setupSidebarToggle() {
        sidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('collapsed');

            // 切换图标方向
            const icon = sidebarToggle.querySelector('i');
            if (document.body.classList.contains('collapsed')) {
                icon.classList.remove('fa-outdent');
                icon.classList.add('fa-indent');
            } else {
                icon.classList.remove('fa-indent');
                icon.classList.add('fa-outdent');
            }
        });
    }

    function fetchCurrentUser() {
        axios.get('/api/auth/current')
            .then(response => {
                const res = response.data;
                if (res.code === 200 && res.data) {
                    const user = res.data;
                    document.getElementById('userNickname').textContent = user.nickname || user.username;
                    document.getElementById('userRole').textContent = user.role || '用户';
                    if (user.avatar) {
                        document.getElementById('userAvatar').src = user.avatar;
                    } else {
                        document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${user.username}&background=8f94fb&color=fff`;
                    }
                    if (user.role === 'ADMIN' || user.role === 'ROOT') {
                        document.getElementById('adminSection').style.display = 'block';
                    }
                } else {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error("Auth check failed", error);
                window.location.href = '/login';
            });
    }

    function setupMenuNavigation() {
        menuLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') return;
                e.preventDefault();

                menuLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                const targetUrl = this.getAttribute('href');
                document.querySelectorAll(`.sidebar-menu a[href="${targetUrl}"]`).forEach(l => l.classList.add('active'));

                contentFrame.src = targetUrl;
                const title = this.getAttribute('data-title');
                if (title) pageTitle.textContent = title;

                userDropdown.classList.remove('show');
                userDropdownTrigger.classList.remove('active');
            });
        });
    }

    function setupDropdown() {
        userDropdownTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('show');
            userDropdownTrigger.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            userDropdown.classList.remove('show');
            userDropdownTrigger.classList.remove('active');
        });
    }

    function setupLogout() {
        document.getElementById('btnLogout').addEventListener('click', (e) => {
            e.preventDefault();

            Swal.fire({
                title: '确定要退出吗？',
                text: "您将返回登录页面",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4e54c8',
                cancelButtonColor: '#d33',
                confirmButtonText: '退出登录',
                cancelButtonText: '取消',
                heightAuto: false // 关键修复：防止弹窗时页面高度塌缩
            }).then((result) => {
                if (result.isConfirmed) {
                    axios.post('/api/auth/logout')
                        .then(() => {
                            window.location.href = '/login';
                        })
                        .catch(err => {
                            window.location.href = '/login';
                        });
                }
            });
        });
    }
</script>
</body>
</html>