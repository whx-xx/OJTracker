<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJ Tracker - 登录与注册</title>
    <!-- 引入 FontAwesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入 Tailwind CSS (CDN模式，生产环境建议构建) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        error: '#e74c3c',
                        success: '#2ecc71',
                        warning: '#f1c40f',
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    keyframes: {
                        show: {
                            '0%, 49.99%': { opacity: '0', zIndex: '1' },
                            '50%, 100%': { opacity: '1', zIndex: '5' },
                        },
                        slideIn: {
                            'from': { transform: 'translateX(100%)', opacity: '0' },
                            'to': { transform: 'translateX(0)', opacity: '1' }
                        }
                    },
                    animation: {
                        // 配合 HTML 中的 duration-[800ms]，将关键帧动画也延长至 0.8s
                        show: 'show 0.8s',
                        slideIn: 'slideIn 0.3s ease forwards'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-[#a8c0ff] to-[#3f2b96] flex flex-col justify-center items-center h-screen font-poppins text-[#333]">

<!--
  主容器：
  优化点：
  1. transition-all: 保持所有属性过渡
  2. duration-[800ms]: 将过渡时间从 600ms 延长到 800ms，使变宽/变窄或位置变化更平滑
-->
<div class="relative overflow-hidden bg-white rounded-[10px] shadow-2xl group transition-all duration-[1800ms]
            w-full min-h-[550px]
            md:w-[768px] md:min-h-[480px]" id="container">

    <!-- 注册表单区域 -->
    <!--
      优化点：
      1. duration-[1800ms]: 配合容器动画时长
      2. ease-in-out: 保持自然的加减速曲线
    -->
    <div class="absolute top-0 left-0 h-full w-full opacity-0 z-10 transition-all duration-[1800ms] ease-in-out
                md:w-1/2
                md:group-[.right-panel-active]:translate-x-full
                group-[.right-panel-active]:opacity-100 group-[.right-panel-active]:z-50 group-[.right-panel-active]:animate-show">
        <form id="registerForm" class="bg-white flex flex-col items-center justify-center h-full px-[50px] text-center">
            <h1 class="font-bold text-3xl mb-4">创建账户</h1>
            <span class="text-xs mb-4">请使用你的学号进行注册</span>

            <div class="relative w-full my-2">
                <input type="text" id="regStudentNo" placeholder="学号 (20xx... 14位)" required
                       class="bg-gray-100 border-none py-3 pl-12 pr-4 w-full rounded-md outline-none transition-colors duration-300 focus:bg-gray-200 peer" />
                <i class="fas fa-id-card absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 transition-colors duration-300 peer-focus:text-primary"></i>
            </div>

            <div class="relative w-full my-2">
                <input type="text" id="regUsername" placeholder="用户名" required
                       class="bg-gray-100 border-none py-3 pl-12 pr-4 w-full rounded-md outline-none transition-colors duration-300 focus:bg-gray-200 peer" />
                <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 transition-colors duration-300 peer-focus:text-primary"></i>
            </div>

            <div class="relative w-full my-2">
                <input type="password" id="regPassword" placeholder="密码" required
                       class="bg-gray-100 border-none py-3 pl-12 pr-4 w-full rounded-md outline-none transition-colors duration-300 focus:bg-gray-200 peer" />
                <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 transition-colors duration-300 peer-focus:text-primary"></i>
            </div>

            <button type="submit" id="btnRegister"
                    class="mt-4 rounded-[20px] border border-primary bg-primary text-white text-xs font-bold py-3 px-12 uppercase tracking-wider transition-transform duration-80 active:scale-95 focus:outline-none disabled:bg-gray-400 disabled:border-gray-400 disabled:cursor-not-allowed">
                立即注册
            </button>
        </form>
    </div>

    <!-- 登录表单区域 -->
    <!-- 优化点：duration-[1800ms] -->
    <div class="absolute top-0 left-0 h-full w-full z-20 transition-all duration-[1800ms] ease-in-out
                md:w-1/2
                md:group-[.right-panel-active]:translate-x-full">
        <form id="loginForm" class="bg-white flex flex-col items-center justify-center h-full px-[50px] text-center">
            <h1 class="font-bold text-3xl mb-4">欢迎回来</h1>
            <span class="text-xs mb-4">OJ Tracker 数据统计系统</span>

            <!-- 间隔 -->
            <div class="h-5"></div>

            <div class="relative w-full my-2">
                <input type="text" id="loginUsername" placeholder="用户名 / 学号" required
                       class="bg-gray-100 border-none py-3 pl-12 pr-4 w-full rounded-md outline-none transition-colors duration-300 focus:bg-gray-200 peer" />
                <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 transition-colors duration-300 peer-focus:text-primary"></i>
            </div>

            <div class="relative w-full my-2">
                <input type="password" id="loginPassword" placeholder="密码" required
                       class="bg-gray-100 border-none py-3 pl-12 pr-4 w-full rounded-md outline-none transition-colors duration-300 focus:bg-gray-200 peer" />
                <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 transition-colors duration-300 peer-focus:text-primary"></i>
            </div>

            <a href="#" id="forgotPassword" class="text-gray-800 text-sm no-underline my-4 hover:text-primary transition-colors">忘记密码？</a>

            <button type="submit" id="btnLogin"
                    class="mt-2 rounded-[20px] border border-primary bg-primary text-white text-xs font-bold py-3 px-12 uppercase tracking-wider transition-transform duration-80 active:scale-95 focus:outline-none disabled:bg-gray-400 disabled:border-gray-400 disabled:cursor-not-allowed">
                登 录
            </button>
        </form>
    </div>

    <!-- 覆盖层切换区域 (Overlay) -->
    <!-- 优化点：duration-[1800ms] -->
    <div class="absolute top-0 left-1/2 w-1/2 h-full overflow-hidden transition-transform duration-[1800ms] ease-in-out z-[100] hidden
                md:block
                group-[.right-panel-active]:-translate-x-full">
        <div class="bg-gradient-to-r from-secondary to-primary text-white relative -left-full h-full w-[200%] transform transition-transform duration-[1600ms] ease-in-out
                    group-[.right-panel-active]:translate-x-1/2">

            <!-- 左侧面板 (注册后显示，引导去登录) -->
            <div class="absolute flex items-center justify-center flex-col px-10 text-center top-0 h-full w-1/2 transform -translate-x-[20%] transition-transform duration-[1600ms] ease-in-out
                        group-[.right-panel-active]:translate-x-0">
                <h1 class="font-bold text-3xl mb-4">已有账号？</h1>
                <p class="text-sm font-light leading-5 tracking-wide my-5">请登录以查看您的刷题数据统计和分析</p>
                <button class="bg-transparent border border-white rounded-[20px] text-white text-xs font-bold py-3 px-12 uppercase tracking-wider transition-transform duration-80 active:scale-95 focus:outline-none" id="signIn">
                    去登录
                </button>
            </div>

            <!-- 右侧面板 (初始显示，引导去注册) -->
            <div class="absolute flex items-center justify-center flex-col px-10 text-center top-0 h-full w-1/2 right-0 transform translate-x-0 transition-transform duration-[1600ms] ease-in-out
                        group-[.right-panel-active]:translate-x-[20%]">
                <h1 class="font-bold text-3xl mb-4">Hello, Friend!</h1>
                <p class="text-sm font-light leading-5 tracking-wide my-5">输入您的详细信息开始您的算法之旅</p>
                <button class="bg-transparent border border-white rounded-[20px] text-white text-xs font-bold py-3 px-12 uppercase tracking-wider transition-transform duration-80 active:scale-95 focus:outline-none" id="signUp">
                    去注册
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast 容器 -->
<div class="fixed top-5 right-5 z-[9999]" id="toastContainer"></div>

<script>
    // 1. 界面切换逻辑
    const signUpButton = document.getElementById('signUp');
    const signInButton = document.getElementById('signIn');
    const container = document.getElementById('container');

    // 移动端适配逻辑：由于移动端隐藏了 overlay，我们需要在表单底部动态添加切换链接
    function addMobileSwitch() {
        if (window.innerWidth < 768) {
            // 登录表单底部加 "去注册"
            const loginForm = document.getElementById('loginForm');
            if (!document.getElementById('mobile-to-register')) {
                const link = document.createElement('p');
                link.id = 'mobile-to-register';
                link.className = 'mt-6 text-sm text-primary cursor-pointer underline md:hidden font-medium';
                link.innerText = '还没有账号？点此注册';
                link.onclick = () => container.classList.add("right-panel-active");
                // 插入到按钮后面
                loginForm.appendChild(link);
            }

            // 注册表单底部加 "去登录"
            const regForm = document.getElementById('registerForm');
            if (!document.getElementById('mobile-to-login')) {
                const link = document.createElement('p');
                link.id = 'mobile-to-login';
                link.className = 'mt-6 text-sm text-primary cursor-pointer underline md:hidden font-medium';
                link.innerText = '已有账号？点此登录';
                link.onclick = () => container.classList.remove("right-panel-active");
                regForm.appendChild(link);
            }
        }
    }

    // 初始化及监听窗口变化
    addMobileSwitch();
    window.addEventListener('resize', addMobileSwitch);

    signUpButton.addEventListener('click', () => {
        container.classList.add("right-panel-active");
    });

    signInButton.addEventListener('click', () => {
        container.classList.remove("right-panel-active");
    });

    // 2. 工具函数：Toast 提示 (已适配 Tailwind 类名)
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');

        // 基础样式
        let classes = 'flex items-center bg-white px-6 py-4 rounded shadow-lg mb-3 border-l-4 animate-slideIn transition-opacity duration-300';
        let iconClass = 'fa-info-circle text-gray-600';

        // 类型样式
        if (type === 'success') {
            classes += ' border-success';
            iconClass = 'fa-check-circle text-success';
        } else if (type === 'error') {
            classes += ' border-error';
            iconClass = 'fa-exclamation-circle text-error';
        } else if (type === 'warning') {
            classes += ' border-warning';
            iconClass = 'fa-exclamation-triangle text-warning';
        } else {
            classes += ' border-gray-600';
        }

        toast.className = classes;
        toast.innerHTML = `<i class="fas ${iconClass} mr-3"></i><span class="text-sm font-medium text-gray-700">${message}</span>`;

        container.appendChild(toast);

        // 3秒后自动移除
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 修改点：忘记密码点击逻辑
    document.getElementById('forgotPassword').addEventListener('click', function(e) {
        e.preventDefault();
        showToast('请联系管理员重置密码', 'info');
    });

    // 3. 登录逻辑
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const btn = document.getElementById('btnLogin');

        if(!username || !password) {
            showToast('请输入用户名和密码', 'error');
            return;
        }

        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '登录中...';

        axios.post('/api/auth/login', {
            username: username,
            password: password
        })
            .then(function (response) {
                const res = response.data;
                if (res.code === 200) {
                    const user = res.data; // 获取用户信息

                    // === 优化点：检测强制修改密码状态 ===
                    if (user.mustChangePassword === 1) {
                        showToast('登录成功！为了账户安全，请立即修改密码', 'warning');
                    } else {
                        showToast('登录成功，正在跳转...', 'success');
                    }

                    // 延迟跳转，layout.html 会处理后续的锁定逻辑
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    showToast(res.msg || '登录失败', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(function (error) {
                console.error(error);
                showToast('网络请求错误', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
    });

    // 4. 注册逻辑
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const studentNo = document.getElementById('regStudentNo').value;
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const btn = document.getElementById('btnRegister');

        // 简单的前端校验
        if (!studentNo || studentNo.length !== 14 || !studentNo.startsWith('20')) {
            showToast('学号必须是20开头的14位数字', 'error');
            return;
        }

        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '提交中...';

        axios.post('/api/auth/register', {
            studentNo: studentNo,
            username: username,
            password: password
        })
            .then(function (response) {
                const res = response.data;
                if (res.code === 200) {
                    showToast('注册成功！请登录', 'success');
                    // 重置表单
                    document.getElementById('registerForm').reset();
                    // 自动切回登录页
                    setTimeout(() => {
                        container.classList.remove("right-panel-active");
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 1000);
                } else {
                    showToast(res.msg || '注册失败', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(function (error) {
                console.error(error);
                showToast('网络请求错误', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
    });
</script>
</body>
</html>