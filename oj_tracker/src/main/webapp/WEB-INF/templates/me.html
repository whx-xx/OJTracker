<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}">
<head>
    <title>个人中心</title>
</head>
<body>
<div> <div class="row g-4">
    <div class="col-md-4">
        <div class="glass-card text-center h-100">
            <div class="position-relative d-inline-block mb-3">
                <img id="avatarImg" th:src="@{/static/images/default-avatar.png}"
                     class="avatar-circle" onerror="imgError(this)" alt="Avatar">
                <label for="avatarInput" class="position-absolute bottom-0 end-0 bg-primary rounded-circle p-2"
                       style="cursor: pointer; transform: scale(0.8);">
                    <i class="fa-solid fa-camera text-white"></i>
                </label>
                <input type="file" id="avatarInput" hidden accept="image/*">
            </div>

            <h4 id="nicknameDisplay" class="fw-bold mb-1">加载中...</h4>
            <p id="usernameDisplay" class="text-white-50 mb-4">@username</p>

            <div class="d-grid gap-2">
                <button class="btn btn-outline-light btn-sm" onclick="editNickname()">
                    <i class="fa-solid fa-pen"></i> 修改昵称
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="editPassword()">
                    <i class="fa-solid fa-lock"></i> 修改密码
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="glass-card h-100">
            <h5 class="mb-4 border-bottom pb-2 border-secondary">
                <i class="fa-solid fa-link"></i> 绑定 OJ 平台账号
            </h5>
            <div id="platformList" class="list-group list-group-flush">
                <div class="text-center py-4 text-white-50">数据加载中...</div>
            </div>
        </div>
    </div>
</div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            loadPlatforms();
        });

        // 1. 加载用户信息
        function loadUserInfo() {
            axios.get('/api/me').then(res => {
                if(res.code === 200) {
                    const user = res.data;
                    document.getElementById('nicknameDisplay').textContent = user.nickname || '未设置昵称';
                    document.getElementById('usernameDisplay').textContent = '@' + user.username;
                    if(user.avatar) {
                        document.getElementById('avatarImg').src = user.avatar;
                    }
                }
            });
        }

        // 2. 加载平台列表
        function loadPlatforms() {
            axios.get('/api/me/platforms').then(res => {
                if(res.code === 200) {
                    renderPlatforms(res.data);
                }
            });
        }

        function renderPlatforms(list) {
            const container = document.getElementById('platformList');
            container.innerHTML = '';

            if(!list || list.length === 0) {
                container.innerHTML = '<div class="text-center text-white-50">暂无平台数据</div>';
                return;
            }

            list.forEach(p => {
                const isBound = p.account != null;
                const iconClass = isBound ? 'text-success' : 'text-white-50';
                const btnText = isBound ? '解绑' : '绑定';
                const btnClass = isBound ? 'btn-outline-danger' : 'btn-primary-glass';

                const html = `
                        <div class="list-group-item-glass p-3 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 fw-bold">${p.platformName}</h6>
                                <small class="${iconClass}">
                                    <i class="fa-solid ${isBound ? 'fa-check-circle' : 'fa-circle-xmark'}"></i>
                                    ${isBound ? '已绑定: ' + p.account : '未绑定'}
                                </small>
                            </div>
                            <button class="btn btn-sm ${btnClass}"
                                onclick="bindPlatform('${p.platformId}', '${p.platformName}', '${p.account || ''}')">
                                ${btnText}
                            </button>
                        </div>
                    `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // 3. 上传头像
        document.getElementById('avatarInput').addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            axios.post('/api/me/avatar', formData, {
                headers: { 'Content-Type': 'multipart/form-data' }
            }).then(res => {
                if(res.code === 200) {
                    showToast('success', '头像上传成功');
                    document.getElementById('avatarImg').src = res.data; // 更新图片
                } else {
                    showToast('error', res.msg);
                }
            });
        });

        // 4. 修改昵称 (SweetAlert 输入框)
        function editNickname() {
            Swal.fire({
                title: '修改昵称',
                input: 'text',
                inputLabel: '请输入新昵称',
                background: 'rgba(30, 30, 40, 0.95)',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#6a11cb'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    axios.post('/api/me/nickname', { nickname: result.value }).then(res => {
                        if(res.code === 200) {
                            showToast('success', '昵称已更新');
                            loadUserInfo();
                        } else {
                            showToast('error', res.msg);
                        }
                    });
                }
            });
        }

        // 5. 修改密码
        function editPassword() {
            Swal.fire({
                title: '修改密码',
                html:
                    '<input id="swal-old-pass" class="swal2-input" placeholder="旧密码" type="password">' +
                    '<input id="swal-new-pass" class="swal2-input" placeholder="新密码" type="password">' +
                    '<input id="swal-conf-pass" class="swal2-input" placeholder="确认新密码" type="password">',
                focusConfirm: false,
                background: 'rgba(30, 30, 40, 0.95)',
                color: '#fff',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        oldPassword: document.getElementById('swal-old-pass').value,
                        newPassword: document.getElementById('swal-new-pass').value,
                        confirmPassword: document.getElementById('swal-conf-pass').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    axios.post('/api/auth/change-password', result.value).then(res => {
                        if(res.code === 200) {
                            Swal.fire('成功', '密码修改成功，请重新登录', 'success')
                                .then(() => window.location.href = '/login');
                        } else {
                            showToast('error', res.msg);
                        }
                    });
                }
            });
        }

        // 6. 绑定/解绑平台
        function bindPlatform(platformId, platformName, currentAccount) {
            if (currentAccount) {
                // 解绑逻辑
                Swal.fire({
                    title: '确定解绑?',
                    text: `即将解绑 ${platformName} 账号`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    background: 'rgba(30, 30, 40, 0.95)',
                    color: '#fff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // value 为空代表解绑 (参考 MeController 逻辑)
                        updatePlatform(platformId, "");
                    }
                });
            } else {
                // 绑定逻辑
                Swal.fire({
                    title: `绑定 ${platformName}`,
                    input: 'text',
                    inputLabel: '请输入在该平台的账号/Handle',
                    background: 'rgba(30, 30, 40, 0.95)',
                    color: '#fff',
                    showCancelButton: true
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        updatePlatform(platformId, result.value);
                    }
                });
            }
        }

        function updatePlatform(platformId, accountValue) {
            axios.post('/api/me/platforms', {
                platformId: parseInt(platformId),
                account: accountValue // 注意：后端 DTO 字段名为 account 或 value，请根据 UpdateMyPlatformsReq 确认
            }).then(res => {
                if(res.code === 200) {
                    showToast('success', '操作成功');
                    loadPlatforms();
                } else {
                    showToast('error', res.msg);
                }
            });
        }
    </script>
</div>
</body>
</html>