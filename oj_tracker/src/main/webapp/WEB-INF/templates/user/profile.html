<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        dark: '#0f172a', // Slate-900
                        graytext: '#64748b', // Slate-500
                        bg: '#f1f5f9', // Slate-100
                        success: '#10b981', // Emerald-500
                        danger: '#ef4444', // Red-500
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg text-slate-800 font-poppins min-h-screen p-4 md:p-8">

<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

    <!-- 左侧：固定个人信息卡 (占据 4/12) -->
    <!-- 优化：
         1. lg:sticky: 仅在大屏开启粘性定位
         2. lg:top-8: 固定时距离顶部 2rem (与 padding 一致)
         3. h-fit: 确保卡片高度适应内容，不会被拉伸，从而让 sticky 生效
    -->
    <div class="lg:col-span-4 xl:col-span-3">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden lg:sticky lg:top-8 h-fit z-10">
            <!-- 卡片顶部背景 -->
            <div class="h-28 bg-gradient-to-br from-primary to-secondary relative">
                <div class="absolute inset-0 bg-black/10"></div>
                <!-- 装饰圆圈 -->
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>
                <div class="absolute top-10 -left-10 w-24 h-24 bg-white/10 rounded-full blur-lg"></div>
            </div>

            <div class="px-6 pb-8 relative">
                <!-- 头像 (上浮) -->
                <div class="relative -mt-14 mb-4 flex justify-center">
                    <div class="relative group">
                        <div class="w-28 h-28 rounded-full p-1 bg-white shadow-xl">
                            <img id="avatarImg" src="" alt="Avatar" class="w-full h-full rounded-full object-cover border border-slate-100">
                        </div>
                        <label for="avatarInput" class="absolute bottom-1 right-1 bg-dark text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:bg-primary transition-all duration-300 ring-4 ring-white z-10 hover:scale-110" title="更换头像">
                            <i class="fas fa-camera text-xs"></i>
                        </label>
                        <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="uploadAvatar()">
                    </div>
                </div>

                <!-- 姓名与角色 -->
                <div class="text-center mb-8">
                    <h2 class="text-xl font-bold text-dark mb-1" id="displayUsername">Loading...</h2>
                    <span class="inline-block px-3 py-1 rounded-full bg-slate-100 text-primary text-xs font-semibold border border-slate-200" id="displayRole">User</span>
                </div>

                <!-- 信息列表 -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <span class="text-xs font-medium text-slate-500">学号</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-700 font-mono" id="infoStudentNo">--</span>
                    </div>

                    <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100 group cursor-pointer hover:bg-white hover:shadow-sm transition-all" onclick="toggleNicknameEdit()">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs">
                                <i class="fas fa-user-tag"></i>
                            </div>
                            <span class="text-xs font-medium text-slate-500">昵称</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold text-slate-700" id="infoNickname">--</span>
                            <i class="fas fa-pen text-[10px] text-slate-300 group-hover:text-primary transition-colors"></i>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                    <p class="text-xs text-slate-400">Member since 2026</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧：功能区域 (占据 8/12) -->
    <div class="lg:col-span-8 xl:col-span-9 space-y-8">

        <!-- 平台绑定板块 -->
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 pb-6 border-b border-slate-100">
                <div>
                    <h3 class="text-lg font-bold text-dark flex items-center gap-2">
                        <span class="w-1 h-6 bg-primary rounded-full"></span>
                        平台账号绑定
                    </h3>
                    <p class="text-sm text-slate-500 mt-1 ml-3">关联您的 OJ 账号以同步解题数据</p>
                </div>
                <button class="px-5 py-2.5 bg-dark text-white text-sm font-medium rounded-lg shadow-md hover:bg-primary transition-all flex items-center gap-2 active:scale-95" onclick="openBindModal()">
                    <i class="fas fa-plus"></i> 绑定新账号
                </button>
            </div>

            <!-- 平台列表 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="platformList">
                <div class="md:col-span-2 text-center py-10">
                    <i class="fas fa-spinner fa-spin text-primary text-2xl"></i>
                </div>
            </div>

            <p class="text-xs text-slate-400 mt-4 flex items-center gap-1">
                <i class="fas fa-info-circle"></i> 提示：绑定新账号将直接覆盖当前同平台的旧账号。
            </p>
        </section>

        <!-- 安全设置板块 -->
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
            <div class="mb-6 pb-6 border-b border-slate-100">
                <h3 class="text-lg font-bold text-dark flex items-center gap-2">
                    <span class="w-1 h-6 bg-emerald-500 rounded-full"></span>
                    安全设置
                </h3>
                <p class="text-sm text-slate-500 mt-1 ml-3">修改登录密码，建议定期更换以保护账户安全</p>
            </div>

            <form id="passwordForm" onsubmit="changePassword(event)" class="max-w-2xl">
                <div class="space-y-5">
                    <!-- 当前密码 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">当前密码</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary transition-colors">
                                <i class="fas fa-lock"></i>
                            </div>
                            <input type="password" id="oldPass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder-slate-400" placeholder="请输入当前使用的密码" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <!-- 新密码 -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">新密码</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary transition-colors">
                                    <i class="fas fa-key"></i>
                                </div>
                                <input type="password" id="newPass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder-slate-400" placeholder="设置新密码" required>
                            </div>
                        </div>

                        <!-- 确认密码 -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">确认新密码</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary transition-colors">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <input type="password" id="confirmPass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder-slate-400" placeholder="再次输入新密码" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" class="px-8 py-3 bg-slate-800 hover:bg-primary text-white font-medium rounded-xl shadow-lg shadow-slate-200 hover:shadow-xl transition-all duration-300 transform active:scale-[0.98] flex items-center gap-2">
                        <i class="fas fa-save"></i> 保存修改
                    </button>
                </div>
            </form>
        </section>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadUserProfile();
        loadMyPlatforms();
    });

    // 加载用户信息 (接口: /api/me)
    function loadUserProfile() {
        axios.get('/api/me')
            .then(res => {
                if (res.data.code === 200) {
                    const user = res.data.data;
                    document.getElementById('displayUsername').textContent = user.username;
                    document.getElementById('displayRole').textContent = user.role;
                    document.getElementById('infoStudentNo').textContent = user.studentNo;
                    document.getElementById('infoNickname').textContent = user.nickname || user.username;

                    const avatar = user.avatar || `https://ui-avatars.com/api/?name=${user.username}&background=random&color=fff`;
                    document.getElementById('avatarImg').src = avatar;
                }
            })
            .catch(console.error);
    }

    // 加载平台列表 (接口: /api/me/platforms)
    function loadMyPlatforms() {
        const container = document.getElementById('platformList');
        axios.get('/api/me/platforms')
            .then(res => {
                if (res.data.code === 200) {
                    const list = res.data.data || [];
                    container.innerHTML = '';

                    if(list.length === 0) {
                        // 使用 Tailwind 样式
                        container.innerHTML = `
                            <div class="md:col-span-2 flex flex-col items-center justify-center py-10 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300">
                                    <i class="fas fa-link-slash text-xl"></i>
                                </div>
                                <p class="text-slate-500 text-sm font-medium">暂无绑定账号</p>
                            </div>
                        `;
                        return;
                    }

                    list.forEach(item => {
                        const iconUrl = 'https://cdn.iconscout.com/icon/free/png-256/free-code-forces-3628695-3029920.png';

                        const div = document.createElement('div');
                        // 卡片样式
                        div.className = 'flex items-center p-4 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md hover:border-primary/30 transition-all duration-300 group relative overflow-hidden';

                        // 装饰背景角标
                        const bgDeco = `<div class="absolute -right-4 -top-4 w-16 h-16 bg-gradient-to-br from-slate-50 to-slate-100 rounded-full opacity-50 group-hover:bg-primary/5 transition-colors"></div>`;

                        div.innerHTML = `
                                ${bgDeco}
                                <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center p-2 shrink-0 border border-slate-100 mr-4 z-10">
                                    <img src="${iconUrl}" alt="CF" class="w-full h-full object-contain">
                                </div>
                                <div class="flex-1 min-w-0 z-10">
                                    <div class="flex justify-between items-start">
                                        <h4 class="text-sm font-bold text-slate-700 leading-tight truncate">${item.platformCode || 'Codeforces'}</h4>
                                        <span class="text-[10px] font-semibold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100 flex items-center gap-1">
                                            <i class="fas fa-check-circle"></i> 已绑定
                                        </span>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1 truncate">
                                        Handle: <span class="font-medium text-slate-700 font-mono bg-slate-100 px-1 rounded">${item.identifierValue}</span>
                                    </p>
                                </div>
                            `;
                        container.appendChild(div);
                    });
                }
            });
    }

    // 修改昵称
    function toggleNicknameEdit() {
        const span = document.getElementById('infoNickname');
        const currentName = span.textContent;

        Swal.fire({
            title: '修改昵称',
            input: 'text',
            inputValue: currentName,
            showCancelButton: true,
            confirmButtonText: '保存',
            cancelButtonText: '取消',
            confirmButtonColor: '#4e54c8',
            customClass: {
                confirmButton: 'bg-primary',
            },
            inputValidator: (value) => {
                if (!value) {
                    return '昵称不能为空!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                axios.post('/api/me/nickname', { nickname: result.value })
                    .then(res => {
                        if(res.data.code === 200) {
                            Swal.fire({ icon: 'success', title: '昵称已更新', timer: 1500, showConfirmButton: false });
                            loadUserProfile();
                        } else {
                            Swal.fire('失败', res.data.msg, 'error');
                        }
                    });
            }
        });
    }

    // 修改密码 (三框验证)
    function changePassword(e) {
        e.preventDefault();
        const oldPassword = document.getElementById('oldPass').value;
        const newPassword = document.getElementById('newPass').value;
        const confirmPassword = document.getElementById('confirmPass').value;

        if (newPassword !== confirmPassword) {
            Swal.fire({ icon: 'error', title: '两次输入的新密码不一致', timer: 1500, showConfirmButton: false });
            return;
        }

        axios.post('/api/auth/change-password', {
            oldPassword: oldPassword,
            newPassword: newPassword,
            confirmPassword: confirmPassword
        }).then(res => {
            if(res.data.code === 200) {
                Swal.fire({
                    title: '修改成功',
                    text: '密码已更新，请使用新密码重新登录',
                    icon: 'success',
                    confirmButtonText: '重新登录',
                    confirmButtonColor: '#4e54c8',
                    allowOutsideClick: false
                }).then(() => {
                    axios.post('/api/auth/logout').finally(() => {
                        window.parent.location.href = '/login';
                    });
                });
            } else {
                Swal.fire('失败', res.data.msg, 'error');
            }
        }).catch(err => {
            Swal.fire('错误', '网络请求失败', 'error');
        });
    }

    // 绑定账号 (逻辑保持覆盖更新)
    function openBindModal() {
        Swal.fire({
            title: '绑定 Codeforces 账号',
            html: `
                    <div class="text-left bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4">
                        <p class="text-xs text-blue-600 flex items-start gap-2">
                            <i class="fas fa-info-circle mt-0.5"></i>
                            <span>输入新的 Handle 将直接覆盖旧的绑定账号。请确保 Handle 输入正确。</span>
                        </p>
                    </div>
                    <input id="swal-input1" class="swal2-input !m-0 !w-full" placeholder="请输入你的 Handle (用户名)">
                `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: '绑定',
            cancelButtonText: '取消',
            confirmButtonColor: '#4e54c8',
            preConfirm: () => {
                return document.getElementById('swal-input1').value;
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                const handle = result.value;

                // 1. 获取当前列表
                axios.get('/api/me/platforms').then(res => {
                    let currentItems = [];
                    if(res.data.code === 200 && res.data.data) {
                        // 过滤掉旧的 CF 绑定，实现"覆盖"效果
                        currentItems = res.data.data
                            .filter(p => p.platformCode !== 'CF')
                            .map(p => ({
                                platformId: p.platformId || 1, // 假设 1 是 CF 的 ID
                                identifierType: 'USERNAME',
                                identifierValue: p.identifierValue
                            }));
                    }

                    // 2. 添加新的绑定
                    currentItems.push({
                        platformId: 1,
                        identifierType: 'USERNAME',
                        identifierValue: handle
                    });

                    // 3. 提交更新
                    return axios.post('/api/me/platforms', { items: currentItems });
                }).then(res => {
                    if(res.data.code === 200) {
                        Swal.fire({ icon: 'success', title: '绑定请求已提交', timer: 1500, showConfirmButton: false });
                        loadMyPlatforms();
                        // 触发后端刷新 (可选)
                        // axios.post('/api/user/submissions/refresh?platformCode=CF');
                    } else {
                        Swal.fire('失败', res.data.msg, 'error');
                    }
                }).catch(err => {
                    Swal.fire('错误', '请求处理失败', 'error');
                    console.error(err);
                });
            }
        });
    }

    // 上传头像
    function uploadAvatar() {
        const fileInput = document.getElementById('avatarInput');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
        });
        Toast.fire({ icon: 'info', title: '正在上传头像...' });

        axios.post('/api/me/avatar', formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
            if(res.data.code === 200) {
                Toast.fire({ icon: 'success', title: '头像更新成功' });
                const newUrl = res.data.data;
                document.getElementById('avatarImg').src = newUrl;
                // 尝试更新父级 Layout 头像
                if(window.parent && window.parent.document.getElementById('userAvatar')) {
                    window.parent.document.getElementById('userAvatar').src = newUrl;
                }
            } else {
                Toast.fire({ icon: 'error', title: res.data.msg });
            }
        }).catch(err => {
            Toast.fire({ icon: 'error', title: '上传失败' });
        });
    }
</script>
</body>
</html>