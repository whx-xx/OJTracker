<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>团队榜单</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // CF 标准色系参考
                        cf: {
                            gray: '#808080',
                            green: '#008000',
                            cyan: '#03a89e',
                            blue: '#0000ff',
                            violet: '#a0a',
                            orange: '#ff8c00',
                            red: '#ff0000',
                            legendary: '#000000' // LGM 首字母黑
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 8px -2px rgba(0, 0, 0, 0.05), 0 1px 3px 0 rgba(0, 0, 0, 0.02)',
                        'card-hover': '0 10px 25px -5px rgba(0, 0, 0, 0.08), 0 8px 10px -6px rgba(0, 0, 0, 0.01)',
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* 动画类 */
        .fade-in-up {
            animation: fadeInUp 0.4s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CF 名字颜色类 */
        .cf-user-gray { color: #808080 !important; font-weight: bold; }
        .cf-user-green { color: #008000 !important; font-weight: bold; }
        .cf-user-cyan { color: #03a89e !important; font-weight: bold; }
        .cf-user-blue { color: #0000ff !important; font-weight: bold; }
        .cf-user-violet { color: #a0a !important; font-weight: bold; }
        .cf-user-orange { color: #ff8c00 !important; font-weight: bold; }
        .cf-user-red { color: #ff0000 !important; font-weight: bold; }
        .cf-user-legendary { color: #ff0000 !important; font-weight: bold; }
        .cf-user-legendary::first-letter { color: black !important; }

        /* 排行榜网格布局定义 - 调整列宽以获得更舒适的对齐 */
        .rank-grid {
            display: grid;
            grid-template-columns: 3.5rem minmax(0, 1fr) 4rem; /* 移动端：Rank | User | Rating */
            align-items: center;
            gap: 1rem;
        }
        @media (min-width: 640px) { /* sm */
            .rank-grid {
                /* Rank | User (Larger) | Handle | Rating | Updated */
                grid-template-columns: 4rem 5fr 3fr 1.5fr 1.5fr;
                gap: 1.5rem; /* 增加列间距让视觉更透气 */
            }
        }
        @media (min-width: 1024px) { /* lg */
            .rank-grid {
                grid-template-columns: 4.5rem 6fr 4fr 1.5fr 1.5fr;
            }
        }
    </style>
</head>
<body class="bg-slate-50/80 text-slate-800 font-sans min-h-screen selection:bg-blue-100 selection:text-blue-700">

<!-- 主容器 -->
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-32">

    <!-- 顶部功能区：搜索 -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 fade-in-up">
        <!-- 统计概览 -->
        <div class="text-sm text-slate-500 font-medium">
            <i class="fas fa-chart-simple mr-2 text-slate-400"></i> Codeforces Rating Leaderboard
        </div>

        <!-- 搜索框 -->
        <div class="relative w-full sm:w-72 group">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
            </div>
            <input type="text" id="searchInput" onkeyup="handleSearch()"
                   class="block w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-full text-sm placeholder-slate-400 shadow-sm focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300 hover:shadow-md"
                   placeholder="搜索选手...">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <span class="text-[10px] text-slate-300 border border-slate-100 rounded px-1.5 py-0.5 hidden group-focus-within:inline-block bg-slate-50">ESC</span>
            </div>
        </div>
    </div>

    <!-- 表头 (隐形 Grid，增加下划线和清晰度) -->
    <div class="rank-grid px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 select-none hidden sm:grid fade-in-up border-b border-slate-200 bg-white/50 backdrop-blur-sm rounded-t-lg" style="animation-delay: 0.1s;">
        <div class="text-center">排名</div>
        <div class="pl-2">选手信息</div> <!-- 增加 pl-2 微调对齐头像 -->
        <div class="hidden sm:block">CF Handle</div>
        <div class="text-center">Rating</div>
        <div class="text-right hidden lg:block">最近活跃</div>
    </div>

    <!-- 列表容器 -->
    <div id="rankingList" class="space-y-3 relative min-h-[400px]">
        <!-- JS 将在这里插入卡片 -->

        <!-- Loading 占位 -->
        <div class="flex flex-col items-center justify-center py-20 fade-in-up" id="loadingState">
            <div class="w-10 h-10 border-2 border-slate-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
            <span class="text-slate-400 text-sm">正在同步数据...</span>
        </div>

        <!-- 空状态占位 -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center fade-in-up">
            <div class="w-14 h-14 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300">
                <i class="fas fa-search text-xl"></i>
            </div>
            <h3 class="text-slate-700 font-medium">无匹配结果</h3>
        </div>
    </div>

    <!-- 分页 -->
    <div class="mt-8 flex justify-center fade-in-up" id="paginationContainer" style="display:none; animation-delay: 0.2s;">
        <div class="bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-1" id="pagination">
            <!-- JS 生成页码 -->
        </div>
    </div>
</div>

<!-- 底部悬浮：我的排名 (Dock Style - Modern Dark) -->
<div id="myRankBar" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-xl z-50 transition-all duration-700 translate-y-[150%] opacity-0">
    <div class="bg-slate-900/85 backdrop-blur-xl border border-white/10 text-white rounded-2xl shadow-2xl shadow-slate-900/30 p-2 pr-5 flex items-center justify-between ring-1 ring-white/5">

        <div class="flex items-center gap-3">
            <div class="relative">
                <img id="myAvatar" src="" class="w-10 h-10 rounded-full object-cover border border-white/20">
                <div id="myRankBadge" class="absolute -top-1.5 -right-1.5 min-w-[1.25rem] h-5 bg-blue-500 text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-slate-900 shadow-sm px-1">
                    -
                </div>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider leading-tight">My Rank</span>
                <span class="text-sm font-bold text-slate-100 truncate max-w-[120px]" id="myName">User</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="h-8 w-px bg-white/10"></div>
            <div class="text-right">
                <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-0.5">Rating</div>
                <div class="text-lg font-bold font-mono tracking-tight leading-none" id="myRatingDisplay">
                    <span id="myRating" class="text-white">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    let allRankings = [];
    let filteredRankings = [];
    let currentPage = 1;
    const pageSize = 20;
    let currentUser = null;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                const input = document.getElementById('searchInput');
                if(document.activeElement === input) {
                    input.value = '';
                    handleSearch();
                    input.blur();
                }
            }
        });

        fetchCurrentUser().then(() => {
            loadRankings('CF');
        });
    });

    // --- API Calls ---
    function fetchCurrentUser() {
        return axios.get('/api/me')
            .then(res => {
                if (res.data.code === 200) {
                    currentUser = res.data.data;
                }
            })
            .catch(err => console.log("Guest or auth error"));
    }

    function loadRankings(platformCode) {
        axios.get('/api/team/rankings', { params: { platformCode: platformCode } })
            .then(res => {
                document.getElementById('loadingState').remove(); // 移除 Loading

                if (res.data.code === 200) {
                    allRankings = res.data.data || [];
                    allRankings.sort((a, b) => b.rating - a.rating);

                    allRankings.forEach((item, index) => {
                        item.originalRank = index + 1;
                    });

                    filteredRankings = [...allRankings];

                    renderMyRank();

                    if (filteredRankings.length === 0) {
                        showEmpty(true);
                    } else {
                        showEmpty(false);
                        changePage(1);
                    }
                } else {
                    alert("数据加载失败: " + res.data.msg);
                }
            })
            .catch(err => {
                const loading = document.getElementById('loadingState');
                if(loading) loading.innerHTML = `<span class="text-red-400">网络请求失败</span>`;
            });
    }

    // --- Interaction ---
    function handleSearch() {
        const input = document.getElementById('searchInput');
        const keyword = input.value.toLowerCase().trim();

        if (!keyword) {
            filteredRankings = [...allRankings];
        } else {
            filteredRankings = allRankings.filter(item => {
                const nick = (item.nickname || '').toLowerCase();
                const handle = (item.handle || '').toLowerCase();
                const stNo = (item.studentNo || '').toLowerCase();
                return nick.includes(keyword) || handle.includes(keyword) || stNo.includes(keyword);
            });
        }

        currentPage = 1;
        changePage(1);
    }

    function changePage(page) {
        const total = filteredRankings.length;
        if (total === 0) {
            showEmpty(true);
            return;
        }

        const totalPages = Math.ceil(total / pageSize);
        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = filteredRankings.slice(start, end);

        renderList(pageData, start);
        renderPagination(total, totalPages);
    }

    // --- Rendering Core (Card List) ---
    function renderList(list, startIndex) {
        const container = document.getElementById('rankingList');
        // 保留 Loading 和 Empty div，只清空生成的卡片
        const staticElements = Array.from(container.children).filter(el => el.id === 'loadingState' || el.id === 'emptyState');
        container.innerHTML = '';
        staticElements.forEach(el => container.appendChild(el));

        list.forEach((item, index) => {
            const card = document.createElement('div');
            // Card Styles
            // 确保 padding 与表头对齐: px-6 (desktop)
            card.className = "rank-grid bg-white rounded-xl p-3 sm:px-6 sm:py-4 shadow-card hover:shadow-card-hover hover:-translate-y-0.5 transition-all duration-300 border border-slate-100 group cursor-default relative overflow-hidden";

            // Animation Stagger
            card.style.animation = `fadeInUp 0.4s ease-out forwards ${index * 0.05}s`;
            card.style.opacity = '0'; // Initial state for animation

            const rank = item.originalRank;

            // Rank Display
            let rankHtml;
            if (rank <= 3) {
                const colors = {
                    1: 'text-yellow-500 bg-yellow-50 border-yellow-100',
                    2: 'text-slate-500 bg-slate-100 border-slate-200',
                    3: 'text-orange-500 bg-orange-50 border-orange-100'
                };
                const icons = { 1: 'fa-trophy', 2: 'fa-medal', 3: 'fa-medal' };

                rankHtml = `
                    <div class="flex justify-center">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full ${colors[rank]} border flex items-center justify-center shadow-sm">
                            <i class="fas ${icons[rank]} text-sm sm:text-base"></i>
                        </div>
                    </div>
                `;
                // Side accent for top 3
                const accentColors = { 1: 'bg-yellow-400', 2: 'bg-slate-300', 3: 'bg-orange-400' };
                card.innerHTML += `<div class="absolute left-0 top-0 bottom-0 w-1 ${accentColors[rank]}"></div>`;
            } else {
                rankHtml = `<div class="text-center font-mono font-bold text-slate-400 text-sm sm:text-lg">#${rank}</div>`;
            }

            // Data Prep
            const avatar = item.avatar || `https://ui-avatars.com/api/?name=${item.nickname || 'User'}&background=random&color=fff&size=64`;
            const cfClass = getCfColorClass(item.rating);
            const displayName = item.nickname || 'Unknown';
            const displayId = item.studentNo || '';
            const handleDisplay = item.handle ? item.handle : '--';

            // HTML Structure (Matches Grid CSS)
            card.innerHTML += `
                <!-- Rank -->
                ${rankHtml}

                <!-- User Info -->
                <div class="flex items-center gap-3 sm:gap-4 overflow-hidden pl-1">
                    <img src="${avatar}" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full object-cover bg-slate-50 border border-slate-100 group-hover:scale-105 transition-transform duration-300 shrink-0">
                    <div class="flex flex-col min-w-0">
                        <span class="text-sm sm:text-base truncate font-semibold text-slate-700">${displayName}</span>
                        ${displayId ? `<span class="text-xs text-slate-400 font-mono mt-0.5 truncate">${displayId}</span>` : ''}
                    </div>
                </div>

                <!-- Handle (Hidden on Mobile) -->
                <div class="hidden sm:block truncate">
                     ${handleDisplay !== '--'
                ? `<a href="https://codeforces.com/profile/${handleDisplay}" target="_blank" class="inline-flex items-center gap-0.5 text-xs sm:text-sm font-mono font-medium hover:opacity-75 transition-opacity">
                             <span class="text-slate-400 mr-0.5">@</span><span class="${cfClass}">${handleDisplay}</span> <i class="fas fa-external-link-alt text-[10px] opacity-40 ml-1 text-slate-400"></i>
                           </a>`
                : '<span class="text-slate-300 text-sm font-mono">--</span>'}
                </div>

                <!-- Rating -->
                <div class="text-center">
                    <span class="font-mono font-bold text-base sm:text-lg ${cfClass}">${item.rating}</span>
                    <div class="text-[10px] text-slate-400 uppercase tracking-wide sm:hidden">Rating</div>
                </div>

                <!-- Updated (Hidden on smaller screens) -->
                <div class="text-right hidden lg:block">
                    <span class="text-xs text-slate-400 font-medium bg-slate-50 px-2 py-1 rounded-full border border-slate-100">
                        ${formatTimeAgo(item.snapshotTime)}
                    </span>
                </div>
            `;
            container.appendChild(card);
        });

        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('paginationContainer').style.display = 'flex';
    }

    function renderPagination(total, totalPages) {
        const container = document.getElementById('pagination');
        let html = '';

        const btnBase = "w-8 h-8 flex items-center justify-center rounded-lg text-xs font-medium transition-all duration-200";
        const activeClass = "bg-blue-600 text-white shadow-md shadow-blue-200";
        const normalClass = "text-slate-500 hover:bg-slate-100 hover:text-blue-600";
        const disabledClass = "text-slate-300 cursor-not-allowed";

        // Prev
        html += `<button class="${btnBase} ${currentPage === 1 ? disabledClass : normalClass}" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;

        // Simple dots logic
        const range = [];
        if (totalPages <= 7) {
            for(let i=1; i<=totalPages; i++) range.push(i);
        } else {
            range.push(1);
            if (currentPage > 3) range.push('...');
            let start = Math.max(2, currentPage - 1);
            let end = Math.min(totalPages - 1, currentPage + 1);
            for (let i = start; i <= end; i++) range.push(i);
            if (currentPage < totalPages - 2) range.push('...');
            range.push(totalPages);
        }

        range.forEach(p => {
            if (p === '...') {
                html += `<span class="${btnBase} text-slate-300">...</span>`;
            } else {
                html += `<button class="${btnBase} ${p === currentPage ? activeClass : normalClass}" onclick="changePage(${p})">${p}</button>`;
            }
        });

        // Next
        html += `<button class="${btnBase} ${currentPage === totalPages ? disabledClass : normalClass}" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;

        container.innerHTML = html;
    }

    // --- Helpers ---
    function getCfColorClass(rating) {
        if (rating < 1200) return 'cf-user-gray';
        if (rating < 1400) return 'cf-user-green';
        if (rating < 1600) return 'cf-user-cyan';
        if (rating < 1900) return 'cf-user-blue';
        if (rating < 2100) return 'cf-user-violet';
        if (rating < 2300) return 'cf-user-orange';
        if (rating < 2400) return 'cf-user-orange';
        if (rating < 2600) return 'cf-user-red';
        if (rating < 3000) return 'cf-user-red';
        return 'cf-user-legendary';
    }

    function formatTimeAgo(isoStr) {
        if (!isoStr) return '-';
        const date = new Date(isoStr);
        const now = new Date();
        const diff = (now - date) / 1000;
        if (diff < 60) return '刚刚';
        if (diff < 3600) return Math.floor(diff / 60) + '分钟前';
        if (diff < 86400) return Math.floor(diff / 3600) + '小时前';
        return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // --- My Rank Bar ---
    function renderMyRank() {
        if (!currentUser) return;
        const myEntry = allRankings.find(r => r.userId === currentUser.id || r.studentNo === currentUser.studentNo);
        if (myEntry) {
            const bar = document.getElementById('myRankBar');
            document.getElementById('myAvatar').src = currentUser.avatar || `https://ui-avatars.com/api/?name=${currentUser.username}&background=random&color=fff`;
            document.getElementById('myName').textContent = myEntry.nickname || currentUser.username;
            const ratingEl = document.getElementById('myRating');
            ratingEl.textContent = myEntry.rating;
            ratingEl.className = `${getCfColorClass(myEntry.rating)} text-xl`;
            document.getElementById('myRankBadge').textContent = myEntry.originalRank;
            setTimeout(() => {
                bar.classList.remove('translate-y-[150%]', 'opacity-0');
                bar.classList.add('translate-y-0', 'opacity-100');
            }, 500);
        }
    }

    function showEmpty(isEmpty) {
        const emptyDiv = document.getElementById('emptyState');
        const pagination = document.getElementById('paginationContainer');
        if (isEmpty) {
            emptyDiv.classList.remove('hidden');
            pagination.style.display = 'none';
        } else {
            emptyDiv.classList.add('hidden');
        }
    }
</script>
</body>
</html>