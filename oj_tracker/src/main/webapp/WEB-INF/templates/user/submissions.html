<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提交记录与笔记</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Markdown & Math Support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <!-- KaTeX for LaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        dark: '#1e293b', // Slate-800
                        graytext: '#64748b', // Slate-500
                        bg: '#f8fafc', // Slate-50
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条样式 */
        body.swal2-shown > [aria-hidden="true"] {
            transition: 0.1s filter;
            filter: blur(2px);
        }

        /* Markdown Preview Styles (Simplified Typography) */
        .prose h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #1e293b; }
        .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #334155; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25rem; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; color: #475569; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose blockquote { border-left: 4px solid #cbd5e1; padding-left: 1rem; font-style: italic; color: #64748b; margin-bottom: 1rem; }
        .prose code { background-color: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; color: #ef4444; }
        .prose pre { background-color: #1e293b; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
        .prose pre code { background-color: transparent; color: #e2e8f0; padding: 0; }
        .prose a { color: #4e54c8; text-decoration: underline; }
        .prose img { max-width: 100%; border-radius: 0.5rem; }

        /* Custom Scrollbar for Note Editor */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-bg text-dark font-poppins min-h-screen p-4 md:p-8 overflow-y-auto">

<div class="max-w-5xl mx-auto space-y-6">

    <!-- 顶部操作栏 -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <!-- 筛选按钮组 -->
        <div class="flex p-1 bg-slate-100 rounded-xl w-full md:w-auto">
            <button type="button" class="filter-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-dark focus:outline-none bg-white text-primary shadow-sm" data-range="TODAY" onclick="changeRange('TODAY')">今日</button>
            <button type="button" class="filter-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-dark focus:outline-none" data-range="WEEK" onclick="changeRange('WEEK')">本周</button>
            <button type="button" class="filter-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-dark focus:outline-none" data-range="MONTH" onclick="changeRange('MONTH')">本月</button>
            <button type="button" class="filter-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-dark focus:outline-none" data-range="ALL" onclick="changeRange('ALL')">全部</button>
        </div>

        <!-- 搜索与同步 -->
        <div class="flex gap-3 w-full md:w-auto">
            <div class="relative w-full md:w-64 group">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-primary transition-colors"></i>
                <input type="text" id="searchInput" class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder-slate-400" placeholder="搜索题目或标签 (如: dp)..." onkeyup="handleSearchDebounced()">
            </div>
            <button type="button" class="bg-primary hover:bg-primary/90 text-white px-4 py-2.5 rounded-xl text-sm font-medium shadow-sm shadow-indigo-200 transition-all active:scale-95 flex items-center gap-2 whitespace-nowrap" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> <span class="hidden sm:inline">同步</span>
            </button>
        </div>
    </div>

    <!-- 内容区域 -->
    <div class="relative">
        <!-- 时间轴容器 -->
        <div id="timeline-container" class="space-y-6 pl-4 md:pl-0">
            <!-- JS 动态填充 -->
            <div class="text-center py-16 text-graytext">
                <div class="flex flex-col items-center gap-3">
                    <i class="fas fa-spinner fa-spin text-2xl text-primary/50"></i>
                    <span>加载记录中...</span>
                </div>
            </div>
        </div>

        <!-- 分页容器 -->
        <div class="mt-8 bg-white rounded-xl border border-slate-200 p-4 flex flex-col sm:flex-row justify-between items-center gap-4" id="paginationContainer" style="display:none;">
            <div class="text-xs text-graytext font-medium" id="pageInfo"></div>
            <div class="flex items-center gap-1" id="pagination"></div>
        </div>
    </div>
</div>

<!-- Note Editor Modal -->
<div id="noteModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Background backdrop -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeNoteModal()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal panel -->
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 w-full max-w-6xl h-[85vh] flex flex-col">

                <!-- Header -->
                <div class="bg-white px-4 py-3 sm:px-6 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold leading-6 text-gray-900" id="modal-title">
                            <i class="fas fa-edit text-primary mr-2"></i>题目笔记
                        </h3>
                        <p class="text-xs text-slate-500 mt-1">支持 Markdown 和 LaTeX 公式 ($E=mc^2$)</p>
                    </div>
                    <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" onclick="closeNoteModal()">
                        <span class="sr-only">Close</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Content Area (Split View) -->
                <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                    <!-- Editor -->
                    <div class="w-full md:w-1/2 p-4 border-r border-slate-200 bg-slate-50 flex flex-col">
                        <label for="noteEditor" class="text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wide">编辑内容 (Markdown)</label>
                        <textarea id="noteEditor" class="flex-1 w-full p-4 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-primary resize-none font-mono text-sm leading-relaxed custom-scrollbar focus:outline-none" placeholder="# 笔记标题&#10;&#10;- 核心思路&#10;- 时间复杂度 $O(N \log N)$&#10;&#10;```cpp&#10;int main() { ... }&#10;```"></textarea>
                    </div>

                    <!-- Preview -->
                    <div class="w-full md:w-1/2 p-4 bg-white flex flex-col">
                        <div class="text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wide flex justify-between items-center">
                            <span>预览 (Preview)</span>
                            <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-400">Auto-render</span>
                        </div>
                        <div id="notePreview" class="flex-1 overflow-y-auto custom-scrollbar prose prose-sm max-w-none p-2">
                            <!-- Rendered content goes here -->
                            <div class="text-slate-400 italic text-center mt-10">输入内容以开始预览...</div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-slate-200">
                    <button type="button" id="saveNoteBtn" class="inline-flex w-full justify-center rounded-lg bg-primary px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 sm:ml-3 sm:w-auto transition-all active:scale-95 items-center gap-2" onclick="saveNotes()">
                        <i class="fas fa-save"></i> 保存笔记
                    </button>
                    <button type="button" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition-all" onclick="closeNoteModal()">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<script>
    // 全局状态
    let currentState = {
        range: 'TODAY',
        page: 1,
        size: 10,
        loading: false
    };

    let searchTimeout;
    let currentEditingId = null; // 当前正在编辑的 SolvedProblem ID

    $(document).ready(function() {
        loadData();
        initNoteEditor();
    });

    // --- 工具函数 ---

    function showToast(message, type = 'info') {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        Toast.fire({ icon: type, title: message });
    }

    // --- 笔记/Markdown 功能 ---

    function initNoteEditor() {
        const editor = document.getElementById('noteEditor');

        // 支持 Tab 缩进
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "\t" + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 1;
            }
        });

        // 实时预览防抖
        let renderTimeout;
        editor.addEventListener('input', function() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                renderPreview(this.value);
            }, 300);
        });
    }

    function renderPreview(markdown) {
        const previewDiv = document.getElementById('notePreview');
        if (!markdown || markdown.trim() === '') {
            previewDiv.innerHTML = '<div class="text-slate-400 italic text-center mt-10">输入内容以开始预览...</div>';
            return;
        }

        // 1. Markdown -> HTML
        const rawHtml = marked.parse(markdown);
        // 2. Sanitize HTML
        const cleanHtml = DOMPurify.sanitize(rawHtml);

        previewDiv.innerHTML = cleanHtml;

        // 3. Render Math (KaTeX)
        renderMathInElement(previewDiv, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false
        });
    }

    // 打开笔记模态框
    // encodedNotes 需要解码
    window.openNoteModal = function(solvedProblemId, encodedNotes) {
        currentEditingId = solvedProblemId;
        const modal = document.getElementById('noteModal');
        const editor = document.getElementById('noteEditor');

        // 解码内容 (Base64 or URL decode might be safer, but here we assume simple string passing)
        // 注意：HTML 属性中传参已经被转义，这里可以直接用
        // 为了安全起见，我们也可以选择从 data 属性读取，或者这里直接用 decodeURIComponent 如果之前 encode 了
        const notes = encodedNotes ? decodeURIComponent(encodedNotes) : "";

        editor.value = notes;
        renderPreview(notes);

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // 禁止背景滚动
    }

    window.closeNoteModal = function() {
        const modal = document.getElementById('noteModal');
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // 恢复背景滚动
        currentEditingId = null;
    }

    window.saveNotes = function() {
        if (!currentEditingId) return;

        const editor = document.getElementById('noteEditor');
        const content = editor.value;
        const btn = document.getElementById('saveNoteBtn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

        axios.post('/api/user/problems/update-notes', {
            id: currentEditingId,
            notes: content
        }).then(res => {
            if (res.data.code === 200) {
                showToast('笔记保存成功', 'success');
                closeNoteModal();
                loadData(); // 刷新列表以更新图标状态
            } else {
                showToast(res.data.msg || '保存失败', 'error');
            }
        }).catch(err => {
            showToast('网络错误，保存失败', 'error');
            console.error(err);
        }).finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }


    // --- 列表业务逻辑 ---

    function changeRange(range) {
        $('.filter-btn').removeClass('bg-white text-primary shadow-sm').addClass('text-slate-500 hover:text-dark');
        $(`.filter-btn[data-range="${range}"]`).removeClass('text-slate-500 hover:text-dark').addClass('bg-white text-primary shadow-sm');

        currentState.range = range;
        currentState.page = 1;
        loadData();
    }

    function changePage(page) {
        if (page < 1 || currentState.loading) return;
        currentState.page = page;
        loadData();
    }

    function handleSearchDebounced() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentState.page = 1;
            loadData();
        }, 500);
    }

    function loadData() {
        currentState.loading = true;
        const container = $('#timeline-container');
        const pagination = $('#paginationContainer');

        container.html(`
            <div class="text-center py-16 text-graytext">
                <div class="flex flex-col items-center gap-3">
                    <i class="fas fa-spinner fa-spin text-2xl text-primary/50"></i>
                    <span>加载记录中...</span>
                </div>
            </div>
        `);
        pagination.hide();

        const keyword = $('#searchInput').val().trim();

        $.get(`/api/user/submissions/timeline`, {
            platform: 'CF',
            range: currentState.range,
            page: currentState.page,
            size: currentState.size,
            keyword: keyword
        }, function(res) {
            currentState.loading = false;
            if (res.code === 200) {
                const pageData = res.data;
                renderTimeline(pageData.records);
                renderPagination(pageData.total, pageData.pages, pageData.current);
                pagination.css('display', 'flex');
            } else {
                container.html(`<div class="text-center py-16 text-red-500">${res.msg}</div>`);
                showToast(res.msg, 'error');
            }
        }).fail(function() {
            currentState.loading = false;
            container.html('<div class="text-center py-16 text-red-500">网络请求失败</div>');
            showToast("无法连接到服务器", 'error');
        });
    }

    function refreshData() {
        const btn = $(event.target).closest('button');

        Swal.fire({
            title: '确认同步数据？',
            text: "同步数据可能需要较长时间，确定立即执行吗？",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#4e54c8',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: '确定同步',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> <span class="hidden sm:inline">同步中...</span>');

                $.post('/api/user/submissions/refresh?count=100', function(res) {
                    if(res.code === 200) {
                        Swal.fire({
                            icon: 'success',
                            title: '同步完成',
                            text: `新增: ${res.data.inserted} 条`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                        currentState.page = 1;
                        loadData();
                    } else {
                        Swal.fire('同步失败', res.msg || "未知错误", 'error');
                    }
                }).fail(function() {
                    Swal.fire('错误', '网络请求失败', 'error');
                }).always(function() {
                    btn.prop('disabled', false).html(originalHtml);
                });
            }
        });
    }

    /**
     * 打开标签编辑弹窗
     */
    function openTagModal(solvedProblemId, currentTags) {
        const safeValue = currentTags || "";

        Swal.fire({
            title: '管理题目标签',
            input: 'text',
            inputLabel: '请输入标签，多个标签请用逗号或空格分隔',
            inputPlaceholder: '例如: dp, 贪心, math',
            inputValue: safeValue,
            showCancelButton: true,
            confirmButtonText: '保存标签',
            cancelButtonText: '取消',
            confirmButtonColor: '#4e54c8',
            cancelButtonColor: '#94a3b8',
            showLoaderOnConfirm: true,
            preConfirm: (tagsStr) => {
                const tags = tagsStr.split(/[,\s，]+/).filter(t => t.trim().length > 0);
                return axios.post('/api/user/problems/update-tags', {
                    id: solvedProblemId,
                    tags: tags
                }).then(response => {
                    if (response.data.code !== 200) {
                        throw new Error(response.data.msg || '更新失败');
                    }
                    return response.data;
                }).catch(error => {
                    Swal.showValidationMessage(`请求失败: ${error.message || error}`)
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                showToast('标签更新成功', 'success');
                loadData();
            }
        });
    }

    function renderTimeline(list) {
        const container = $('#timeline-container');
        container.empty();

        if (!list || list.length === 0) {
            let emptyText = "暂无提交记录";
            if (currentState.range === 'TODAY') emptyText = "今日暂无提交记录，请点击右上角“同步”按钮获取最新数据";
            else if (currentState.range === 'WEEK') emptyText = "本周暂无提交记录";
            else if (currentState.range === 'MONTH') emptyText = "本月暂无提交记录";
            else emptyText = "未找到符合条件的提交记录";

            container.html(`
                <div class="flex flex-col items-center justify-center py-16 bg-white rounded-2xl border border-dashed border-slate-200">
                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300">
                        <i class="fas fa-inbox text-2xl"></i>
                    </div>
                    <p class="text-slate-500 font-medium">${emptyText}</p>
                </div>
            `);
            return;
        }

        list.forEach(item => {
            // 状态逻辑
            let verdictShort = item.verdict;
            let verdictClass = 'bg-slate-100 text-slate-500 border-slate-200';
            let iconClass = 'bg-slate-200 text-slate-500';
            let icon = '<i class="fas fa-question"></i>';

            if (item.verdict === 'OK') {
                verdictShort = 'AC';
                verdictClass = 'bg-emerald-50 text-emerald-600 border-emerald-100';
                iconClass = 'bg-emerald-500 text-white shadow-lg shadow-emerald-200';
                icon = '<i class="fas fa-check"></i>';
            } else if (item.verdict === 'WRONG_ANSWER') {
                verdictShort = 'WA';
                verdictClass = 'bg-red-50 text-red-600 border-red-100';
                iconClass = 'bg-red-500 text-white shadow-lg shadow-red-200';
                icon = '<i class="fas fa-times"></i>';
            } else if (item.verdict === 'TIME_LIMIT_EXCEEDED') {
                verdictShort = 'TLE';
                verdictClass = 'bg-amber-50 text-amber-600 border-amber-100';
                iconClass = 'bg-amber-500 text-white shadow-lg shadow-amber-200';
                icon = '<i class="fas fa-clock"></i>';
            } else if (item.verdict === 'MEMORY_LIMIT_EXCEEDED') {
                verdictShort = 'MLE';
                verdictClass = 'bg-blue-50 text-blue-600 border-blue-100';
                iconClass = 'bg-blue-500 text-white shadow-lg shadow-blue-200';
                icon = '<i class="fas fa-memory"></i>';
            } else if (item.verdict === 'RUNTIME_ERROR') {
                verdictShort = 'RE';
                verdictClass = 'bg-purple-50 text-purple-600 border-purple-100';
                iconClass = 'bg-purple-500 text-white shadow-lg shadow-purple-200';
                icon = '<i class="fas fa-bomb"></i>';
            } else if (item.verdict === 'COMPILATION_ERROR') {
                verdictShort = 'CE';
                verdictClass = 'bg-slate-100 text-slate-600 border-slate-200';
                iconClass = 'bg-slate-500 text-white shadow-lg shadow-slate-200';
                icon = '<i class="fas fa-code"></i>';
            } else if (item.verdict === 'CHALLENGED') {
                verdictShort = 'HACKED';
                verdictClass = 'bg-orange-50 text-orange-600 border-orange-100';
                iconClass = 'bg-orange-500 text-white shadow-lg shadow-orange-200';
                icon = '<i class="fas fa-user-secret"></i>';
            }

            // Rating 显示
            let ratingHtml = '';
            if (item.rating) {
                let rClass = getRatingColorClass(item.rating);
                ratingHtml = `<span class="${rClass} text-xs font-bold border border-current px-1.5 rounded bg-opacity-10 opacity-80" title="难度: ${item.rating}">*${item.rating}</span>`;
            }

            // --- 标签处理逻辑 (Start) ---
            let tagsSection = '';
            const tagList = item.tags ? item.tags.split(',') : [];
            let tagsHtml = '';

            if (tagList.length > 0) {
                tagList.forEach(tag => {
                    if(tag.trim()) {
                        tagsHtml += `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] md:text-xs font-medium bg-slate-100 text-slate-600 mr-1.5 border border-slate-200 hover:bg-slate-200 transition-colors cursor-default">${tag.trim()}</span>`;
                    }
                });
            }

            // --- 操作按钮区域 (标签 + 笔记) ---
            let actionButtons = '';

            if (item.solvedProblemId) {
                // 标签编辑按钮
                const safeTags = item.tags ? item.tags.replace(/'/g, "\\'") : "";
                const tagBtnClass = tagList.length > 0
                    ? "text-slate-300 hover:text-primary transition-colors text-xs p-1"
                    : "text-primary/70 hover:text-primary transition-colors text-xs flex items-center border border-dashed border-primary/30 px-2 py-0.5 rounded hover:bg-primary/5";
                const tagBtnText = tagList.length > 0 ? '' : '<span class="text-xs ml-1">添加标签</span>';

                const tagButton = `<button onclick="openTagModal(${item.solvedProblemId}, '${safeTags}')" class="${tagBtnClass} mr-2" title="编辑标签"><i class="fas fa-tag"></i> ${tagBtnText}</button>`;

                // 笔记编辑按钮
                const hasNotes = item.notes && item.notes.trim().length > 0;
                // 对笔记内容进行 URL 编码以便安全传入 JS 函数
                const encodedNotes = encodeURIComponent(item.notes || "");

                let noteBtnClass = "";
                let noteIcon = "";

                if (hasNotes) {
                    noteBtnClass = "text-amber-500 hover:text-amber-600 transition-colors text-xs p-1";
                    noteIcon = '<i class="fas fa-sticky-note"></i>'; // 实心图标表示有内容
                } else {
                    noteBtnClass = "text-slate-300 hover:text-amber-500 transition-colors text-xs p-1";
                    noteIcon = '<i class="far fa-sticky-note"></i>'; // 空心图标表示无内容
                }

                const noteButton = `<button onclick="openNoteModal(${item.solvedProblemId}, '${encodedNotes}')" class="${noteBtnClass}" title="编辑笔记">${noteIcon}</button>`;

                actionButtons = tagButton + noteButton;
            }

            if (tagsHtml || actionButtons) {
                tagsSection = `<div class="mt-2 flex flex-wrap items-center justify-between">
                    <div class="flex flex-wrap items-center">${tagsHtml}</div>
                    <div class="flex items-center ml-auto">${actionButtons}</div>
                </div>`;
            }
            // --- 标签处理逻辑 (End) ---

            // 格式化时间
            const timeObj = new Date(item.submitTime);
            const dateStr = timeObj.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            const timeStr = timeObj.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });

            // 生成 HTML
            const html = `
                <div class="relative pl-8 md:pl-0 flex group">
                    <!-- 左侧时间 -->
            <div class="hidden md:flex flex-col items-end pr-8 w-24 pt-3 shrink-0 text-right">
            <span class="text-sm font-bold text-dark font-mono">${timeStr}</span>
            <span class="text-xs text-graytext font-medium">${dateStr}</span>
            </div>

                <!-- 中间轴线 -->
            <div class="absolute left-0 md:left-24 top-0 bottom-0 w-px bg-slate-200 group-last:bottom-auto group-last:h-6 md:ml-[15px] ml-[15px]"></div>

                <!-- 节点图标 -->
            <div class="absolute left-0 md:left-24 top-3 w-8 h-8 rounded-full flex items-center justify-center text-xs z-10 ${iconClass}">
            ${icon}
            </div>

                <!-- 右侧卡片 -->
            <div class="ml-6 md:ml-12 flex-1 bg-white rounded-xl border border-slate-100 shadow-sm p-4 transition-all duration-300 hover:shadow-md hover:-translate-y-1 hover:border-indigo-100">
            <div class="flex justify-between items-start mb-1">
            <div class="flex items-center gap-2 flex-wrap">
            <span class="bg-slate-100 text-slate-600 text-xs font-mono px-2 py-0.5 rounded border border-slate-200">
            ${item.contestId}${item.problemIndex}
            </span>
            <a href="${item.problemUrl}" target="_blank" class="text-sm font-bold text-dark hover:text-primary transition-colors line-clamp-1 break-all">
            ${item.problemName}
            </a>
            ${ratingHtml}
            </div>
            <span class="text-[10px] font-bold px-2 py-1 rounded-full border uppercase tracking-wider whitespace-nowrap ml-2 ${verdictClass}">
            ${verdictShort}
            </span>
            </div>

                <!-- 标签和笔记行 -->
            ${tagsSection}

            <div class="flex justify-between items-end border-t border-slate-50 pt-2 mt-2">
            <div class="flex items-center gap-3 text-xs text-graytext">
            <span class="md:hidden flex items-center gap-1">
            <i class="far fa-clock"></i> ${dateStr} ${timeStr}
            </span>
            <a href="https://codeforces.com/contest/${item.contestId}/submission/${item.submissionId}" target="_blank" class="flex items-center gap-1 hover:text-primary transition-colors">
            <span>#${item.submissionId}</span>
            <i class="fas fa-external-link-alt text-[10px]"></i>
            </a>
            </div>
            </div>
            </div>
            </div>
            `;
            container.append(html);
        });
    }

    function getRatingColorClass(rating) {
        if (!rating) return '';
        if (rating < 1200) return 'text-slate-400';
        if (rating < 1400) return 'text-green-600';
        if (rating < 1600) return 'text-cyan-600';
        if (rating < 1900) return 'text-blue-600';
        if (rating < 2100) return 'text-purple-600';
        if (rating < 2400) return 'text-orange-500';
        return 'text-red-600';
    }

    function renderPagination(total, totalPages, current) {
        const info = $('#pageInfo');
        const container = $('#pagination');

        const startRecord = (current - 1) * currentState.size + 1;
        const endRecord = Math.min(current * currentState.size, total);

        info.text(`显示 ${startRecord}-${endRecord} 条 / 共 ${total} 条`);
        container.empty();

        if (totalPages <= 1) return;

        const btnClass = "w-8 h-8 flex items-center justify-center rounded-lg border text-xs font-medium transition-all";
        const activeClass = "bg-primary border-primary text-white shadow-md shadow-primary/30";
        const normalClass = "bg-white border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-primary";
        const disabledClass = "bg-slate-50 border-slate-200 text-slate-300 cursor-not-allowed";

        container.append(`<button class="${btnClass} ${current === 1 ? disabledClass : normalClass}" ${current === 1 ? 'disabled' : ''} onclick="changePage(${current - 1})"><i class="fas fa-chevron-left"></i></button>`);

        const renderBtn = (i) => `<button class="${btnClass} ${i === current ? activeClass : normalClass}" onclick="changePage(${i})">${i}</button>`;
        const renderDots = () => `<span class="w-8 h-8 flex items-center justify-center text-slate-300 text-xs">...</span>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) container.append(renderBtn(i));
        } else {
            container.append(renderBtn(1));
            if (current > 3) container.append(renderDots());

            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) container.append(renderBtn(i));

            if (current < totalPages - 2) container.append(renderDots());
            container.append(renderBtn(totalPages));
        }

        container.append(`<button class="${btnClass} ${current === totalPages ? disabledClass : normalClass}" ${current === totalPages ? 'disabled' : ''} onclick="changePage(${current + 1})"><i class="fas fa-chevron-right"></i></button>`);
    }
</script>

</body>
</html>