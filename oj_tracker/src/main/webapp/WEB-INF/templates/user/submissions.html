<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提交记录</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --text-light: #7f8c8d;
            --text-dark: #34495e;
            --border-color: #e2e8f0;
            --bg-color: #f1f5f9;
        }

        body {
            background-color: var(--bg-color);
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* 时间轴样式 */
        .timeline { position: relative; padding: 10px 0; }
        .timeline-item { position: relative; padding-left: 40px; margin-bottom: 15px; }
        .timeline-item::before { content: ''; position: absolute; left: 15px; top: 0; bottom: -15px; width: 2px; background-color: #e9ecef; }
        .timeline-item:last-child::before { display: none; }
        .timeline-icon { position: absolute; left: 0; top: 0; width: 32px; height: 32px; border-radius: 50%; text-align: center; line-height: 32px; color: #fff; font-size: 14px; z-index: 1; }
        .timeline-content { background: #fff; border: 1px solid #e9ecef; border-radius: 4px; padding: 12px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .timeline-content:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .verdict-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; font-weight: 600; min-width: 40px; display: inline-block; text-align: center; }

        .toolbar-container {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        /* === 分页样式 === */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #fff;
            border-top: 1px solid #f0f0f0;
        }

        .pagination-info { font-size: 13px; color: var(--text-light); }

        .page-btn {
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-dark);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            text-decoration: none;
        }

        .page-btn:hover:not(:disabled) { border-color: var(--primary-color); color: var(--primary-color); }
        .page-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .page-btn:disabled { background-color: #f5f5f5; color: #ccc; cursor: not-allowed; }

        .search-input-group input:focus { box-shadow: none; border-color: var(--primary-color); }

        /* === [新增] Rating 颜色样式 (Codeforces 风格) === */
        .rating-gray { color: #808080; font-weight: bold; }
        .rating-green { color: #008000; font-weight: bold; }
        .rating-cyan { color: #03a89e; font-weight: bold; }
        .rating-blue { color: #0000ff; font-weight: bold; }
        .rating-violet { color: #a0a; font-weight: bold; }
        .rating-orange { color: #ff8c00; font-weight: bold; }
        .rating-red { color: #ff0000; font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid">
    <!-- 顶部操作栏 -->
    <div class="toolbar-container d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary filter-btn active" data-range="TODAY" onclick="changeRange('TODAY')">今日</button>
            <button type="button" class="btn btn-outline-secondary filter-btn" data-range="WEEK" onclick="changeRange('WEEK')">本周</button>
            <button type="button" class="btn btn-outline-secondary filter-btn" data-range="MONTH" onclick="changeRange('MONTH')">本月</button>
            <button type="button" class="btn btn-outline-secondary filter-btn" data-range="ALL" onclick="changeRange('ALL')">全部</button>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <div class="input-group search-input-group" style="width: 250px;">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0" placeholder="搜索题目..." onkeyup="handleSearchDebounced()">
            </div>
            <button type="button" class="btn btn-primary" onclick="refreshData()" style="background-color: var(--primary-color); border-color: var(--primary-color);">
                <i class="fas fa-sync-alt"></i> 同步
            </button>
        </div>
    </div>

    <!-- 内容区域 -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-0">
            <div id="timeline-container" class="timeline p-4">
                <!-- JS 动态填充 -->
            </div>
        </div>
        <!-- 分页容器 -->
        <div class="pagination-container" id="paginationContainer" style="display:none;">
            <div class="pagination-info" id="pageInfo"></div>
            <div id="pagination" style="display:flex;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 全局状态
    let currentState = {
        range: 'TODAY',
        page: 1,
        size: 20,
        loading: false
    };

    let searchTimeout;

    $(document).ready(function() {
        loadData();
    });

    // --- 工具函数 ---

    function showToast(message, type = 'info') {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        Toast.fire({ icon: type, title: message });
    }

    // --- 业务逻辑 ---

    function changeRange(range) {
        $('.filter-btn').removeClass('active btn-secondary').addClass('btn-outline-secondary');
        $(`.filter-btn[data-range="${range}"]`).removeClass('btn-outline-secondary').addClass('active btn-secondary');

        currentState.range = range;
        currentState.page = 1;
        loadData();
    }

    function changePage(page) {
        if (page < 1 || currentState.loading) return;
        currentState.page = page;
        loadData();
    }

    function handleSearchDebounced() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentState.page = 1;
            loadData();
        }, 500);
    }

    function loadData() {
        currentState.loading = true;
        const container = $('#timeline-container');
        const pagination = $('#paginationContainer');

        container.html('<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">加载中...</p></div>');
        pagination.hide();

        const keyword = $('#searchInput').val().trim();

        $.get(`/api/user/submissions/timeline`, {
            platform: 'CF',
            range: currentState.range,
            page: currentState.page,
            size: currentState.size,
            keyword: keyword
        }, function(res) {
            currentState.loading = false;
            if (res.code === 200) {
                const pageData = res.data;
                renderTimeline(pageData.records);
                renderPagination(pageData.total, pageData.pages, pageData.current);
                pagination.show();
            } else {
                container.html(`<div class="text-center py-5 text-danger">${res.msg}</div>`);
                showToast(res.msg, 'error');
            }
        }).fail(function() {
            currentState.loading = false;
            container.html('<div class="text-center py-5 text-danger">网络请求失败</div>');
            showToast("无法连接到服务器", 'error');
        });
    }

    function refreshData() {
        const btn = $(event.target).closest('button');

        Swal.fire({
            title: '确认同步数据？',
            text: "同步数据可能需要较长时间，确定立即执行吗？",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#4e54c8',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: '确定同步',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 同步中...');

                $.post('/api/user/submissions/refresh?count=100', function(res) {
                    if(res.code === 200) {
                        Swal.fire({
                            icon: 'success',
                            title: '同步完成',
                            text: `新增: ${res.data.inserted} 条`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                        currentState.page = 1;
                        loadData();
                    } else {
                        Swal.fire('同步失败', res.msg || "未知错误", 'error');
                    }
                }).fail(function() {
                    Swal.fire('错误', '网络请求失败', 'error');
                }).always(function() {
                    btn.prop('disabled', false).html(originalHtml);
                });
            }
        });
    }

    // 重点修改：状态映射逻辑
    function renderTimeline(list) {
        const container = $('#timeline-container');
        container.empty();

        if (!list || list.length === 0) {
            let emptyText = "暂无提交记录";
            if (currentState.range === 'TODAY') {
                emptyText = "今日暂无提交记录，请点击右上角“同步”按钮获取最新数据";
            } else if (currentState.range === 'WEEK') {
                emptyText = "本周暂无提交记录";
            } else if (currentState.range === 'MONTH') {
                emptyText = "本月暂无提交记录";
            } else {
                emptyText = "未找到符合条件的提交记录";
            }

            container.html(`
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3 opacity-25"></i>
                    <p class="text-muted">${emptyText}</p>
                </div>
            `);
            return;
        }

        list.forEach(item => {
            // 默认值
            let verdictShort = item.verdict;
            let verdictColor = 'bg-secondary';
            let icon = '<i class="fas fa-question"></i>';

            // 映射 Codeforces Verdict 到标准 OJ 术语
            // 注意：API 返回的通常是大写带下划线的字符串
            if (item.verdict === 'OK') {
                verdictShort = 'AC';
                verdictColor = 'bg-success';
                icon = '<i class="fas fa-check"></i>';
            } else if (item.verdict === 'WRONG_ANSWER') {
                verdictShort = 'WA';
                verdictColor = 'bg-danger';
                icon = '<i class="fas fa-times"></i>';
            } else if (item.verdict === 'TIME_LIMIT_EXCEEDED') {
                verdictShort = 'TLE';
                verdictColor = 'bg-warning text-dark'; // TLE 通常用黄色/橙色
                icon = '<i class="fas fa-clock"></i>';
            } else if (item.verdict === 'MEMORY_LIMIT_EXCEEDED') {
                verdictShort = 'MLE';
                verdictColor = 'bg-info text-dark'; // MLE 通常用青色或深蓝
                icon = '<i class="fas fa-memory"></i>';
            } else if (item.verdict === 'RUNTIME_ERROR') {
                verdictShort = 'RE';
                verdictColor = 'bg-dark'; // RE 用深色或紫色
                icon = '<i class="fas fa-bomb"></i>';
            } else if (item.verdict === 'COMPILATION_ERROR') {
                verdictShort = 'CE';
                verdictColor = 'bg-secondary';
                icon = '<i class="fas fa-code"></i>';
            } else if (item.verdict === 'CHALLENGED') {
                verdictShort = 'HACKED';
                verdictColor = 'bg-danger';
                icon = '<i class="fas fa-user-secret"></i>';
            }

            // [新增] 处理 Rating 显示
            let ratingHtml = '';
            if (item.rating) {
                let rClass = getRatingColorClass(item.rating);
                // 显示为 *1300 样式
                ratingHtml = `<span class="${rClass} ms-2 small" title="难度: ${item.rating}" style="font-size: 0.9em; vertical-align: middle;">*${item.rating}</span>`;
            }

            const html = `
                <div class="timeline-item">
                    <div class="timeline-icon ${verdictColor}">
                        ${icon}
                    </div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 text-truncate" style="max-width: 70%;">
                                <a href="${item.problemUrl}" target="_blank" class="text-decoration-none fw-bold text-dark">
                                    <span class="badge bg-light text-dark border me-1 font-monospace">${item.contestId}${item.problemIndex}</span>
                                    ${item.problemName}
                                </a>
                                ${ratingHtml}
                            </h6>
                            <span class="badge ${verdictColor} verdict-badge">${verdictShort}</span>
                        </div>
                        <div class="timeline-time d-flex justify-content-between mt-2 align-items-center">
                            <span class="text-muted small">
                                <i class="far fa-clock me-1"></i>${formatTime(item.submitTime)}
                            </span>
                            <a href="https://codeforces.com/contest/${item.contestId}/submission/${item.submissionId}"
                               target="_blank" class="btn btn-sm btn-light border py-0 px-2 text-muted" style="font-size: 12px;">
                               #${item.submissionId} <i class="fas fa-external-link-alt ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            container.append(html);
        });
    }

    // [新增] Rating 颜色判断函数
    function getRatingColorClass(rating) {
        if (!rating) return '';
        if (rating < 1200) return 'rating-gray';
        if (rating < 1400) return 'rating-green';
        if (rating < 1600) return 'rating-cyan';
        if (rating < 1900) return 'rating-blue';
        if (rating < 2100) return 'rating-violet';
        if (rating < 2400) return 'rating-orange';
        return 'rating-red';
    }

    function renderPagination(total, totalPages, current) {
        const info = $('#pageInfo');
        const container = $('#pagination');

        const startRecord = (current - 1) * currentState.size + 1;
        const endRecord = Math.min(current * currentState.size, total);

        info.text(`第 ${startRecord}-${endRecord} 条 / 共 ${total} 条`);
        container.empty();

        if (totalPages <= 1) return;

        // 上一页
        container.append(`<button class="page-btn" ${current === 1 ? 'disabled' : ''} onclick="changePage(${current - 1})"><i class="fas fa-chevron-left"></i></button>`);

        // 页码逻辑
        const renderBtn = (i) => `<button class="page-btn ${i === current ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
        const renderDots = () => `<span style="line-height:28px; padding:0 5px; color:#ccc;">...</span>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) container.append(renderBtn(i));
        } else {
            container.append(renderBtn(1));
            if (current > 3) container.append(renderDots());

            let start = Math.max(2, current - 1);
            let end = Math.min(totalPages - 1, current + 1);
            for (let i = start; i <= end; i++) container.append(renderBtn(i));

            if (current < totalPages - 2) container.append(renderDots());
            container.append(renderBtn(totalPages));
        }

        // 下一页
        container.append(`<button class="page-btn" ${current === totalPages ? 'disabled' : ''} onclick="changePage(${current + 1})"><i class="fas fa-chevron-right"></i></button>`);
    }

    function formatTime(isoStr) {
        if (!isoStr) return '';
        const date = new Date(isoStr);
        return date.toLocaleString('zh-CN', { hour12: false });
    }
</script>

</body>
</html>